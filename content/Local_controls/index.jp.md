---
title: Local controls jp
contributors:
  - Yz2house
---

<div class="pagetitle">

ローカル編集

</div>

## イントロダクション

　画像の一部分を編集する機能です。RawTherapeeのローカル編集（部分的な編集）はRT-スポットと呼ぶユニットをベースに行います。原理は元々Nikon
Capture NX2©で使われていたU-Pointのコンセプトに似たもので、その後Nik
Collection© DxO PhotoLab©、Caputure
NXD©でも使われています。RT-スポットは、この手法を元にJacques
DesmisがRawTherapee専用のアルゴリズムとして開発したものです。  
　RawTherapeeの手法は、GIMPやPhotoshop©などで広く知られているローカル編集のアプリケーションの手法とは全く異なります。これらアプリケーションは、基本的にブラシやレイヤー、ブレンドマスクに関連したlassoやmagic
wandsなどのツールを使いますが、通常、編集に時間がかかり、複雑な形状の部分的な画像には使いづらいことがあります。  
　RT-スポットは楕円形或いは長方形の境界フレームと、その中に含まれる直径の大きさが変えられる中心円で構成されています。境界フレームは4つのコントロールポイントを持ち、各ポイントを独立して動かすことも、或いは、シンメトリカルに動かすことも出来ます。長方形のフレームは画像全体を編集対象にして使うことも出来ます。RT-スポットで画像全体モードを選ぶと、コントロールポイントは自動で画像の外側に配置されます。中心円の位置はユーザーが目標に応じて手動で移動します。更に洗練されたフレーム設定を取り入れる予定です。

<div align="center">

<File:ellipse.jpg%7C楕円形> <File:rectangle.jpg%7C長方形>

</div>

　RT-スポットのアルゴリズムは、ΔE（色差：与えられた2つの色の視覚的な知覚の差）をベースにした形状検出を使い、楕円形、或いは長方形の境界線で囲まれた画像の中で、編集する領域を特定します。形状検出アルゴリズムに使われる基準値は、RT-スポットの中心円の輝度、色度、色相の平均値です。つまり、RT-スポット（タイプが通常、除外、画像全体のいずれでも）の中心円の位置次第で、その基準値、及び、形状検出の作用は変化します。

　この特定操作を細かくコントロールすることで、より精密にRT-スポットの中の編集領域を特定することが出来ます。マスクを追加的に使えば、更に細かい特定が可能ですが、ローカル編集に必要な大部分は形状検出のアルゴリズムだけで十分です。また、RT-スポットは、画像の特定部分だけ作用を除外するようにも使うことが出来ます。

　利用できる編集機能は広範囲に及んでいて、画像を全体的に調整するメインの機能の殆どを備えています。もちろん、このローカル編集だけに備わった機能も幾つかあります。

　注意：メインの⟨設定⟩パネルの"特有の設定"の中の"色ずれの回避"のオプションはデフォルトで有効になっています。この場合、以下の処理はRT-スポットが有効、無効になる前に実行されます。

- 　色情報が色域内に収まるよう、相対的な測色の補正を行う。
- 　色情報の線形性、色相のずれを回避するために、LUT（ルックアップテーブル）を使ってマンセル補正を行う。

### 各機能の説明

　以下、各モジュールに収められている機能を説明します（機能名の最後についている数字は、その機能ががローカル編集の処理工程の中で何番目に位置しているのかを表しています、例：色と明るさは11番目）。また、各モジュールには機能の水準（基本、標準、高度）を変えるトグルが付いています。デフォルトで表示する水準は⟨環境設定⟩で変更できます。

#### 色と明るさ - 11

　
　色、明るさ、コントラストが調整出来ます。また、赤目やセンサーに付着したゴミなどの影響による欠陥部分を補正することも出来ます。その他、階調フィルタ、トーンカーブ（L\*a\*b\*）、ファイルの融合、マスク機能が備わっています。

#### シャドウ/ハイライトとトーンイコライザ - 6

　シャドウとハイライトのスライダー、トーンイコライザ、或いはトーンリプロダクションカーブ（TRC）を使ってシャドウとハイライトを調整する機能です。露光補正モジュールの代わりに、或いは併用して使うことが出来ます。階調フィルタとして使うことも出来るでしょう。

#### 自然な彩度とウォーム/クール - 5

　自然な彩度を調整する機能で、基本的なアルゴリズムはメインのカラータブにある“自然な彩度”と同じです。色の見えモデルのアルゴリズムを使って、ホワイトバランスと同等の調整を行います。

#### 対数符号化 - 0

　対数符号化のアルゴリズムを使って、露出不足やハイダイナミックレンジの画像を調整します。

#### ダイナミックレンジ＆露光補正 - 10

　ΔEを考慮するためにラプラシアンPDEアルゴリズムを使ってL\*a\*b\*色空間で露光補正を行い、アーティファクトの発生を抑制します。ラプラス作用素は微細な詳細を検知することに優れています。しかし、利用にあたって、複雑なこの原理を理解する必要はありません。

#### 共通のカラーマスク - 12

　マスクは他のモジュールにも備わっていますが、それらはそのモジュールの機能を補完するために使います。このモジュールのマスクはそれ自体が調整機能です。スコープ機能の様に、画像の表情（色、明るさ、コントラスト）や質感を変えるために使われます。

#### ソフトライトと独自のレティネックス - 7

　前者はメインのカラータブにあるソフトライトと全く同じ効果をもたらします。後者はレティネックスのアルゴリズムを使って、覆い焼きや焼き込みを行います。

#### ぼかし/質感とノイズ除去 - 1

　背景をぼかす、肌の印象を和らげる、画像をフィルム調に仕上げる、ノイズを除去する目的で使います。

#### トーンマッピング - 2

　メインの露光補正タブにあるトーンマッピングと同じです。但し、ローカル編集のトーンマッピングはメインのそれと併用は出来ません（メインのトーンマッピングは無効にする必要があります）。

#### 霞除去とレティネックス - 3

　霞除去とレティネック（レティネックスは機能モードが“高度”の場合のみ利用可能）の機能です。霞除去や高いコントラス値のローカルコントラスト調整、"明瞭"に似た効果を得るのに便利です。

#### シャープニング - 9

　シャープネスの改善にRLデコンボリューションを適用します。調整が見極められるように、画像を100％に拡大します。

#### ローカルコントラストとウェーブレット - 8

- 　⟨ローカルコントラスト⟩：基本的にメインのディテールタブにある⟨ローカルコントラスト⟩と同じ働きです。
- 　⟨ウェーブレット⟩：メインの"高度な機能"タブにある⟨ウェーブレットのレベル⟩に備わっている機能（明瞭、コントラスト、ぼかしなど）、及び機能水準が"高度"の場合の機能（ガイド付きフィルタ、トーンマッピングなど）と同等です。大きな汚れや欠損などの補正に使うことも出来ます。

#### 詳細レベルによるコントラスト調整 - 4

　センサーやレンズに付着したゴミに起因した跡などを補正するのに使います。

#### 色の見え（CAM16&JzCzHz）-12

　このモジュールは高度な機能のタブの中にある⟨色の見え＆明るさ（CIECAM02/16）⟩を、ローカル編集特有の条件に合わせて単純化したものです。また、画像の最大輝度を計算に入れて、ハイダイナミックレンジ画像の処理を改善するための試験的機能である⟨JzCzHz⟩を含んでいます（使用にあたってはモジュールの機能水準を高度にする必要があります）。

## 初めに

　以下のセクションで挙げられている実例は、このローカル編集に使われる様々な機能の使い方の幾つかを紹介したものです。しかし、自分でこの機能の可能性を探りたいのであれば、まず、⟨環境設定⟩パネルを開き、一般タブで上から3番目にあるローカル編集の水準を"基本"に設定します（このモードにはマスク機能、及びカーブ機能の殆どが含まれません）。次にローカル編集タブの先頭にある"全ての設定項目を表示"のオプションを無効にします。これでローカル編集機能の表示が最もシンプルな形になります、それでも様々な調整が出来ることが実感できるでしょう。

　⟨色と明るさ⟩、⟨シャドウ/ハイライト＆トーンイコライザ⟩、⟨自然な彩度＆ウォーム/クール⟩の機能で何が出来るかしることから始めるのがいいでしょう。基本を学んだ後は、それら機能の水準を手動で"標準"に上げて、追加された機能を試して下さい。

　⟨色と明るさ⟩は非常に強力な機能で、メインの露光補正タブの⟨L\*a\*b\*調整⟩と、カラータブの⟨カラートーン調整⟩の中のカラー補正グリッド、両方の能力を備えています。

### 最初のステップ

#### ローカル編集機能を有効にする

- 　画面右上の一連のタブから"手の形"のアイコンが表示されている⟨ローカル編集⟩タブを選びます。
- 　機能がまだ有効になっていない場合はローカル編集と表示されたタイトルをクリックし、機能パネルを拡張します。
- 　⟨追加/作成⟩をクリックします。

<div>

<figure>
<img src="/images/Startspot.jpg" title="Startspot.jpg" width="600" />
<figcaption>Startspot.jpg</figcaption>
</figure>

</ul>
</div>

#### RT-スポット　4つのタイプ

[RT-スポット　4つのタイプ](local_controls/jp#rt-スポット_4つのタイプ)

#### 準備

　RT-スポットを目的に応じて配置します。花の色以外に影響を与えずに、花の色の色度を増やし、輝度（明度）を下げることを目的にした手順を例にして説明します。

- 　RT-スポットの中心円（編集のための基準値となる部分）を、調整目的を代表している個所に移動します。本例で言えば、色度と明度を変えたい花のレッドの部分です。
- 　4つの境界線を使って、花の周辺を大きく囲むようにRT-スポットを広げます。マウスをコントロールポイント（4つ）に合わせウスを押したままポイントを左右上下に移動して、RT-スポットの大きさ（編集領域）を調整します。
- プレビュー画像のツールバーにある⟨ロック式カラーピッカー⟩を使って、花びらのレッド、空のブルー、葉のグリーンの
  3カ所のL\*a\*b\*情報を表示させます。Shiftキーを押しながら表示されたカラーピッカーを左クリックすると色情報の種類が、RGB、L\*a\*b\*、HVSの順に変わります。
- 　これら3点のL\* a\*ｂ\*情報は以下の様になっています:
  - 　花びらのレッド: L=48.6 a=74.4 b=47.0
  - 　空のブルー: L=68.6 a=-3.1 b=-16.6
  - 　葉のグリーン: L=48.3 a=-28.3 b=51.4

<figure>
<img src="/images/prepare1.jpg" title="prepare1.jpg" width="600" />
<figcaption>prepare1.jpg</figcaption>
</figure>

Rawファイルへのリンク(Jacques Desmis - Creative Commons
Attribution-Share Alike 4.0):
[1](https://drive.google.com/file/d/1X2g73FqzQl7-WRfzhF7zHa7XWwnKcwtx/view?usp=sharing)

</ul>
</div>

#### 色と明るさの機能を追加

　⟨設定⟩パネルの最下段にある、"現在のスポットに機能を追加"というコンボボックスから、現在のRT-スポットで使う機能を指定します。

- 　一覧の中には、⟨色と明るさ⟩、⟨シャドウ/ハイライト⟩と⟨トーンイコライザ⟩、などの機能があります。各RT-スポットで、1つ或いは複数の機能を使うことが出来ます。機能名の後に付いている数字は、イントロダクションで解説されているように処理工程の順番です。つまり、⟨対数符号化⟩が処理工程の一番前に位置し、⟨色と明るさ⟩が最後です。機能に付随するマスクによる処理も同じです。
- 　一覧の中から⟨色と明るさ⟩を選択します“

<div>

<figure>
<img src="/images/addtoolcolorandlight1.jpg" title="addtoolcolorandlight1.jpg"
width="600" />
<figcaption>addtoolcolorandlight1.jpg</figcaption>
</figure>

</ul>
</div>

#### 輝度（明度）と色度の調整

　スライダーを使って明度を-70、色度を130に調節します。

　その結果、花の色だけが変わりました: 花のL\* a\*ｂ\*の値がL=41.0 a=65.6
b=52.8に変わりましたが、空のブルー、葉のグリーンのL\*
a\*ｂ\*の値に変化はありません。

<div>

<figure>
<img src="/images/lightchro.jpg" title="lightchro.jpg" width="600" />
<figcaption>lightchro.jpg</figcaption>
</figure>

</ul>
</div>

#### カラー機能のスコープと変移の階調の役割

　これら2つの役割は、前者が色情報の違いをベースに、後者がRT-スポットの中心円からフレームまでの距離をベースに、調整範囲をコントロールすることです。2つを組み合わせることで、より細かく編集範囲を定めることが出来ます。

- 　⟨設定⟩の中の"カラー機能のスコープ"のスライダーを動かして画像の変化を見ます：
  - 　RT-スポット内の画像では、基準値である中心円部分のピクセルとその他の部分のピクセルの色情報の違いを表すΔEが計算されます。違いが小さければ低いΔE、大きければ高いΔEになります。カラー機能のスコープは、このΔEの範囲の中で、調整の働く範囲と働かない範囲を調節するスライダーです。違いが無い部分からスコープで設定された違いが小さい部分までは調整が100％働き、そこから一定の違いがある部分までは調整効果が漸進的に減衰し（減衰のペースは⟨ΔEの減衰⟩スライダーで調節します）、それより違いの大きい残りの部分では調整が働きません。
  - 　デフォルトは30に設定されています。この設定値で概ね花のレッド全体に調整が働きますが（本例では、色度を上げ、明度を下げる）、色情報の違いが大きい（ΔEが高い）空のブルーや葉のグリーンは調整が働かず明度や色度は変化しません。
  - 　しかし、カラー機能のスコープ値を下げていくと、ΔEが低い部分でも調整効果に差が出てきます（レッドの一部だけに調整が100％働く）。逆に、値を上げていくと色情報の違いが無視されるようになり、調整が働く部分が増えてきます。80～100になると空のブルーや葉のグリーンの色度と明度も変化します。

　次に、変移の階調の役割を解説します。カラー機能のスコープの値を100にして、設定の"全ての設定項目を表示"オプションを有効にします。

- 　"変移の階調"パネルを拡張し、その中の変移の位置を上げ下げして変化の違いを見ます。
  - 　このスライダーは、中心円からRT-スポットのフレームに向かってどこまでを調整範囲とするか設定するものです。設定値は中心円からフレームまでの距離の割合を意味します。
  - 　低い値にするほど、調整範囲が中心円付近だけに限られます。一方、高い値にすると調整範囲が広がり、100ではRT-スポット全体が調整範囲となります。
  - 　中心円から設定された変移の位置までは調整が100％働き、変移の位置からフレームまでは調整が漸進的に減衰（減衰のペースは⟨変移の減衰⟩スライダーで調節します）。

#### 調整が適用される部分の確認　プレビューΔE

　"カラー機能のスコープ"で定められた調整の作用が及ぶ部分を予めプレビュー画面で確認出来ます。但し、調整の程度や作用が100％働く境界の位置は確認出来ません（これらの確認は次の\[調整の効果を見る\]で説明されています）。RT-スポットに追加した機能の個数によって手順が2つに分かれます：

- 　現在のRT-スポットに追加された色に関する機能が一つだけの場合：⟨設定⟩に付属している&langプレビューΔE⟩ボタンを使います。
- 　RT-スポットに追加された機能が複数の場合：プレビューで確認したい効果に関係する方の機能の中にある⟨マスクと修正領域⟩パネルを拡張し、コンボボックスの中にある⟨プレビューΔE⟩を使います（但し、機能水準が標準或いは高度の場合だけ）。この様にすれば、確認の必要がない方の効果はプレビューに反映されません。

　設定の中の"形状検出"パネルの中の"プレビューΔEカラー‐強さ"を調整して、表示色とその濃さを変えることが出来ます。

<div>

<figure>
<img src="/images/previewdeltae1.jpg" title="previewdeltae1.jpg" width="600" />
<figcaption>previewdeltae1.jpg</figcaption>
</figure>

</ul>
</div>

#### 調整の効果を見る

　調整で変化した部分を見るためには:

- 　機能水準を⟨標準⟩、或いは⟨高度⟩にして、一番下に表示される"マスクと修正領域"を開き、コンボボックスの中から"修正された領域をマスクなしで表示"を選択します。
- 　このオプションにより、画像の質感や構造だけでなく、輝度、コントラスト、色度などに対して行われた調整により変化した部分を知ることが出来ます。
- 　変移の階調調整の効果を見ることが出来ます：　
  - 　"変移の位置"：RT-スポット全体の中で調整が働く領域の割合を変える（0から100％）
  - 　"変移の減衰"：効果の減衰ペース（線形的から対数的まで）を変える
  - 　"XY軸方向による変移の差別化"：X軸とY軸で調整が働く領域の割合を変える

　以下の調整を行って効果を観察してみます。

- 　"カラー機能のスコープ"を変えてみます。スコープのスライダーはΔEに対して働くことを覚えておいて下さい。
- 　変移の階調の設定を変えてみます。
- 　輝度や色度の設定を変えてみます。

<div>

<figure>
<img src="/images/showmodif.jpg" title="showmodif.jpg" width="600" />
<figcaption>showmodif.jpg</figcaption>
</figure>

</ul>
</div>

#### ローカル編集で画像全体を編集

　ローカル編集の利用は画像の一部の編集だけに限られるわけではありません。画像全体を処理することも出来ます。

- 　⟨設定⟩の"スポットのタイプ"で
  "画像全体"を選択すると、画像全体を囲うフレームが自動で設定されます。中心円の位置や大きさは、目標とする調整に応じて手動で調節します。注意：選択時に設定されるフレームは大きいため、プレビュー画像を縮小（12％以下）しない限り、フレームの位置は見えません。
- 　画像全体を編集対象とするため、"変移の階調"の中にある変移の位置のスライダーは自動的に100に変わります（他のタイプの場合は60がデフォルト）。

<div>

<figure>
<img src="/images/fullim1.jpg" title="fullim1.jpg" width="600" />
<figcaption>fullim1.jpg</figcaption>
</figure>

</ul>
</div>

#### 同じRT-スポット内で複数の機能を使う時

　ローカル編集の殆どの機能は同一のRT-スポットの中で使うことが出来ますが、〈対数符号化〉と〈トーンマッピング〉、〈レティネックス〉の3つに関しては、うち2つ以上を同じスポット内で使うことは避けます。プレビューに表示される画像が、出力画像（TIFF或いはJPEG）と同じ映りにならないことがあり、その場合編集作業が難しくなる（出力画像の予測がつかない）からです。特に、拡大ツールを使ってプレビュー画像を拡大している場合にそうなることがあります。　これら3つの機能の何れかを他のローカル編集機能（例えば、色と明るさ）と一緒に使う場合は、この様な問題は起こりません。3つの機能を組み合わせて使いたい場合は、同じRT-スポットではなく、別なRT-スポットを追加作成して、それを初めのRT-スポットの傍に配置して使います。　例えば、初めのRT-スポットで〈対数符号化〉を使い、2つ目のRT-スポットで〈トーンマッピング〉或いは〈レティネックス〉を使います。

### 例を使った基本操作の説明

#### 葉の色を変える、その後一枚の葉だけを除外する

##### 最初に、全部の葉の色を変える

- 　"カラー補正グリッド"でL\*a\*b\*の補色次元a\*とｂ\*を変えます。⟨直接⟩を選択し、⟨強さ⟩の値を高くします。そして、グリッド上の点（黒と白）を実例の様に移動すると、全ての葉の色が変わります。
- 　必要であれば、"カラー機能のスコープ"を調整します。
- 　空の色や花の色は異なるので変化しません。

<div>

<figure>
<img src="/images/Colorleav1.jpg" title="Colorleav1.jpg" width="600" />
<figcaption>Colorleav1.jpg</figcaption>
</figure>

</ul>
</div>

##### その後、一枚の葉の色だけを元のグリーンに戻す

- 　⟨設定⟩の⟨作成/追加⟩を使って2つ目のRT-スポットを追加します。
- 　RT-スポットのタイプを"除外スポット"に変えます。
- 　そのRT-スポットの中心を目標とする葉の色（色を戻したい葉）の部分に移動します。葉の大きさを十分カバーするようにRT-スポットの境界を拡大します。
- 　⟨除外⟩の中の⟨スコープ⟩を目標とする効果が得られるように調節します。
- 　除外スポットは通常のスポットとして使うことも可能です。他の機能を追加して使います（本例の場合、⟨色と明るさ⟩以外の、⟨ノイズ除去⟩、⟨ぼかし⟩などの機能）。つまり除外スポットは他のRT-スポットで調整した効果を部分的に無効にするだけなので、他の機能の調整であれば追加することが出来ます。

<div>

<figure>
<img src="/images/Excluding1.jpg" title="Excluding1.jpg" width="600" />
<figcaption>Excluding1.jpg</figcaption>
</figure>

</ul>
</div>

#### 赤目の補正とセンサーに起因する欠陥の除去

　赤目の補正手順は、準備、RT-スポットの調節、赤目を除く、の3段階からなります。

##### 準備

- 　目の周りを十分な大きさのRT-スポットで囲みます。
- 　RT-スポットの中心を赤くなった目（瞳）に合わせます。
- 　⟨ロック式カラーピッカー⟩を調整によって色の変化が予想される4カ所に配置します。

<div>

<figure>
<img src="/images/Redeye_prepare1.jpg" title="Redeye_prepare1.jpg"
width="600" />
<figcaption>Redeye_prepare1.jpg</figcaption>
</figure>

</ul>
</div>

##### RT-スポットの調整

- 　⟨色と明るさ⟩の機能を追加します。
- 　⟨設定⟩の"プレビューΔE"ボタンを押します（作用の及ぶ部分がグリーンで表示されます）。
- 　RT-スポットを目標とする補正が行えるように調整します：
  - 　RT-スポットの中心円の大きさを14にしました。
  - 　"カラー機能のスコープ"を18にしました。

<div>

<figure>
<img src="/images/Redeye_previewdE1.jpg" title="Redeye_previewdE1.jpg"
width="600" />
<figcaption>Redeye_previewdE1.jpg</figcaption>
</figure>

</ul>
</div>

##### 赤色を除く作業

- 　⟨色と明るさ⟩の色度のスライダーを-100にします。
- 　結果を確認します :
  - 　瞳の主体色がなくなりました。
  - 　虹彩、角膜、肌の色に変化はありません。
  - 　結果の状況に応じて多少の調整が必要かもしれません。例えば、赤目の外側でも色が褪せるようであれば、⟨設定⟩の"変移の位置"を低く、或いは、"変移の減衰"を高くします。

<div>

<figure>
<img src="/images/Redeye.jpg" title="Redeye.jpg" width="600" />
<figcaption>Redeye.jpg</figcaption>
</figure>

</ul>
</div>

##### レンズに付着したゴミやセンサーの欠損などに起因する不良部分の補正

　レンズに付着したゴミやセンサーの欠損などに起因する不良部分の補正も、赤目の補正と同じ原理で処理します。但し、本例では別の機能を使った補正を紹介します。

- 　⟨ローカルコントラスト&ウェーブレット⟩（機能水準は高度）の⟨ウェーブレットピラミッド2⟩の"レベルによるコントラスト調整"、或いは⟨詳細レベルによるコントラスト調整⟩を使います。
- 　両方法とも、番手の低いレベルのコントラストを下げることで目的を果たします。
- 　必要であれば"レベルのぼかし"（⟨ウェーブレットピラミッド1⟩）を使うことも出来ます。
- 　"変移の位置"を低く（20以下）、"変移の減衰"は高く（15以上）設定します。
- 　但し、⟨ウェーブレットピラミッド2⟩や⟨詳細レベルによるコントラスト調整⟩を使う場合は、RT-スポットの大きさが最低でも32x32ピクセル以上ないと適切に作用しないので、欠陥の大きさがRT-スポットに比べて非常に小さい時は、変移の位置やΔEを使って対処します。

　ここでは、複数の汚れ跡を⟨ウェーブレットピラミッド2⟩で処理します。

- 　次のスクリーンショットを見て下さい。幾つか小さな染みが目立ちます。

<div>

<figure>
<img src="/images/Blotches.jpg" title="Blotches.jpg" width="600" />
<figcaption>Blotches.jpg</figcaption>
</figure>

</ul>
</div>

- 　RT-スポットに⟨ローカルコントラスト&ウェーブレット⟩の機能を追加します。
- 　機能水準のモードを⟨高度⟩にし、コンボボックスの中から⟨ウェーブレット⟩を選びます。
- 　⟨スコープ⟩は20にセットします。
- 　⟨ピラミッド２⟩　の"レベルによるコントラスト調整"にチェックを入れます。
- 　"減衰応答"、"オフセット"、"色度のレベル"（場合によっては）で高い値を設定します。
- 　"レベルによるコントラスト調整"のカーブを使って、番手の低い詳細レベルのコントラストを下げます。

<div>

<figure>
<img src="/images/Blotchesless1.jpg" title="Blotchesless1.jpg" width="600" />
<figcaption>Blotchesless1.jpg</figcaption>
</figure>

</ul>
</div>

#### 覆い焼きと焼き込み

　ポートレート写真など、光が肌に直接当たっている写真では、コントラストが過度に強くなってしまう不快な現象が起きることがあります。肌の一部分が露出過多になる一方で、他の部分が露出不足になるケースです。

- 　一般的に、この問題はマスクとレイヤーを使って補正されています。GIMPやPhotoshop©を使ったこの補正のチュートリアルは沢山あります。RawTherapeeのユーザーはローカル編集に備わっているマスクを使って類似の編集が可能ですが、本例では：
- 　⟨独自のレティネックス⟩
  （Ipolの研究成果を応用）を使った補正を紹介します。レティネックスは1970年代に生まれた概念で、従来は異なる分野のアプリケーションとして使われていますが、RawTherapeeはそれを応用しました。以下の様に使います：
  - 　プラス作用素に関わるしきい値スライダー；⟨強さ⟩、或いは⟨ラプラシアンのしきい値　ΔE⟩を使う（注釈参照）。
  - 　⟨ポアソン方程式⟩（偏微分方程式）の解を求める。
  - 　輝度値のバランスを図る。

　注釈：ラプラス作用素とポアソン方程式を採用しています。前者は小さなディテールの検知に優れています。後者はラプラス作用素により作られた偏微分方程式の解を求め、機能を使えるようにするためのものです。しかし、機能を使う上で、これら複雑な数学を理解しなければならないということはありません。

##### 準備

- 　ΔEや⟨スコープ⟩（⟨独自のレティネックス⟩の中にあるスコープ）、変移の位置の設定の要領はこれまでの例と変わりません。
- 　ポートレートを例題に使います。但し、肖像権の問題を避けるために、目を隠しています。
- 　"現在のスポットに機能を追加"で⟨ソフトライト&独自のレティネックス⟩を選びます。機能の水準は⟨高度⟩、コンボボックスの中から独自のレティネックスを選択します。　

<div>

<figure>
<img src="/images/Dodgeburn1.jpg" title="Dodgeburn1.jpg" width="600" />
<figcaption>Dodgeburn1.jpg</figcaption>
</figure>

</ul>
</div>

##### ラプラシアンのしきい値調整と見え方の変化

- 　1階ラプラス作用素のしきい値を考慮する⟨強さ⟩のスライダーを調節します。
- 　⟨ラプラシアンのしきい値　ΔE⟩スライダーを調節します（2階ラプラス作用素に作用させるため画像のΔEを考慮します）。この処理はスコープのアルゴリズムのアップストリームに位置し、背景との違いを考慮することが出来ます。
- 　"フーリエの処理を表示"のコンボボックスの中から"マスクなしで変更を表示"を選び、変更をプレビューで確認します。

<div>

<figure>
<img src="/images/Dodgeburnshow.jpg" title="Dodgeburnshow.jpg" width="600" />
<figcaption>Dodgeburnshow.jpg</figcaption>
</figure>

</ul>
</div>

##### 結果

　
　似たようなアルゴリズムが、⟨ダイナミックレンジ&露光補正⟩の中で使われています。露出に大きな違いがある画像（全体的に露出不足の場合が多い）の補正に使うことが出来ます。

<div>

<figure>
<img src="/images/Dodgeburnmodif.jpg" title="Dodgeburnmodif.jpg" width="600" />
<figcaption>Dodgeburnmodif.jpg</figcaption>
</figure>

</ul>
</div>

#### 輝度、色度、色相をベースに階調フィルタを施す

##### 準備

- 　⟨ロック式カラーピッカー⟩を7つの観測点に配置します。
- 　⟨色と明るさ⟩の機能を追加し、機能水準を⟨高度⟩にします。

<div>

<figure>
<img src="/images/Gradprepa1.jpg" title="Gradprepa1.jpg" width="600" />
<figcaption>Gradprepa1.jpg</figcaption>
</figure>

Rawファイルへのリンク(Creative Commons Attribution-Share Alike 4.0)：
[2](https://drive.google.com/file/d/1X2g73FqzQl7-WRfzhF7zHa7XWwnKcwtx/view?usp=sharing)

</ul>
</div>

##### 諧調フィルタを施す

　任意に以下の設定をしました。

- 　⟨輝度の階調⟩の強さ： -0.44
- 　⟨色度の階調⟩の強さ：1.13
- 　⟨色相の階調⟩の強さ : 2.69
- 　⟨階調フィルタの角度⟩ : -87.6
- 　⟨カラー機能のスコープ⟩ = 30
- 　⟨設定⟩の⟨フェザー処理⟩ = 25

<div>

<figure>
<img src="/images/gradLCH1.jpg" title="gradLCH1.jpg" width="600" />
<figcaption>gradLCH1.jpg</figcaption>
</figure>

</ul>
</div>

##### デフォルトの設定を変えてみる

- 　カラー機能のスコープの値を、70、75、80、85、90、100と少しずつ変えてみて下さい。
- 　フェザー処理の値も変えてみます。
- 　階調フィルタの値（L,C,H、フィルタの角度）も変えてみて下さい
- 　また、色と明るさの機能の値も変えてみます。

<div>

<figure>
<img src="/images/gradLCHScopeFeather1.jpg" title="gradLCHScopeFeather1.jpg"
width="600" />
<figcaption>gradLCHScopeFeather1.jpg</figcaption>
</figure>

</ul>
</div>

#### 露光を変えてシャドウを明るくする5つの方法

　
　以下の説明は露光を変える方法を幾つか（これらだけに限られません）示したものです。

- 　補正が難しい画像です。シャドウ部分が非常い暗い一方で中心部付近の殆どが露出過多になっています。
- 　5つの方法があります。各設定は任意です。
  - 　⟨シャドウ/ハイライト⟩
  - 　⟨トーンイコライザ⟩
  - 　⟨TRC⟩（トーンリプロダクションカーブ）
  - 　⟨対数符号化⟩
  - 　⟨ダイナミックレンジ圧縮&露光補正⟩

　他にも以下の様な調整法が考えられます :

- 　コントラストに関係するカーブを使う
- 　⟨色と明るさ⟩の明るさのスライダーを使う
- 　⟨輝度の階調フィルタ⟩を調整する

##### 準備

- 　以下のスクリーンショットのようにRT-スポットを⟨作成/追加⟩します。
- 　⟨カラー機能のスコープ⟩スライダーを50にセットします（⟨シャドウ/ハイライト⟩の機能を使う場合はカラー機能のスコープを使いますが、⟨対数符号化⟩と⟨露光補正⟩の機能を使う場合は、それらのモジュールに付属している⟨スコープ⟩を使います）。
- 　5つの調整方法を試す際には、スコープの値を20や100に変えて効果の違いを見て下さい。

<div>

<figure>
<img src="/images/shadows-prepa1.jpg" title="shadows-prepa1.jpg" width="600" />
<figcaption>shadows-prepa1.jpg</figcaption>
</figure>

Rawファイルへのリンク(RawTherapee - Creative Commons Attribution-Share
Alike 4.0)：
[3](https://drive.google.com/file/d/1ziux382pWgdYa4jySimwKaKnK_KdDhno/view?usp=sharing)

</ul>
</div>

##### シャドウ/ハイライトを使う

　⟨シャドウ/ハイライト&トーンイコライザ⟩をRT-スポットに追加します。機能水準は⟨標準⟩です。

- 　機能タイトル下のコンボボックスから⟨シャドウ/ハイライト⟩を選択します（デフォルトは⟨イコライザ⟩になっています）。
- 　"シャドウ"や"シャドウトーンの幅"を調節してみます。

<div>

<figure>
<img src="/images/shadows-sh1.jpg" title="shadows-sh1.jpg" width="600" />
<figcaption>shadows-sh1.jpg</figcaption>
</figure>

</ul>
</div>

##### トーンイコライザを使う

　 　上記と同じ機能で、今度は：

- 　コンボボックスから⟨イコライザ⟩を選択します。
- 　スライダー1、2，を変えてみます。

<div>

<figure>
<img src="/images/shadows-toneeq2.jpg" title="shadows-toneeq2.jpg"
width="600" />
<figcaption>shadows-toneeq2.jpg</figcaption>
</figure>

</ul>
</div>

##### TRCを使う

　 　更に、上記と同じ機能で、今度は：

- 　スライダーの下にある⟨TRC⟩（トーンリプロダクションカーブ）を使います。
- 　"スロープ"を150に上げて、変化を見て下さい。
- 　ガンマを上下させて違いを見て下さい。

<div>

<figure>
<img src="/images/shadows-trc1.jpg" title="shadows-trc1.jpg" width="600" />
<figcaption>shadows-trc1.jpg</figcaption>
</figure>

</ul>
</div>

##### 対数符号化を使う

　⟨対数符号化⟩を追加します。

- 　対数符号化の中にある⟨スコープ⟩を変えてみます、例えば50
- 　⟨自動⟩ボタンを押してみます。
- 　"平均輝度（Yb％）"を変えてみます。

<div>

<figure>
<img src="/images/shadows-elog1.jpg" title="shadows-elog1.jpg" width="600" />
<figcaption>shadows-elog1.jpg</figcaption>
</figure>

</ul>
</div>

##### 露光補正を使う

　⟨ダイナミックレンジ&露光補正⟩機能を追加します。

- 　機能水準は⟨標準⟩です。
- 　"露光量補正ƒ"（ラプラス変換とフーリエ変換を適用します）を調整します。
- 　⟨露光補正⟩機能のパネルを拡張し、黒レベルを-1150、シャドウを50に設定します。
- 　"ハイライト圧縮"はデフォルトでは20に設定されていますが、これを変えて変化を見ます。
- 　他の設定値も変えてみます。

<div>

<figure>
<img src="/images/shadows-expo1.jpg" title="shadows-expo1.jpg" width="600" />
<figcaption>shadows-expo1.jpg</figcaption>
</figure>

</ul>
</div>

##### 特定の画像に推奨される方法

　ポートレートなどカラーコントラストの少ない画像を編集する場合：

- 　露光量補正
  ƒのスライダーの操作には注意が必要です。この露光量補正はメインの露光補正タブにあるスライダーと似ていますが、ローカル編集において、人の肌の様に色の変化が少ない部分的な画像が編集目標である場合は上手く対応できないからです。ラプラス作用素の導入でコントラストの差異を処理する部分は改善しましたが、まだベストな解決には至っていません。

　改善はしましたが、全般的に：

- 　露光補正のアルゴリズムのパフォーマンスは最適とは言えません。しかし、多くのユーザーは既に露光補正の使い方に馴染んでいるので、幾つかの対処法を追加しました。
- 　単純な方法としては：
  - 　⟨シャドウ/ハイライト＆トーンイコライザ⟩の中にある⟨トーンイコライザ⟩を使って調整する。
  - 　同じくモジュールの中にある⟨トーンリプロダクションカーブ（TRC）⟩を使って調整する。スロープを使ってシャドウを線形的に引き上げる、或いはガンマを使って明るさを増やす。

　加えて、露光補正機能を使う場合は、メインの設定にある"形状検出"の設定値を変えてみることも勧められます：

- 　"ΔE スコープのしきい値"を増やす。
- 　"ΔEの減衰"を下げる。
- 　"ΔEのバランス ab-L"を調整する。
- 　必要に応じて⟨カラー機能のスコープ⟩を調整する。

##### ローカル編集に備わっている機能のダイナミックレンジ復元の評価

TIFファイルへのリンク(Creative Common Attribution-share Alike 4.0):
[4](https://drive.google.com/file/d/1vAzFY7Qh8MdJ882J_4JeO_cnpGELzD8D/view?usp=sharing)

###### 元画像 - 25Ev – 未処理

注目点：

- 　シャドウ部分の詳細が不足しています。
- 　画像の約40％は100％ホワイトです。
- 　復元されたダイナミックレンジは概ね12Evから13Evです。

<figure>
<img src="/images/sweep-rgb-neutral.jpg" title="sweep-rgb-neutral.jpg"
width="600" />
<figcaption>sweep-rgb-neutral.jpg</figcaption>
</figure>

###### 対数符号化を使って復元した画像

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝99.8までの可視領域全体を占めています（尺度0～100）。
- 　輝度に応じて色が均等に分布しています。つまり、このL\*a\*b\*機能はダイナミックレンジに影響していないことが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは25Evです。
- 　注意："ホワイトの分布"を90に設定しています。

<figure>
<img src="/images/sweep-rgb-log.jpg" title="sweep-rgb-log.jpg" width="600" />
<figcaption>sweep-rgb-log.jpg</figcaption>
</figure>

###### 色の見えCAM16を使って復元した画像

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝80.9までの可視領域の一部を占めています（尺度0～100）。
- 　輝度に応じて色が均等に分布しています。つまり、このL\*a\*b\*機能はダイナミックレンジに影響していないことが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは25Evです。
- 　注意："ホワイトの分布"を100、"ブラックの分布"を60に設定しています。
- 　留意点：対数符号化の結果と違うのはCIECAMの作用により輝度分布が変化するからです。

TRCガンマカーブを使えば、先の対数符号化で復元した画像に近くなります。TRCガンマカーブの代わりにコントラストJや輝度Jのスライダーを使うことも出来ます。

<figure>
<img src="/images/sweep-rgb-cie.jpg" title="sweep-rgb-cie.jpg" width="600" />
<figcaption>sweep-rgb-cie.jpg</figcaption>
</figure>

###### トーンイコライザを使って復元した画像

注目点:

- 　シャドウ部分とハイライト部分が、L＝1からL＝82までの可視領域の一部を占めています（尺度0～100）。
- 　輝度に応じた色の分布が均等になっていません。つまり、このL\*a\*b\*機能はダイナミックレンジに多少影響することが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは概ね15Evから18Evです。
- 　注意：非常に明るいハイライト（最も明るい）を処理するために5番目のスライダーを‐100にしています。

<figure>
<img src="/images/sweep-rgb-te.jpg" title="sweep-rgb-te.jpg" width="600" />
<figcaption>sweep-rgb-te.jpg</figcaption>
</figure>

###### ダイナミックレンジ＆露光補正を使って復元した画像

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝95.8までの可視領域の一部を占めています（尺度0～100）。
- 　輝度と色に応じた色の分布が均等ではありません（ブルーで色ずれが発生しています）。このL\*a\*b\*機能はダイナミックレンジに多少影響することが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは概ね17Evから20Evです。
- 　注意：この機能は複雑で、感覚的な調整が難しく、処理時間は長いです。

<figure>
<img src="/images/sweep-rgb-drexp1.jpg" title="sweep-rgb-drexp1.jpg"
width="600" />
<figcaption>sweep-rgb-drexp1.jpg</figcaption>
</figure>

###### 霞除去を使って復元した画像

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝88までの可視領域の一部を占めています（尺度0～100）。
- 　輝度に応じた色の分布が均等ではありません。このL\*a\*b\*機能はダイナミックレンジに影響することが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは概ね15Evから16Evです。

<figure>
<img src="/images/sweep-rgb-deha.jpg" title="sweep-rgb-deha.jpg" width="600" />
<figcaption>sweep-rgb-deha.jpg</figcaption>
</figure>

###### シャドウ/ハイライトを使って復元した画像

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝70までの可視領域の一部を占めています（尺度0～100）。
- 　輝度に応じた色の分布が均等ではありません。
- 　このL\*a\*b\*機能はダイナミックレンジに影響することが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは概ね12Evから13Evです。

<figure>
<img src="/images/sweep-rgb-sh.jpg" title="sweep-rgb-sh.jpg" width="600" />
<figcaption>sweep-rgb-sh.jpg</figcaption>
</figure>

###### TRC（トーンリプロダクションカーブ）とTRC CAM16を使って復元した画像

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝95.6までの可視領域の一部を占めています（尺度0～100）。
- 　輝度に応じた色の分布が均等ではありません。つまり、このL\*a\*b\*機能はダイナミックレンジに多少影響することが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは概ね12Evから16Evです。

<figure>
<img src="/images/sweep-rgb-trc.jpg" title="sweep-rgb-trc.jpg" width="600" />
<figcaption>sweep-rgb-trc.jpg</figcaption>
</figure>

- 　TRC CAM16

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝98.8までの可視領域の一部を占めています（尺度0～100）。
- 　輝度に応じて色が均等に分布しています。このL\*a\*b\*機能の使用はダイナミックレンジに若干しか影響していません。
- 　復元されたブラック、ホワイト、色のダイナミックレンジは概ね20Evから22Evです。

注意："ホワイトの分布"を80に設定し、"ハイライトの減衰"を使用しています。

<figure>
<img src="/images/sweep-rgb-trc-cam16.jpg" title="sweep-rgb-trc-cam16.jpg"
width="600" />
<figcaption>sweep-rgb-trc-cam16.jpg</figcaption>
</figure>

###### ダイナミックレンジ＆露光補正の露光補正だけを使って復元した画像

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝70.9までの可視領域の一部を占めています（尺度0～100）。
- 　輝度に応じた色の忠実性が悪く、分布も均等ではありません。このL\*a\*b\*機能はダイナミックレンジに大きく影響することが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは概ね11Evから14Evです。

<figure>
<img src="/images/sweep-rgb-exp.jpg" title="sweep-rgb-exp.jpg" width="600" />
<figcaption>sweep-rgb-exp.jpg</figcaption>
</figure>

###### トーンマッピングを使って復元した画像

注目点：

- 　シャドウ部分とハイライト部分が、L＝1からL＝72.4までの可視領域の一部を占めています（尺度0～100）。
- 　輝度に応じた色の分布が均等ではありません。
- 　このL\*a\*b\*機能はダイナミックレンジに大きく影響することが分かります。
- 　復元されたブラック、ホワイト、及び色のダイナミックレンジは概ね10Evから14Evです。

<figure>
<img src="/images/sweep-rgb-tm.jpg" title="sweep-rgb-tm.jpg" width="600" />
<figcaption>sweep-rgb-tm.jpg</figcaption>
</figure>

###### まとめ

- 　ローカル編集の⟨対数符号化⟩機能や⟨色の見えCAM16⟩などのように、対数符号化のアルゴリズムを使うと、ダイナミックレンジは十分に復元できますが、感覚的な調整が簡単ではありません。
- 　ローカル編集のCAM16に備わっている⟨TRC⟩機能は色とダイナミックレンジをほぼ完全に復元できます。多くのハイダイナミックレンジ復元に適しており、操作も単純で感覚的に行えます。
- 　ローカル編集の⟨トーンイコライザ⟩機能でも、ある程度適度なダイナミックレンジ復元が確保されます。殆どの写真画像に使え、機能が感覚的に調整できますが、少なくとも5つのスライダー調節が必要です。
- 　
  ⟨ダイナミックレンジ＆露光補正⟩機能は、色ずれが多少発生しますが、ダイナミックレンジの復元の効果は非常に高いです。しかし、感覚的な編集は簡単ではなく、処理時間も長くなります。
- 　ローカル編集の⟨TRC⟩機能によるダイナミックレンジ復元は、平均的な結果になりますが、多くの画像で使えます。操作は単純で感覚的に調整が出来ます。
- 　ローカル編集の⟨霞除去⟩機能は本来の目的（つまり、霞除去）で使用した場合、ダイナミックレンジに著しく影響を及ぼします。
- 　ローカル編集の⟨ダイナミックレンジ＆露光補正⟩の露光補正機能だけや⟨シャドウ/ハイライト⟩機能は、今回のテストで見る限り、ダイナミックレンジ復元という観点では良い結果を得られませんでした。
- 　理論上、ダイナミックレンジ圧縮に特化していると思われる、⟨トーンマッピング⟩機能の復元効果が悪かったことは興味深いことです。

#### 霞がかった画像の処理

本例では、霞が強くかかった風景画像を処理します。初めにメインのディテールタブにある⟨霞除去⟩を使って全体的に補正を行い、その後、⟨ローカル編集⟩の⟨レティネックス⟩を使って更に空と水平線の部分を補正します。

##### 元画像

<div>

<figure>
<img src="/images/Haze.jpg" title="Haze.jpg" width="600" />
<figcaption>Haze.jpg</figcaption>
</figure>

Rawファイルのリンク(Pixls.us - Creative Commons Attribution-Share Alike
4.0)：
[5](https://drive.google.com/file/d/1tc9TxHGwYnVQ2OwiTZIiszDOEXfDjkh6/view?usp=sharing)

</ul>
</div>

##### 霞除去（メインのディテールタブの霞除去）による処理

　初めから、⟨ローカル編集⟩の⟨霞除去⟩を使っても補正が出来ますが、画像をよく見ると、背景と丘陵部分の霞がより強いので、2段階で補正する方がいいでしょう。

<div>

<figure>
<img src="/images/Haze-dehaze.jpg" title="Haze-dehaze.jpg" width="600" />
<figcaption>Haze-dehaze.jpg</figcaption>
</figure>

</ul>
</div>

##### ローカル編集のレティネックスを使った追加補正

- 　⟨霞除去-レティネックス⟩を追加します。機能水準のモードは"高度"にします。
- 　備わっている機能の設定を色々変えてみます。
- 　必要に応じて⟨透過マップ⟩を開き、カーブの右側を下げます。
- 　調整の結果を見極めます。遠景の霞が軽減されました。

<div>

<figure>
<img src="/images/Haze-reti1.jpg" title="Haze-reti1.jpg" width="600" />
<figcaption>Haze-reti1.jpg</figcaption>
</figure>

</ul>
</div>

#### ノイズ除去のモジュールを使う

　⟨ぼかし/質感＆ノイズ除去⟩の中の⟨ノイズ除去⟩の使い方は幾つかあります：

1.  　まず画像全体を対象とするメインのディテールタブの⟨ノイズ低減⟩を使って、編集目標に着目しながら控えめに（被写体の詳細が失われないように）補正を行います。その後、編集目標をローカル編集の⟨ノイズ除去⟩を使って追加補正します。
2.  　⟨ノイズ除去⟩を使って、画像全体を対象にして補正を行います。その後、除外スポットを使って、ノイズを除去したくない部分を元に戻します。
3.  　画像全体でノイズが多くなければ、⟨ノイズ除去⟩だけを使って、目標部分のノイズだけ補正します。
4.  　全体的にノイズの多い画像を、⟨ノイズ除去⟩でRT-スポット内のノイズだけを補正し、スポット以外の部分はあえてノイズを残し創作的な画像にします。

　以下は4番目の使い方の解説です。下の少女のポートレート画像はノイズが多く、特に強い色ノイズが見られます。

##### 100％に拡大

<div>

<figure>
<img src="/images/Denoise-zoom1.jpg" title="Denoise-zoom1.jpg" width="600" />
<figcaption>Denoise-zoom1.jpg</figcaption>
</figure>

</ul>
</div>

##### 編集前の要点

- 　4番目の使い方では、RT-スポットの中心円の位置と、RT-スポットによるノイズを除去する領域の囲い込みが重要です。中心円は色ノイズが強い部分に置き、目標である顔のノイズ除去のためRT-スポットは顔全体が囲まれるように広げます。
- 　⟨スコープ⟩の設定値も重要です。本例の場合、色ノイズの色が多岐に渡っている（レッド、グリーン、ブルー、イエロー）ので、スコープの値が低いと、色の違いによる作用の選別が行われ、作用（ノイズ除去）が及ばない色ノイズが残ってしまいます。従って本例では90に設定しています。一方、輝度ノイズの除去が主な目的であれば、設定値はデフォルトの30で十分でしょう。

##### 編集機能の違い

　⟨ぼかし/質感＆ノイズ除去⟩のノイズ除去機能は、メインのディテールタブの⟨ノイズ低減⟩とは幾つか異なる点があります：

- 　メインの⟨ノイズ低減⟩の輝度ノイズカーブはシャドウ/ハイライト部分に応じて作用に違いを付けますが、ローカル編集の⟨ノイズ除去⟩の輝度ノイズカーブは、ウェーブレットで分解した詳細レベルに応じて作用に差を付けます。X軸の左端が最も細かい詳細レベル（0）にあたり、右端が最も粗い詳細レベル（６）にあたります。
- 　詳細レベルの位置取りに応じて作用の強さが変わります：例えば、３以上の詳細レベルの位置が縦軸の20％以上になるとノイズ除去の作用が積極的なモードになります。
- 　シャドウ部分とハイライト部分で輝度ノイズ除去の作用の比重を変える場合は、ガンマではなくイコライザを用います。
- 　細かい詳細レベルの色ノイズ（0番から4番までのインパルスノイズや低色ノイズ）と粗い詳細レベルの色ノイズ（5番から6番のパケットノイズ、ブロッチノイズ）を区別してノイズ除去が可能です。
- 　レッド/グリーンとブルー/イエローでノイズ除去の比重を変えることの出来る⟨イコライザ　カラー⟩は色ノイズの少ない画像補正に便利です。
- 　詳細復元（色）はDCT（フーリエ変換に関係する離散コサイン変換）を使っています。
- 　形状検出をベースにして作用に差を付ける⟨輝度と色の詳細のしきい値⟩が備わっています。

##### ノイズ低減の複雑な問題：画像の構造が違う部分でどの様に作用に差を付けるか？

　被写体（前景）と背景を分けて扱うことは、写真の世界ではよくある問題です。被写体とは動物や、建物、人物、背景は空や芝生、森、壁などのことですが、ノイズ低減ソフトフェアにとっては複雑な問題です。何故なら、通常、ノイズ低減のアルゴリズムは被写体とその背景を区別していないからです。これは背景のノイズを除去する際に、被写体の詳細やコントラスト、色も一緒に失う可能性があることを意味します。

###### Andy Astburyのカヤネズミの画像を使った例

　Andy
Asbury氏から使用許可を得た画像を使って説明します。グレーの背景の中にカヤネズミが際立っています。但し、ノイズが若干多い画像です。ここでこれらノイズを、ディテールタブの⟨ノイズ低減⟩だけを使って除去しようとすると、背景のノイズばかりでなく、被写体であるカヤネズミの詳細やコントラスト、彩度も失われてしまいます。

Rawファイルへのリンク(Copyright Andy Astbury - Creative Common
Attribution-share Alike 4.0)：
[6](https://drive.google.com/file/d/1uND8pqgfxxaBhs554RnCvOS5NI3KsWT5/view)

　pp3ファイルへのリンク
[7](https://drive.google.com/file/d/1qwslSsbXlM4Ns8A_2t_8_QSMWfsIuAR8/view)
　
似たような画像のノイズを除去する場合に、以下に説明する本例で使ったツールやその設定が参考になると思います。リンクからこの画像編集のpp3ファイルが入手出来ます。

　本説明を始める前に、とりあえずディテールタブの⟨ノイズ低減⟩だけで、背景の輝度及び色ノイズを除去してみました（輝度ノイズのスライダー値＝65、色ノイズ（マスター）のスライダー値＝20）。結果、確かに背景のノイズは除去されましたが、同時にカヤネズミのシャープ感が損なわれ、色も褪せてしまいました。では、この様な画像はどうやってノイズ除去を行えばいいのでしょうか？

手順の概要：

- 　2つのステップでノイズ除去を行います。最初のステップは、ディテールタブの⟨ノイズ低減⟩を使って背景のノイズを軽減することです。但し、同時に被写体（カヤネズミ）の詳細（特に目や尻尾）が失われてしまわないように控えめに行います。加えて：
  - 　ノイズを認識する人間の目のメカニズムは色の見えモデルに似ていて、同じノイズでも暗い背景より、グレーのような明るい背景の方が目立って見えます（特に色ノイズ）。この性質は、画像の明るい部分でも同じです。そこで、ノイズ低減と一緒にコントラストも調整することを奨めます。そうすることで、被写体を際立たせながら、ノイズを目立たなくすることが出来ます。

<!-- -->

- 　2番目のステップは、ローカル編集の機能を使ってノイズ除去の作用に差を付けることです。特に下記の5つの機能が有効です：

1.  　マスク機能を使い、被写体（カヤネズミと野菜）と背景のノイズ除去作用に差を付けます。
2.  　⟨ノイズ除去　色相イコライザ⟩を使い、被写体と背景の色の違いを利用して作用に差を付けます。
3.  　⟨スコープ⟩（つまり、ΔE）を使い、ΔEの大きさに応じて作用に差を付けます。
4.  　⟨詳細復元（輝度）⟩と"エッジ検出"の中の⟨輝度と色の詳細のしきい値⟩を使い作用に差を付けます。後者のスライダーは元画像とウェーブレットによるノイズ除去処理後の画像の違いをベースにしたノイズ除去（フーリエ変換）です。
5.  　非局所平均フィルタ（ノンローカルミーン）：これは目標とするピクセルと一定区画のピクセルの平均値の類似性をベースにしてノイズ除去を行うアルゴリズムです。これを使い、詳細や質感を持つ画像部分（カヤネズミや野菜）と均一な画像部分（背景）で作用に差を付けます。

- 　最後に、彩度とローカルコントラストなどを調整します。

　注意：上記の説明の目的は、あくまでノイズ除去の手順です。画像を美しく仕上げるには他の編集も必要でしょう。

###### 最初のステップ：ノイズ低減とコントラストの調整

　下のスクリーンショットは、ディテールタブの⟨ノイズ低減⟩で輝度及び色ノイズを補正（控えめ）した後に、ローカル編集タブの⟨シャドウ/ハイライト＆トーンイコライザ⟩で補正したものです。そこに"
ロック式カラーピッカー"をカヤネズミの目、毛、尻尾、及び野菜に配置します。

- 　新しいRT–スポットを、作成⁄追加します（タイプは画像全体を選択します）。⟨設定⟩パネルの"マスクと融合に関する設定"を開き、"輝度とカラーのマスクの背景色"のスライダーを0に設定します（この方が輝度値の変化が区別しやすくなります）。
- 　"現在のスポットに機能を追加"を使って、⟨シャドウ⁄ハイライト&トーンイコライザ⟩（機能水準は基本）をRT–スポットに追加し、コンボボックスの中の⟨イコライザ⟩を選択します。
- 　RT–スポットの中心円は背景のグレー部分に置きます。
- 　イコライザのスライダーを調整してベストな妥協点を探します。同時にディテールタブの"ノイズ低減"の2つのスライダーも使ってノイズを減らしています。表示されてはいませんが、輝度ノイズのスライダー値は4、色ノイズのスライダー値は6.5（調整法は⟨手動⟩、スライダーはマスター）です。

<div>

<figure>
<img src="/images/Mulot_first.jpg" title="Mulot_first.jpg" width="600" />
<figcaption>Mulot_first.jpg</figcaption>
</figure>

</ul>
</div>

###### 次のステップ：⟨ぼかし/質感＆ノイズ除去⟩を使う

- 　RT-スポットに⟨ぼかし⁄質感&ノイズ除去⟩機能を追加します。機能水準は〈高度〉を選びます。
- 　"ノイズ除去"のパネルを開き、その中の⟨輝度ノイズ除去⟩を使います。
- 　はじめは、調整の加減が分かり難いと思います。調整と効果の兼ね合いを知るために、一旦、カーブを大きく動かし、モードも"積極的"に変えて結果がどうなるか見るのがいいでしょう。調整の加減がつかめたら普通のモードに戻します。

　輝度ノイズ除去のカーブだけでなく、上記の"手順の概要"で紹介した5つの機能を使えば編集の幅が広がります。

　2番目の⟨ノイズ除去　色相イコライザ⟩を使ってみます：

- 　⟨スコープ⟩を100、"輝度マスクをベースにした詳細の復元"パネルの中の、⟨復元のしきい値⟩を1に設定し、他3つのスライダーはデフォルト値のままにしておきます。その上で、次の操作により画像がどの様に変化するか見ます：
- 　背景に該当する色相のノイズ除去を最大にして、カヤネズミの顔に該当する色相のノイズ除去は下げます（スクリーンショットの右下のカーブ）。
- 　⟨低い番手の色ノイズ（ウェーブレット）⟩を調整します。

<div>

<figure>
<img src="/images/Mulot_levelhue.jpg" title="Mulot_levelhue.jpg" width="600" />
<figcaption>Mulot_levelhue.jpg</figcaption>
</figure>

</ul>
</div>

　１番目のマスク機能を使ってみます：

- 　マスクを作成します。⟨ぼかし⁄質感&ノイズ除去⟩の⟨マスクと修正領域⟩を開きます。

　このマスクは背景と画像のその他の部分のノイズ除去に差を付けるために使われます。例えば、カヤネズミと野菜のノイズ除去に差を付けます。本例では、単純にL(L)カーブ、ガンマ、コントラストカーブを利用していますが、異なる画像の場合は、LC(H)カーブや、"構造のマスク"、"スムーズな半径"なども使う必要があるかもしれません。

<div>

<figure>
<img src="/images/Mulot_mask.jpg" title="Mulot_mask.jpg" width="600" />
<figcaption>Mulot_mask.jpg</figcaption>
</figure>

</ul>
</div>
<div>

<figure>
<img src="/images/Mulot_mask2.jpg" title="Mulot_mask2.jpg" width="600" />
<figcaption>Mulot_mask2.jpg</figcaption>
</figure>

</ul>
</div>

- 　"マスクを有効にする"オプションボックスにチェックを入れます。
- 　"輝度マスクをベースにした詳細の復元"パネルを拡張します。
- 　その中の⟨復元のしきい値⟩スライダーを調整して詳細を復元します。注意：この機能はスライダーが左端のデフォルト値（1.0）にある時は作用しません。しかし、一旦、スライダーを少しでも右に動かすと、細部とノイズが最大限復元されるように設計されていて、更にスライダーを右に移動させることで復元作用を弱めていきます。詳細復元とノイズ除去の兼ね合いを見極めながら妥協点を探ります。

　画像によっては、以下に示したような機能の調整が必要になるかもしれません。そのために、"輝度マスクをベースにした詳細の復元"のパネルの中の機能を使います：

- 　⟨暗い領域の輝度のしきい値⟩：設定されたしきい値を0％として、マスクによって定義されている最も暗い値（100％）まで、ノイズ除去作用が漸進的に強くなります。
- 　⟨明るい領域の輝度のしきい値⟩：設定されたしきい値を0％として、マスクによって定義されている最も明るい値（100％）まで、ノイズ除去作用が漸進的に弱くなります。本例では、輝度に従って、野菜部分のノイズが除去されます。
- 　⟨減衰の強さ⟩は作用の減衰の度合いを調整するスライダーです。
- 　⟨グレー領域の輝度ノイズ除去⟩と⟨グレー領域の色ノイズ除去⟩は、保護されているマスクの中間トーン領域で、必要であればノイズ除去を再作用させる場合に使います。

<div>

<figure>
<img src="/images/Mulot_recovery.jpg" title="Mulot_recovery.jpg" width="600" />
<figcaption>Mulot_recovery.jpg</figcaption>
</figure>

</ul>
</div>

　３番目の⟨スコープ⟩を使って作用に違いを付けてみます：　

- 　スコープを変えることでΔEに応じて作用に差が付くことを利用します。"マスクと修正領域"のコンボボックスから、"マスクと共に変更された領域を表示"、或いは"マスクなしで変更された領域を表示"を使えば、その変化を確認しやすくなります（使わなくても構いません）。本例では、⟨イコライザ　色相⟩を無効、"輝度マスクをベースにした詳細の復元"の中の⟨復元のしきい値⟩が1.0（従って、機能が無効の状態）になっています。スコープの値が50から100にかけて変化が大きいでしょう。

　４番目の2つのスライダー；⟨詳細復元（輝度）⟩と⟨輝度と色度の詳細のしきい値⟩を使ってみます：　

- 　⟨詳細復元（輝度）⟩を少しずつ増やします。
- 　並行して"輝度と色度の詳細のしきい値"も調節します。詳細が復元されるのが分かると思います。
- 　2つのアルゴリズムが使えます。内部マスクを使うものとラプラス作用素を使うものです。それぞれ特性を持っています。ラプラス作用素を使うアルゴリズムの方が作用に違いを付けられますが、応答はあまり漸進的ではありません。

　最後に非局所平均フィルタ（ノンローカルミーンフィルタ）を使ってみます。

- 　非局所平均フィルタとは、通常、目標ピクセルの近傍にあるピクセルの平均値を使ってノイズ除去を行うフィルタとは異なり、画像全体のピクセルの平均を使い、目標ピクセルとの類似性に合わせて作用に差を付けてノイズ除去を行います。このフィルタによるノイズ除去は通常のフィルタを使った場合に比べ、詳細が失われ難いと言われます。

<figure>
<img src="/images/mulot_nlmeans.jpg" title="mulot_nlmeans.jpg" width="600" />
<figcaption>mulot_nlmeans.jpg</figcaption>
</figure>

　このフィルタの使い方に慣れるために以下の手順を踏みます：

- 　ノイズ除去のモードを選ぶコンボボックスで、⟨非局所平均だけ⟩を選択します。
- 　マスクは無効にします。
- 　スコープの値を100にします。

　モジュール（⟨ぼかし/質感＆ノイズ除去⟨）の機能水準が"高度"であれば、次の5つのスライダーが表示されます。

- 　強さ
- 　ディテールの復元：画像の均質な部分と質感のある部分の基本的な選別を行います。高い値ほど、質感のある部分の復元に重点が置かれます。
- 　ガンマ：均質な部分と質感のある部分を精緻に選別します。値を下げるほど詳細や質感が見えてきます。
- 　区画サイズの最大値：被写体の大きさに対しての区画サイズを設定します。理論的には、ノイズが多い画像ほど、区画のサイズを大きくします。実際には、均質な部分と質感のある部分の境界でアーティファクトを最小限に留めるように設定します。

###### 最終調整　–　彩度とローカルコントラスト

　 　新しいRT–スポットを追加します。中心円をカヤネズミに配置します。
このRT–スポットに2つの機能を追加します：

- 　一つは⟨自然な彩度&ウォーム⁄クール⟩（機能水準は基本）
  - 　⟨自然な彩度⟩のスライダーを使って満足のいく彩度になるまで調整します。
- 　もう一つは、⟨ローカルコントラスト&ウェーブレット⟩（機能水準は高度）
  - 　"レベルによるコントラスト調整　ウェーブレット2"を使って、番手の低いレベルのコントラストを増やします。

<div>

<figure>
<img src="/images/Mulot_wav.jpg" title="Mulot_wav.jpg" width="600" />
<figcaption>Mulot_wav.jpg</figcaption>
</figure>

</ul>
</div>

###### その他の方法と機能

　
　本例の目的である、"画像の均質な部分と質感のある部分でノイズ除去の作用に差を付ける"ためには他の方法もあります：

- 　⟨ローカル編集⟩の⟨ぼかし⁄質感&ノイズ除去⟩を使います。
- 　"ぼかし＆ノイズ除去"パネルのコンボボックスの中にある⟨ガイド付きフィルタ⟩：⟨ディテール⟩のスライダーの値をマイナスにすることで、"輝度マスクをベースにした詳細の復元"と同じマスクを使って同じ処理を行います。
- 　⟨除外スポット⟩："画像全体"モードのRT–スポットで行った調整を除外スポットで囲まれた部分だけを調整前の状態に戻すことが出来ます。
- 　⟨ローカルコントラスト＆ウェーブレット⟩の"ピラミッド1の中の"レベルのぼかし"：これは画像の詳細レベルに応じてぼかしを施して差を付けます。

ノイズ除去機能の説明は"全般的知識"の"ノイズ低減"の中にもあります。

###### まとめ

　 　Andy
Astbury氏の写真のおかげで、画像の均質な部分と詳細のある部分で異なるノイズ除去を行うための5つの機能の使い方を説明できました。

- 　ノイズ除去　色相イコライザ　
- 　輝度マスクをベースにした詳細の復元
- 　スコープ - ΔE
- 　DCT（離散コサイン変換） - エッジ検出
- 　非局所平均（ノンローカルミーン）

　調整が難しい画像の場合は、これら5つの方法を駆使して正しいバランスを探る必要があるかもしれません。しかし、仕上がりは個人の好みなので一概には言えません。

　更に以下の様なケースもあり得ます：

- 　本例の画像では、背景が均質でしたが、画像によっては背景に詳細や異なる質感があり、同じような仕上がりにならないこともあるでしょう。
- 　本例の画像では、被写体と背景の色相が明らかに違っていましたが、画像によっては同じ色相が背景と被写体で混在していれば、調整が難しいでしょう。
- 　ΔEは色ノイズの影響を受けるので、色に関するノイズと詳細の区別が付きにくいことがあります。
- 　"エッジの検出"も高い輝度ノイズに影響を受けます。

#### 難し過ぎる？ウェーブレットを使う

##### 実例（諦めないで、思ったほど難しくない）

　下のスクリーンショットはメインの⟨露光量補正⟩を+1.5に増やして明るくしたものです。⟨トーンマッピング⟩を使って部分的な明暗の印象を更に調節します。手順を説明するのが目的なので、美的な要素は考慮していません。

<div>

<figure>
<img src="/images/Amsterdam15.jpg" title="Amsterdam15.jpg" width="600" />
<figcaption>Amsterdam15.jpg</figcaption>
</figure>

Rawファイルのリンク(RawTherapee - Creative Common Attribution-share
Alike
4.0)：[8](https://drive.google.com/file/d/1dJ5yiqF-XdLQdKizCDseUxHf34y4AKZ6/view?usp=sharing)

</ul>
</div>

##### ウェーブレットのトーンマッピングを使った編集

- 　全ての設定値がデフォルトであるところから始めます。
- 　⟨ローカルコントラスト&ウェーブレット⟩機能を追加します（機能水準は高度）。"全体の強さ"のスライダーの下にあるコンボボックスで⟨ウェーブレット⟩を選択し（デフォルトはアンシャープマスクになっています）、⟨ピラミッド2⟩のパネルを拡張します。
- 　⟨ローカルコントラスト&ウェーブレット⟩に備わっている⟨スコープ⟩の値を80にセットします。
- 　スクリーンショットに表示されているように、各数値を設定します。
- 　もちろん、効果の程は個人の好みなので、それに応じて設定を変えます。
- 　このトーンマッピングのアルゴリズムはRawTherapeeに備わっている他のトーンマッピングのアルゴリズム（⟨ダイナミックレンジの圧縮⟩に使っているFattal、⟨トーンマッピング⟩と⟨対数符号化⟩に使っているMantiuk）とは異なります。この⟨ウェーブレット⟩の専用アルゴリズムです。

<div>

<figure>
<img src="/images/Amsterdam15_wavtm1.jpg" title="Amsterdam15_wavtm1.jpg"
width="600" />
<figcaption>Amsterdam15_wavtm1.jpg</figcaption>
</figure>

</ul>
</div>

#### 質感を強める3つの方法

　実演を兼ねて3つの方法を使います：

- 　トーンマッピング (Mantiuk)
- 　レティネックス
- 　ウェーブレット

##### 準備 – 元画像（ベニス）

<div>

<figure>
<img src="/images/texture-normal1.jpg" title="texture-normal1.jpg"
width="600" />
<figcaption>texture-normal1.jpg</figcaption>
</figure>

Rawファイルへのリンク(Copyright Sébastien Guyader - Creative Common
Attribution-share Alike 4.0)：
[9](https://drive.google.com/file/d/1DASGpHfl_9RDRhbq2_JQVgypgKyrdiBk/view?usp=sharing)

</ul>
</div>

##### トーンマッピングを使う

　スクリーンショットの様にRT-スポットを作成し、"
現在のスポットに機能を追加"で⟨トーンマッピング⟩を選択します。

- 　"輝度の標準化"オプションを有効にします。これで編集画像の輝度の平均と分散が元画像のそれらと同じになります。
- 　機能水準を⟨高度⟩にして、⟨エッジ停止⟩と⟨スケール⟩を使って質感を調節します。

<div>

<figure>
<img src="/images/texture-tm1.jpg" title="texture-tm1.jpg" width="600" />
<figcaption>texture-tm1.jpg</figcaption>
</figure>

</ul>
</div>

##### レティネックスを使う

　RT-スポットの形状と配置は前項と同じですが、⟨トーンマッピング⟩の機能を無効にして、今度は⟨霞除去&レティネックス⟩を選択します。機能水準は⟨高度⟩です。各スライダーの設定値はスクリーンショットを参考にします。

- 　前項と同じく、"輝度の標準化"オプションを有効にします。
- 　この方法では、"高速フーリエ変換"を使うことが出来ます。

<div>

<figure>
<img src="/images/texture-reti1.jpg" title="texture-reti1.jpg" width="600" />
<figcaption>texture-reti1.jpg</figcaption>
</figure>

</ul>
</div>

##### ウェーブレットを使う

　引き続き前項と同じRT-スポットを使います。⟨霞除去&レティネックス⟩を無効にして、⟨ローカルコントラスト&ウェーブレット⟩を選択します。機能水準は⟨高度⟩です。コンボボックスで⟨ウェーブレット⟩を選び、⟨ピラミッド2⟩のパネルを拡張します。中段の"ウェーブレットのレベルを使ったトーンマッピング"のオプションを有効にします。

- 　"ウェーブレットのレベルによる圧縮"、"減衰応答"、"バランスのしきい値"、"残差画像の圧縮"を使います。各設定はスクリーンショットを参考にして下さい。
- 　上段の"レベルによるコントラスト"も使ってみます。
- 　下段の"方向によるコントラスト"も使ってみます。
- 　或いは、これらを併用します。

<div>

<figure>
<img src="/images/texture-wav1.jpg" title="texture-wav1.jpg" width="600" />
<figcaption>texture-wav1.jpg</figcaption>
</figure>

</ul>
</div>

#### ブレンドモードを使ったスポット（レイヤー）の融合

　⟨色と明るさ⟩（機能水準は⟨高度⟩）の中の"ファイルの融合"を使えば、レイヤーの融合効果を真似することが出来ます。各RT-スポットをレイヤーと見なすことが出来るからです。最大2つのRT-スポットを元画像に融合することが出来ます。

- 　初めのレイヤーを⟨オリジナル⟩と呼ぶことにします。その画像データはローカル編集の調整を全く行っていない画像のものと同じです（⟨除外スポット⟩を適用した場合と同じデータ）。
- 　RT-スポットを相互に重ね合わせる場合（例えばRT-スポットが6つある時）：
  - 　現在のRT-スポットが6番目のものであれば、"ファイルの融合"機能はコンボボックスの中の選択に応じて、6番目のスポットを、5番目のスポット（⟨前のスポット⟩）、或いは⟨オリジナル⟩（元データファイル）、または色が定義された⟨背景⟩、と融合させます。
  - 　現在のスポットが6つの内の3番目であれば、"ファイルの融合"は、現在のスポットと2番目のスポット（⟨前のスポット⟩）、或いは⟨オリジナル⟩（元データファイル）、または色が定義された⟨背景⟩の何れかと融合させます。
  - 　融合のモードは、Photoshop©の融合モード（通常、差異、。。。ソフトライト（レガシー）、オーバーレイなど）から着想したもので、21種類の組み合わせが可能です。
  - 　各融合モードで、不透明度、ΔE、⟨コントラストのしきい値⟩を変える（⟨背景⟩の場合を除く）ことが出来ます。
  - 　⟨色と明るさ⟩に備わっている⟨階調フィルタ⟩は融合したファイルにも使えます。

　本例は、この機能を使ってぼかしを施します。

##### 準備

　RT-スポットの設定はこれまでの例と同じです。⟨ぼかし/質感&ノイズ除去⟩の機能を追加します。機能水準は⟨高度⟩です。

- 　RT-スポットを⟨インバース⟩モードに設定します（⟨ぼかし&ノイズ⟩のパネルを拡張するとチェックボックスが表示されますので、それにチェックを入れます）。
- 　目標とする効果に応じて⟨スコープ⟩を90、或いは100に設定します。
- 　⟨半径⟩を高い値に設定します（2000以上にして"ƒ　常に高速フーリエ変換を使う"オプションにチェック入れます）。ぼかしのモード（パネルの最下段）は⟨輝度と色度⟩にします。

<div>

<figure>
<img src="/images/mergeblurinv_2.jpg" title="mergeblurinv_2.jpg" width="600" />
<figcaption>mergeblurinv_2.jpg</figcaption>
</figure>

Rawファイルへのリンク(RawTherapee - Creative Common Attribution-share
Alike 4.0)
[10](https://drive.google.com/file/d/1dJ5yiqF-XdLQdKizCDseUxHf34y4AKZ6/view)

</ul>
</div>

##### 2番目のRT-スポットを作成

　2つ目のRT-スポットを作成し、⟨色と明るさ⟩機能を追加します。機能の水準は⟨高度⟩にします。

- 　"カラー機能のスコープ"を100にします。

<div>

<figure>
<img src="/images/Mergetwo1.jpg" title="Mergetwo1.jpg" width="600" />
<figcaption>Mergetwo1.jpg</figcaption>
</figure>

</ul>
</div>

##### 初めの融合-標準モードを使う

- 　⟨色と明るさ⟩の"ファイルの融合"パネルを拡張します。
- 　コンボボックスが表示されます。デフォルトでは⟨なし⟩が表示されています、他は：
  - 　⟨オリジナル⟩：未調整のRT-スポットデータと融合させるオプションです。
  - 　⟨前のスポット⟩：前のRT-スポットと融合させるオプションです（前のスポットがない場合はオリジナルと融合します）。
  - 　⟨背景⟩：色が定義された背景と融合させるオプションです。
- 　3つの中の何れかを選択すると、融合モードを選ぶコンボボックスが表示されるので、そのドロップダウンリストの中から好みのモードを選択し、その下にある"背景と融合"、"不透明度"、"コントラストのしきい値"のスライダーを調整します。
- 　⟨色と明るさ⟩の他の機能（明るさ、コントラスト、彩度）も使えます。

<div>

<figure>
<img src="/images/Mergeorignrmal1.jpg" title="Mergeorignrmal1.jpg"
width="600" />
<figcaption>Mergeorignrmal1.jpg</figcaption>
</figure>

</ul>
</div>

##### 2つ目の融合に ソフトライトのブレンドモードを使う

　融合モードの中から"ソフトライト"を試します（或いは、他のモードでも）。

- 　設定（例、⟨不透明度⟩）を調整し、モードによる違いを観察します。
- 　⟨オリジナル⟩を⟨前のスポット⟩に置き換えて、違いを観察します。

<div>

<figure>
<img src="/images/Mergeorigsoftlight1.jpg" title="Mergeorigsoftlight1.jpg"
width="600" />
<figcaption>Mergeorigsoftlight1.jpg</figcaption>
</figure>

</ul>
</div>

#### 単純なマスクを使って色の選択を増やす

##### 準備

- 　トルコのヒエラポリス‐パムッカレの画像を使って解説します。
- 　補正が難しい画像です。空の色と山の色の差が小さく、更に山肌に不規則な部分が多々あります。
- 　基本的な設定は前例とほぼ同じですが、⟨カラー機能のスコープ⟩は40に設定しました。作用の影響が山肌以外の部分にも及んでしまうかもしれませんが、山肌の補正を適切に行うには、ある程度妥協が必要です。
- 　調整結果を分かり易くするため、敢えて輝度（明度）と色度の調整を強くしています（本項の説明は綺麗に仕上げることが目的ではないため）。空の色が影響を受けないように注意します。
- 　目的のために⟨除外スポット⟩
  を使うことも出来ますが（或いは、将来的にインターフェイスでポリゴンを使えるようにする）、ここでは単純なマスクを使う方法を解説します。マスクに関して幾つかのカーブを使う、或いはRT-スポットを複製して複数のマスクを使うことも出来るでしょう。
- 　⟨ローカル編集⟩には2種類のマスクがあります：
  - 　一つは、画像に加えたり、画像から差し引いたりしないマスクです。ΔEによる形状検出を向上させることが目的です。
  - 　もう一つは、画像にマスクを加えたり、画像からマスクを差し引いたりして得られる結果の違いを利用するためのマスクです。
  - 　本例では初めのマスクを使います。

<div>

<figure>
<img src="/images/Masksimpleprepa1.jpg" title="Masksimpleprepa1.jpg"
width="600" />
<figcaption>Masksimpleprepa1.jpg</figcaption>
</figure>

Rawファイルのリンク(Jacques Desmis - Creative Commons Attribution-Share
Alike 4.0):
[11](https://drive.google.com/file/d/1azCxu1midw6dcuN7SbvbAiJH4pxX5BTA/view?usp=sharing)

</ul>
</div>

##### 初めに、明度と色度を大きく上げる

- 　結果:山肌の色の補正が空の色にまで影響してしまいました。この様な結果にならないようにします。

<div>

<figure>
<img src="/images/Masksimplelum250chro1401.jpg"
title="Masksimplelum250chro1401.jpg" width="600" />
<figcaption>Masksimplelum250chro1401.jpg</figcaption>
</figure>

</ul>
</div>

##### 単純なマスクを作る

- 　3つのカーブL、C、Hのうち1つを使います。本例ではLを使います。
- 　スクリーンショットのL(L)カーブを見て下さい。カーブの節目がグレーの濃さが変わる境界の所にあります。この"境界"は、RT-スポットの3つの参考値（色度、輝度、色相）に相当するもので、C(C)、LC(H)、全てのカーブにも共通します。
- 　形状検出を改善するためだけなので⟨ブレンド⟩のスライダーの使用は避けます。
- 　"マスクと修正領域"の"修正された領域をマスクと共に表示"を使うことも出来ます。

<div>

<figure>
<img src="/images/Masksimpleshow1.jpg" title="Masksimpleshow1.jpg"
width="600" />
<figcaption>Masksimpleshow1.jpg</figcaption>
</figure>

</ul>
</div>

##### 仕上げの調整

- 　"マスクと修正領域"でコンボボックスの中から"調整及び修正した画像"を選択します。
- 　"マスクを有効にする"にチェックを入れます。
- 　必要に応じて、マスクツールの"スムーズな半径"を調節します。
- 　必要に応じて、マスクツールの"コントラストカーブ"L(L)を使ってレタッチを行います。
- 　機能水準を⟨高度⟩にして、マスクツールの"スムーズな半径"の代わりに⟨ガンマ⟩や⟨スロープ⟩、⟨ラプラス変換のしきい値⟩を調整してみます。
- 　ここまで十分な結果とは言えませんが、本例はマスクがどの様に働くか、知る方を優先しています。

　マスクを使った調節の効果を向上させる方法が2つあります：

- 　RT-スポットの複製を使う：RT-スポットの複製を作り、初めのRT-スポットと同じ場所に置きます。但し、その中心円の位置は少しだけズラします。そうすることで2番目のマスクが最初のマスクの不完全性を補ってくれます。更に、この方法では必要に応じて2番目のRT-スポットで、一定のパラメータ（本例では明度と色度）を調整することで、より均質な結果を得ることが出来ます。
- 　別の機能に備わったマスクを使う：マスク機能が備わっている別な機能を有効にして、その中のマスクを活用します。この場合、同じRT-スポットが使われることになるのでその参考値（輝度、色度、色相）やΔE（スコープ）も同じなるので、微妙な調整が可能になります。

　ΔEの考慮について：

- 　⟨ローカル編集⟩の中核機能の一つ、例えば、ΔEを考慮する⟨スコープ⟩を無効にすることが出来ます。そうすることでスコープを意識せずに、マスクの調節だけに専念出来ます。この場合はスコープを100に設定します。スコープの機能が失われるので、⟨ブレンド⟩の機能だけでマスクと画像を結び付けることが出来ます。
- 　"マスクと修正領域"の⟨マスクツール⟩（コントラストカーブ、色度、ガンマなど）を使う場合、⟨設定⟩の"マスクと融合に関する設定"、例えば"ΔE画像のマスク"、は作用が敏感なので注意が必要です。

<div>

<figure>
<img src="/images/Masksimple1.jpg" title="Masksimple1.jpg" width="600" />
<figcaption>Masksimple1.jpg</figcaption>
</figure>

</ul>
</div>

##### 輝度マスクをベースにした詳細の復元を使った仕上げ

　RawTherapeeでマスクを使うことには、通常、通常2つの目的があります：

- 　形状検出の向上を図る（ブレンドは使わない）
- 　マスクを画像から差し引いたり、画像に加えたりして形状検出の向上を図る（ブレンドを使う）

本例では、⟨色と明るさ⟩で調整を行った画像に対し、マスクの明るい部分と暗い分を使って選択を行い、以下の様な条件で元画像と結びつけます：

- 　マスク内の暗い、及び黒い領域は限りなく元画像に近い状態にする。
- 　マスク内の非常に明るい、及び白い領域は限りなく元画像に近い状態にする。
- 　上記2つの間の領域に関しては、⟨色と明るさ⟩で行った調整をそのまま反映する。

　暗い領域と明るい領域の間の調整は、"
輝度マスクをベースにした詳細の復元"のスライダーで行う。

　注意：
　⟨ロック式カラーピッカー⟩のL\*a\*b\*値が元画像の実値と同じようになることを確かめるには、⟨設定⟩の"マスクと融合に関する設定"パネルの中の"背景の色/輝度のマスク"のスライダーを0にする必要があります。

　以下のスクリーンショットは、“マスクなしで変更した画像を表示”を使って上記の調整結果を表示しています。
　 　pp3へのリンク：

<div>

[12](https://drive.google.com/file/d/1BWpBUd5qjpDHv_stdF5ord8qFGhxC0J0/view?usp=sharing)
<img src="/images/mask_recov0.jpg" title="mask_recov0.jpg" width="600"
alt="mask_recov0.jpg" />

</ul>
</div>

###### マスクの作成

　"マスクと修正領域"の中の⟨ぼかしマスク⟩を"コントラストのしきい値"と⟨半径⟩で調節します。この調節で、山肌の右側部分のグレー値が上がり、⟨色と明るさ⟩の調整効果が和らぎます。

<div>

<figure>
<img src="/images/Mask_recov.jpg" title="Mask_recov.jpg" width="600" />
<figcaption>Mask_recov.jpg</figcaption>
</figure>

</ul>
</div>

##### 元画像の特徴を復元

- 　"マスクと修正領域"の"マスクを有効にする"オプションにチェックを入れます。
- 　"輝度マスクをベースにした詳細の復元"のパネルを拡張します。
- 　"復元のしきい値"をセットします：2に近いほど、マスクの暗い・非常に明るい部分のより広範囲が元画像に近い状態になります。
- 　"暗い領域の輝度のしきい値"と"明るい領域の輝度のしきい値"のスライダーを使って、画像のどの部分を含めるか、除くか調節します。設定された値（本例では、暗い領域が32.1、明るい領域が85）より下、上の部分でマスクの効果が漸進的になります。
- 　必要に応じて"減衰"を調節し、効果の減衰率を変えます。
- 　マスクと修正領域を無効にしてみます：マスクを有効にするのチェックを外します。
- 　再び、マスクと修正領域を有効にして、今度は復元のしきい値を1に再設定して効果の違いをみます。
- 　“復元”の4つの設定だけでなく、マスクの他の設定も変えてみます。

<div>

<figure>
<img src="/images/Mask_recovend.jpg" title="Mask_recovend.jpg" width="600" />
<figcaption>Mask_recovend.jpg</figcaption>
</figure>

</ul>
</div>

#### マスクにソルト&ペッパーノイズが見られる場合の対処

　マスクの作成でLC(h)カーブを使った時に、マスクの画像が白黒の点（ソルト&ペッパーノイズ）で覆われ、マスクが正しく働かなくなることがあります。

<figure>
<img src="/images/masknoisechroma.jpg" title="masknoisechroma.jpg"
width="600" />
<figcaption>masknoisechroma.jpg</figcaption>
</figure>

##### 回復

　メインの⟨設定⟩から"全ての設定項目を表示"→"マスクと融合に関する設定"に進むと、"マスクの色ノイズ除去"というスライダーが表示されます。これを使ってノイズを軽減します。

<figure>
<img src="/images/masknoisechromaden.jpg" title="masknoisechromaden.jpg"
width="600" />
<figcaption>masknoisechromaden.jpg</figcaption>
</figure>

##### 色ノイズもマスクの作用に影響する

　例えば、マスクの作成でCカーブを使うと、マスクを元画像と融合した際に、グレーの斑模様のアーティファクトが現れることがあります。これは色ノイズが原因である場合が多いので、前述と同じスライダーを使って軽減します。

#### オリジナルスポットとマスクをブレンドする

　マスクを使って仏塔の画像の遠近感（レリーフ）を改善します。

##### 準備

- 　画像の遠近感を高めるには、⟨詳細レベルによるコントラスト調整⟩や⟨ウェーブレットピラミッド⟩を使うことも出来ますが、マスク機能を学ぶため、"マスクと修正領域"の"ブレンド"を使う方法を解説します。
- 　⟨色と明るさ⟩の機能を追加し、機能水準を⟨高度⟩にします。"カラー機能のスコープ"は40です。

<div>

<figure>
<img src="/images/Maskblendprepa1.jpg" title="Maskblendprepa1.jpg"
width="600" />
<figcaption>Maskblendprepa1.jpg</figcaption>
</figure>

Raw画像へのリンク(Creative Commons Attribution-Share Alike 4.0):
[13](https://drive.google.com/file/d/1GdqejdnbW1kJFNY6y9sdQDlF2rCEGMCu/view?usp=sharing)

</ul>
</div>

　

##### マスクの設定

- 　2つの機能を使います：
  - 　色を選択するためのLC(H)カーブ
  - 　⟨ぼかしのマスク⟩の"コントラストのしきい値"と"ぼかしの半径"
- 　⟨FFTW⟩のオプションを有効にします（チェックを入れる）。処理時間は増えますが、その分調整の質が上がります。無効の場合、半径の最大値は100までですが、有効にすれば1000まで上げられます。

<div>

<figure>
<img src="/images/Maskblendshow2.jpg" title="Maskblendshow2.jpg" width="600" />
<figcaption>Maskblendshow2.jpg</figcaption>
</figure>

</ul>
</div>

###### 操作手順

- 　"マスクを有効にする"にチェックを入れます。
- 　⟨ブレンド⟩のスライダーを好みに合わせて調整します。
- 　必要であれば、⟨マスクのツール⟩の"スムーズな半径"も調整します。
- 　⟨色と明るさ⟩の、マスクに関係しない機能（明度やコントラストなど）を調整している場合は、それらの調整は"スポットの構造"スライダーの影響を受けます。

　　起こりうる問題

- 　ここで"マスク：LCｈと構造"のコンボボックスで"調整及び修正した画像"を選択すると、画像に主体色が現れていることが分かります。これはLC(H)カーブと"ブレンド"を併用したことが原因です。
  - 　現にカーブのモードを"線形"に変えると、この主体色がなくなります。
  - 　この様な問題を避けるために、ブレンドの使用に関係なく、同一のRT-スポットで複数のマスク設定を行わないようにします。
  - 　複数の設定が必要な場合は、前述の"単純なマスクの使い方"の様に、RT-スポットの複製を作り、一方でブレンドを使い、もう一方のRT-スポットで異なる設定（或いは、異なるブレンド値を使う）を行ないます。或いは、他の機能に備わっているマスクを使います。

##### 適切な処理手順

　2つのスポットを使って処理します：

- 　初めのRT-スポットではLC(H)カーブだけを使って調整します。
- 　2番目のRT-スポットは画像の構造を変えるために使います。

###### 画像の構造を変える

　機能水準を⟨高度⟩にすると画像の構造を変える複数の機能が表示されます。

- 　⟨コントラストしきい値⟩と⟨半径⟩を調整する⟨ぼかしマスク⟩
- 　画像の構造に直接作用する⟨構造マスク⟩
- 　これら2つの機能を使う時は、LC(H)カーブを無効（或いは未使用）にします。
- 　但し、LC(H)カーブを使いたい場合、L(L)カーブを関連付けておくことは可能です。
- 　ぼかしマスクと構造マスクは関連付けておくことが出来ます。
- 　⟨ウェーブレット⟩に備わっている機能もL(L)カーブと関連付けておくことが出来ます。ローカルコントラストの様な効果が得られます。

　以下の手順も忘れないように：

- 　"マスクを有効にする"にチェックを入れる
- 　好みに合わせた⟨ブレンド⟩の設定
- 　必要であれば、⟨マスクツール⟩の"スムーズな半径"の調整

<div>

<figure>
<img src="/images/Maskblend2.jpg" title="Maskblend2.jpg" width="600" />
<figcaption>Maskblend2.jpg</figcaption>
</figure>

</ul>
</div>

#### 共通のカラーマスクの使い方 – 2つのRT-スポットの融合の方法

　このマスクの働きは⟨ローカル編集⟩の他の機能に付属しているマスクと同じではありません。例えば⟨色と明るさ⟩のマスクの様に既存の機能の動作の変更には使えませんが、それ自体が一つの機能として働きます。画像のコントラスト、輝度、色度、または質感を変えることが出来ます。

- 　このマスクはC(C)、L(L)、LC(H)、の3つのカーブで構成（機能水準が⟨高度⟩であれば、更に⟨構造マスク⟩と⟨ぼかしマスク⟩が追加されます）され、元画像と比べた時の色や構造に違いを持たせる働きをします。
- 　これらの"違い"は、⟨色と明るさ⟩の調整で変化する、⟨明るさ⟩、或いは⟨色度”⟩の違いに似ています。
- 　マスク画像と元画像の色の違いは、ΔEと境界の階調調整のパラメータで考慮されます。
- 　もちろん、同じRT-スポットの中で他の機能と関連付けて使うことが出来ます。
- 　以下、単純な例を使って、この機能の働きを説明します。

##### 準備

　初期の設定はこれまでの例と概ね変わりません。

- 　⟨共通のカラーマスク⟩を追加します。機能水準は⟨標準⟩です。この機能の効果を見せるのが目的なので、他の機能は追加しません。
- 　マスクを作成します。手順説明を単純化するために、RT-スポットの参考値を考慮するのは、C(C)とL(L)のカーブ2つだけです。
- 　注意：2つのスライダー、"輝度マスクを強める/弱める"と"色度マスクを強める/弱める"は、効果が弱く分かり難いので、デフォルト値を敢えて0にしていません。両方とも-10に設定しています。

<div>

<figure>
<img src="/images/Common-maskprepa1.jpg" title="Common-maskprepa1.jpg"
width="600" />
<figcaption>Common-maskprepa1.jpg</figcaption>
</figure>

Raw画像へのリンク(Creative Commons Attribution-Share Alike 4.0)：
[14](https://drive.google.com/file/d/1aWvYbW-rDPQaLWoRzbK5HAcz9dU0GHFU/view?usp=sharing)

</ul>
</div>

##### 輝度のマスク

　このカーブは輝度を少し変化させます。

- 　カーブの頂点が明るいグレーと濃いグレーの境目に位置しています。⟨輝度マスク⟩がRT-スポットの参考値と一致しているポイントです。

<div>

<figure>
<img src="/images/Common-mask-showL1.jpg" title="Common-mask-showL1.jpg"
width="600" />
<figcaption>Common-mask-showL1.jpg</figcaption>
</figure>

</ul>
</div>

##### 色度のマスク

- 　カーブの頂点が明るいグレーと濃いグレーの境目に位置しています。⟨色度マスク⟩がRT-スポットの基準値と一致しているポイントです。

<div>

<figure>
<img src="/images/Common-mask-showC1.jpg" title="Common-mask-showC1.jpg"
width="600" />
<figcaption>Common-mask-showC1.jpg</figcaption>
</figure>

</ul>
</div>

##### プレビューΔE

　ここで、"マスクを加えた画像"と元画像の間のΔEを調整します。

- 　⟨スコープ⟩を上げたり、下げたりしてみて下さい（ここで言うスコープは、⟨共通のマスク⟩の中のスコープのことです）。
- 　⟨設定⟩の、"形状検出"のパラメータを変えてみます："ΔEのスコープのしきい値"、"ΔEの減衰"、"バランス　ab-L（ΔE）"、"バランス　C-H（ΔE）"

<div>

<figure>
<img src="/images/Common-mask-previewdE1.jpg" title="Common-mask-previewdE1.jpg"
width="600" />
<figcaption>Common-mask-previewdE1.jpg</figcaption>
</figure>

</ul>
</div>

##### 修正領域を表示

　マスクと修正領域の表示のコンボボックスから、"修正された領域をマスクと共に表示"を選びます。

- 　"輝度マスクを強める/弱める"と"色度マスクを強める/弱める"を調整してみて下さい（これらスライダーは"不透明度"の機能とも言えます）。

<div>

<figure>
<img src="/images/Common-mask-modif1.jpg" title="Common-mask-modif1.jpg"
width="600" />
<figcaption>Common-mask-modif1.jpg</figcaption>
</figure>

</ul>
</div>

##### 結果

　その他の調整: 　

- 　⟨共通のカラーマスク⟩の中にある⟨スコープ⟩の調整
- 　⟨マスクツール⟩の"スムーズな半径"を調整します。これは、３つの異なるカーブ；C(C),、L(L)、LC(H)、で生成されたマスクにより発生したアーティファクトを軽減するために使います。
- 　マスクツールの⟨色度⟩を調整。
- 　マスクツールの"コントラストカーブ"を調整。
- 　ローカル編集モジュールの先頭にある⟨設定⟩の"全ての設定項目を表示"オプションを有効にします。１番下にある"マスクと融合に関する設定"のパネルを拡張し、その中の"スコープ（ΔE画像のマスク）"を調整します。このスライダーはマスクに作用するもので、マスクのΔEとRT-スポットの基準値の差を考慮します。⟨共通のカラーマスク⟩の先頭にあるスコープとは働きが異なります。こちらは元画像と生成されたマスクとの差に作用します。

　機能水準を⟨高度⟩に切り替えます：

- 　⟨ソフトな半径⟩を調整して、輝度或いは色度マスクを強めた時の元画像との差により発生したアーティファクトを軽減します。機能水準が標準の場合でもデフォルト値は１に設定されています。マスクが無効の場合でも若干の変化が生じます。変化の確認は"調整及び修正した画像"で出来ます。
- 　マスクツールの"ラプラス変換のしきい値"を動かし、"スムーズな半径"との効果の違いを見ます。
- 　マスクツールの⟨ガンマ⟩と⟨スロープ⟩を調整してみます。
- 　画像の構造を以下の機能を使って変えてみます：⟨構造マスク⟩、⟨ぼかしマスク⟩、マスクツールの"ローカルコントラスト"
- 　⟨階調フィルタのマスク⟩の効果を試します。

<div>

<figure>
<img src="/images/Common-mask1.jpg" title="Common-mask1.jpg" width="600" />
<figcaption>Common-mask1.jpg</figcaption>
</figure>

</ul>
</div>

　次に、色と明るさモジュールの中の“ファイルの融合”を使って、“共通のカラーマスク”で調整した画像を更に仕上げます。

##### 新しいRT-スポットを追加、色と明るさを使う

　あくまで機能を学ぶための説明なので、画像の仕上がりは考慮していません。21通りの組み合わせの中から3つを選んで、融合モードを説明します。

- 　⟨作成/追加⟩で新たにRT-スポットを作成します。
- 　⟨色と明るさ⟩を追加し、機能水準は⟨高度⟩にします。
- 　⟨プレビューΔE⟩を使って、⟨カラー機能のスコープ⟩を適切に設定します。
- 　3つのスライダーを使って、輝度、コントラスト、色度を上げます。

<div>

<figure>
<img src="/images/Common-color1.jpg" title="Common-color1.jpg" width="600" />
<figcaption>Common-color1.jpg</figcaption>
</figure>

</ul>
</div>

##### 融合を準備

　"ファイルの融合"パネルを拡張し、コンボボックスの中から"前のRT-スポット"を選択し、このRT-スポットを前述の⟨共通のカラーマスク⟩で調整したRT-スポットと融合します。

<div>

<figure>
<img src="/images/Common-color-prepa1.jpg" title="Common-color-prepa1.jpg"
width="600" />
<figcaption>Common-color-prepa1.jpg</figcaption>
</figure>

</ul>
</div>

##### 標準モードで融合

- 　前述のコンボボックスで"なし"以外を選択した場合、別なコンボボックスが表示されます。その中から、⟨標準⟩を選びます。
- 　任意に3つの設定を行いました："背景の融合"=54.2（2つのRT-スポットのΔEが考慮されます)。⟨不透明度⟩=54.2（各RT-スポット）。⟨コントラストのしきい値⟩=12.5
  （画像の均一な部分と質感のある部分の違いを考慮します）。
- 　背景の融合と不透明度を2つのRT-スポットで同じ値に設定していますが、異なる値でも構いません。

<div>

<figure>
<img src="/images/Common-color-normal1.jpg" title="Common-color-normal1.jpg"
width="600" />
<figcaption>Common-color-normal1.jpg</figcaption>
</figure>

</ul>
</div>

##### ソフトライトモードで融合

　上記の融合モードを⟨ソフトライト（レガシー）⟩に変えてみます。

<div>

<figure>
<img src="/images/Common-color-softphot1.jpg" title="Common-color-softphot1.jpg"
width="600" />
<figcaption>Common-color-softphot1.jpg</figcaption>
</figure>

</ul>
</div>

##### 色の焼き込みモードで融合

- 　今度は、融合モードを⟨色の焼き込み⟩に変えてみます。
- 　モードの違いによる明るさや色の変化を確認して下さい。

<div>

<figure>
<img src="/images/Common-color-colburn1.jpg" title="Common-color-colburn1.jpg"
width="600" />
<figcaption>Common-color-colburn1.jpg</figcaption>
</figure>

</ul>
</div>

##### 追加情報

　⟨共通のカラーマスク⟩は何枚でも作成できます。単純にマスクを複製し、似たような設定をして前のマスクの近くにに置きます。

　C(C), L(L), LC(H) 、カーブに関する幾つかの重要なポイント：

- 　これらのカーブはマスクを作成するために使われます。
- 　各カーブで暗いグレーと明るいグレーの堺はRT-スポットの参考値（輝度、色度、色相）に一致しています。
- 　左のグラフ：ΔEによる選別（本例では輝度L）が良い部分にカーブの節点があります。
- 　中央のグラフ：マスクに使われる色相はRT-スポットの参考値の色相と同じです（カーブの節点が色相による選別の頂点にあります）。この部分でカーブを下に下げると、選別された色相（カーブがLであれば輝度に、Cであれば色度）に適用された全ての調整が徐々にマスクに覆われます（調整効果が弱まる）。
- 　右のグラフ：カーブの節点がマスクの色相による選別とRT-スポットの参考値と一致しない部分にあります。ここでカーブを下げると、特定の色相に対する全ての調整が徐々にマスクで覆われます。

　留意として：LC(H)カーブを組み合わせている時の調整の効果は、Lchの色相環を参考にすれば理解しやすいと思います。例えば、Lカーブを上下に移動すると色度も変化します。

<div>

<figure>
<img src="/images/Mask-curve.jpg" title="Mask-curve.jpg" width="600" />
<figcaption>Mask-curve.jpg</figcaption>
</figure>

</ul>
</div>

- 　この項の説明では主体色がマゼンタ（花）とグリーン（葉）の2つの単純な画像を使いましたが、通常の画像の様に、色、輝度、色度の変化がもっと多い場合は、より入念なマスク作成が必要でしょう。
- 　本説明ではRT-スポットの参考値を使うという、“ローカル編集”の基本を忠実に守りました。カーブだけを使うことも出来ますが、結果は全く異なるものになるでしょう。
- 　同様に、融合においてもマスクに関して同じ色の範囲を使いました。2つ目のRT-スポットを追加して、葉の上に置く、という方法を取ることも出来ましたが、花の色の変化が少ない結果となるでしょう。

#### 露出不足のポートレート、肌の印象を補正

　女性のポートレート画像を、⟨ローカル編集⟩の機能を使って補正します：

- 　⟨露光量⟩を増やして暗い印象を軽減します（メインの⟨露光補正⟩）。
- 　⟨詳細レベルによるコントラスト調整⟩を使って、肌の印象をソフトにし、⟨明瞭⟩を使って顔を明るくします。
- 　⟨階調フィルタ⟩で、顔の右側部分の陰を軽減します。
- 　3つの⟨除外スポット⟩を使って、調整作用が目と口に及ばないようにします。
- 　LC(H)のマスクを使って、髪の毛の印象がソフトになるのを避けます（つまり、詳細レベルによるコントラスト調整の効果が髪の毛に及ばないようにします）。
- 　調整前と調整後を比較します。
- 　留意：上記の調整はあくまで目安です。ユーザーの好みで調整を決めます。

<div>

<figure>
<img src="/images/Mairi.jpg" title="Mairi.jpg" width="600" />
<figcaption>Mairi.jpg</figcaption>
</figure>

Raw画像へのリンク(Copyright Pat David - Creative Commons
Attribution-Share Alike 4.0)：
[15](https://drive.google.com/file/d/1m4UBhES2AVe_sJNqMVSz5jA-Qg-s7LHt/view?usp=sharing)

</ul>
</div>

##### 露光量を増やす

- 　露光量を+0.5にします。
- 　ここで、RT-スポットを使い、露光量補正の効果を画像全体ではなく、特定領域に制限することも出来ます。

<div>

<figure>
<img src="/images/Mairiexp05.jpg" title="Mairiexp05.jpg" width="600" />
<figcaption>Mairiexp05.jpg</figcaption>
</figure>

</ul>
</div>

##### 詳細レベルによるコントラスト調整（CBDL）を使う

- 　RT-スポットを作成します。"スポットサイズ"は大きくします。47
- 　⟨詳細レベルによるコントラスト調整⟩をスポットに追加し、レベル4から０を徐々に下げます。
- 　⟨残差画像⟩の明瞭を60に設定します。
- 　その2つ下にある⟨スコープ⟩の値を40に設定します。

<div>

<figure>
<img src="/images/Mairi-cbdl_1.jpg" title="Mairi-cbdl_1.jpg" width="600" />
<figcaption>Mairi-cbdl_1.jpg</figcaption>
</figure>

</ul>
</div>

##### 諧調フィルタを使う

- 　新しいRT-スポットを追加し、⟨色と明るさ⟩を追加します。
- 　⟨階調フィルタ⟩のパネルを開き : ⟨輝度の諧調の強さ⟩=
  -0.6、⟨階調フィルタの角度⟩=5に設定します。
- 　機能水準を高度にすれば、⟨色度の階調の強さ⟩を調整することも出来ます。

<div>

<figure>
<img src="/images/Mairi-grad1.jpg" title="Mairi-grad1.jpg" width="600" />
<figcaption>Mairi-grad1.jpg</figcaption>
</figure>

</ul>
</div>

##### 目と唇を除外

- 　新たに3つのRT-スポットを追加し、"スポットのモード"を除外にして目と唇に配置します。
- 　除外スポットの中の⟨スコープ⟩を好みに合わせて設定します。

<div>

<figure>
<img src="/images/Mairi-excluding1.jpg" title="Mairi-excluding1.jpg"
width="600" />
<figcaption>Mairi-excluding1.jpg</figcaption>
</figure>

</ul>
</div>

##### 髪への影響をマスクで除外

- 　初めに作成したRT-スポットに戻ります。
- 　"マスクと修正領域"のパネルを拡張します。
- 　コンボボックスの中から"マスクの表示"を選択します。
- 　LC(H)カーブを使います。
- 　肌の色がマスクで覆われているか確認します（薄いグレーと濃いグレーの境がその部分です）。
- 　スクリーンショットの様にLC(H)カーブを下げます。
- 　⟨マスクツール⟩の中の"ソフトな半径"を調整します。
- 　必要に応じて⟨ガンマ⟩や⟨スロープ⟩、または⟨コントラストカーブ⟩を調整します。

<div>

<figure>
<img src="/images/Mairi-mask1.jpg" title="Mairi-mask1.jpg" width="600" />
<figcaption>Mairi-mask1.jpg</figcaption>
</figure>

</ul>
</div>

##### 結果

- 　上記のコンボボックスで"調整及び修正した画像"を選択します。
- 　"マスクを有効にする"オプションにチェックを入れます。

<div>

<figure>
<img src="/images/Mairi-fin1.jpg" title="Mairi-fin1.jpg" width="600" />
<figcaption>Mairi-fin1.jpg</figcaption>
</figure>

</ul>
</div>

##### 補正の前後を比較

<div>

<figure>
<img src="/images/Mairi-befaft1.jpg" title="Mairi-befaft1.jpg" width="600" />
<figcaption>Mairi-befaft1.jpg</figcaption>
</figure>

</ul>
</div>

##### CBDLの代わりにウェーブレットのレベルによるコントラスト調整を使う

- 　⟨ウェーブレット⟩は、CBDLより多機能です。但し、調整の選択肢が多いので、複雑に感じるかもしれません。
- 　しかし、"減衰応答"と⟨オフセット⟩を使うだけ、CBDLと同じ効果を出すことが出来ます。更に、CBDLは各詳細レベルで線形的な調整しか行えませんが、ウェーブレットのレベルは各詳細レベルで非線形的な調整が出来るので、ノイズやアーティファクトの増幅を避けることが出来ます。
- 　このウェーブレットのモジュールは⟨明瞭⟩機能も持っています。

<div>

<figure>
<img src="/images/Mairi-wav_1.jpg" title="Mairi-wav_1.jpg" width="600" />
<figcaption>Mairi-wav_1.jpg</figcaption>
</figure>

</ul>
</div>

##### ウェーブレットでマスクを使う

<div>

<figure>
<img src="/images/Mairi-wavmask1.jpg" title="Mairi-wavmask1.jpg" width="600" />
<figcaption>Mairi-wavmask1.jpg</figcaption>
</figure>

</ul>
</div>

#### 画像に境界線を加える

##### 全般

　ローカル編集機能で画像にホワイト、ブラック、グレー或いは色の付いた境界線を加えることが出来ます。

　以下のリンクから境界線追加のためのプリセットされたpp3ファイルを取得することが出来ます：

白い境界線
[16](https://drive.google.com/file/d/1fDIQl7Vp82SA4iY4TwwDazFpu97en0Fz/view?usp=sharing)
グレーの境界線
[17](https://drive.google.com/file/d/1mXM1zRaA8w8yai7UGgkae_lg7VggjmCK/view?usp=sharing)
色の付いた境界線
[18](https://drive.google.com/file/d/1Ztj8y1XFwlJ7fH0WXco8WRRKa6G4BzQm/view?usp=sharing)
黒い境界線
[19](https://drive.google.com/file/d/1KND7KTPfHybarkcUiSibtJ3FqISRUl9q/view?usp=sharing)

　この機能は境界線を画像の有効な部分の内側に加えます。他のアプリケーションでは境界線を画像の外側に追加するので、普通は画像サイズが増えます。

　境界線の縦横の幅や、色の初期設定を変えて、カスタマイズすることが出来ます。また、"プロファイルの一部貼り付け"を使えば、変更をした設定を他の画像に適用することも出来ます。

　上記プリセットを提供してくれたArturo Isilviaに感謝します。

##### 2つのRT-スポット

　初期設定は２つのRT-スポットをベースにしています：

- 　初めのRT-スポットはそのタイプを"画像全体"にして使います。そして、⟨色と明るさ⟩の機能（モードは高度）を追加し、これを使って画像の背景色をブラック、ホワイト、グレー、或いは色付きに変えます。
  - 　ブラック、ホワイト、或いはグレーに調整する時は、⟨色と明るさ⟩の⟨RGBトーンカーブ⟩を使います。
  - 　色付きの境界線にする時は、⟨カラー補正グリッド⟩を使います。
- 　２番目のスポット（タイプは長方形、モードは"除外モード"）を使って、境界線を好みの太さに調整します。

##### 初めのRT-スポット

###### 初めのRT-スポットで境界線をブラック、ホワイト、或いはグレーにする例

<figure>
<img src="/images/Borderrgb.jpg" title="Borderrgb.jpg" width="600" />
<figcaption>Borderrgb.jpg</figcaption>
</figure>

- 　⟨色と明るさ⟩機能のモードは"高度"にします。
- 　これら３つの変更にはRGBトーンカーブを使います。上記スクリーンショットは境界線をグレーにする例です。
- 　メインの⟨設定⟩を"全ての設定項目を表示"にして、⟨変移の階調⟩のパネルを開き、⟨変移の位置⟩のスライダーを100にします。

###### 初めのRT-スポットで境界線を色付きにする例

<figure>
<img src="/images/Bordergrid.jpg" title="Bordergrid.jpg" width="600" />
<figcaption>Bordergrid.jpg</figcaption>
</figure>

- 　⟨色と明るさ⟩の明度、コントラスト、色度のスライダーをマイナス100に、ガンマを0.5に調整します。
- 　境界線に使う好みの色を、⟨カラー補正グリッド⟩で指定します。上記スクリーンショットは境界線をグリーンにする設定です。
- 　変移の位置を100、スコープを100、⟨形状検出⟩の"ΔE‐スコープのしきい値⟩スライダーを10に調整します。

##### 2番目のRT-スポット

<figure>
<img src="/images/Borderexcluding.jpg" title="Borderexcluding.jpg"
width="600" />
<figcaption>Borderexcluding.jpg</figcaption>
</figure>

　以下の様に設定します：

- 　"スポットの形状"は長方形、"スポットのモード"は除外、⟨カラー機能のスコープ＝100、変移の位置＝100、ΔE‐スコープのしきい値⟩＝10
- 　左右、上下でシンメトリックな境界線にするのであれば、⟨特有の設定⟩パネルを開き、"スポットの変形"のコンボボックスから"シンメトリック（マウス＋スライダー）"を選択して、スポットのコントロールポイントを動かせば簡単です。

## HDRからSDRへの処理：初めてのアプローチ（対数符号化‐CAM16‐JzCzHz‐シグモイド）

　ハイダイナミックレンジ画像の処理の問題は常に論議を呼びます。RawTherapeeはダイナミックレンジを圧縮するためのアルゴリズムを幾つか（例えば、下記の様な）備えており、概ねその補正に成功しています。例えば：

- "露光"タブの⟨ダイナミックレンジ圧縮⟩と⟨シャドウ/ハイライト⟩
- "ローカル編集"タブの⟨ダイナミックレンジ＆露光補正⟩、⟨シャドウ/ハイライト＆トーンイコライザ⟩、⟨ローカルコントラスト＆ウェーブレット⟩など

　しかし、これらアルゴリズムはHDR画像の処理の点で限界があるため、"ローカル編集"の中に新たに2つの機能を追加しました：

- 対数符号化
- 色の見え (CAM16 & JzCzHz)

　ローカル編集に導入した色の見えモデルは、"高度な機能"タブに入っている⟨色の見え＆明るさ（CIECAM02/16）のモジュールを単純化したもので、同じCAM16とHDRの機能をローカル編集特有の条件に合わせています。また、HDRの最大輝度（絶対輝度）を考慮して、HDR処理の向上を狙った試験的モジュール（JzCzHz）も導入しました（機能水準が高度の場合だけ有効）。

　但し、この新たに導入した機能の解説では、特にJzCzHzとCAM16の一部に関する説明で、論議となるかもしれません。それは以下に起因します：

- 　JzCzHzに関する参考資料が非常に少ない
- 　JzCzHzの研究者が開発した基本的アルゴリズムには正常に機能しない部分がある（彩度に関する欠陥、シャドウ部分での作動不良、など）
- 　或いは、筆者の理解が不足しているため、誤謬の可能性がある

### **対数符号化**

　RawTherapeeのこの部分で使われているコードは次のコードと似ています：

- 　 Alberto Griggio が設計したARTの対数トーンマッピングモジュール。
- 　 Aurélien Pierre が設計した、DarkTableのフィルミックモジュール。

どちらのコードも、Academy Color Encoding
System（ACES）が開発した対数符号化の研究からヒントを得ました。

#### 3つのステップからなるアルゴリズム

- 　画像（HDRであっても、そうでなくても）に対する最初のステップは、平均グレー値（18％グレー）に対し、最も暗いブラックと最も明るいホワイトがどれ位乖離しているか計算することです。これらは写真のEv値（撮影場面の明るさに関係した輝度インデックス）で表されます。RGBのバランスを変えるために、平均輝度（Yb％）と共にブラックとホワイトのEv値が、アルゴリズムで使われます（自動、或いは手動）。これにより画像のレンダリングを過度に歪めることなく、コントラストを下げます、つまりシャドウ部分の明るさを増やし、ハイライト部分の明るさを下げます。
- 2番目と3番目のステップは、ユーザーが対数変換により下がったローカルコントラストを手動で上げて、これらデータを補正し、使用する出力デバイスの観視条件に調整します。

#### 色順応の使用例

　まず、カラータブの中の⟨ホワイトバランス⟩で⟨自動⟩の中の"色温度の相関関係"を選択します。これで、数学的にほぼ完全なホワイトバランスが得られます。

<div>

<figure>
<img src="/images/catATwb.jpg" title="catATwb.jpg" width="600" />
<figcaption>catATwb.jpg</figcaption>
</figure>

Rawファイルへのリンク(RawTherapee - Creative Commons Attribution-Share
Alike 4.0)：
[20](https://drive.google.com/file/d/1CiQ2t4KyD3tdCiNNhskqUG2cH9LT2ly7/view?usp=sharing)

</ul>
</div>

##### 適切なローカル編集の設定

- 　RT-スポットを作成し、スポットのタイプは"画像全体"を選びます。
- 　スクリーンショットの様に⟨ロック式カラーピッカー⟩を配置します

<div>

<figure>
<img src="/images/catLAset.jpg" title="catLAset.jpg" width="600" />
<figcaption>catLAset.jpg</figcaption>
</figure>

</ul>
</div>

##### 対数符号化の選択

　 　"現在のスポットに機能を追加"で⟨対数符号化⟩を選択します。

<div>

<figure>
<img src="/images/catLAlog.jpg" title="catLAlog.jpg" width="600" />
<figcaption>catLAlog.jpg</figcaption>
</figure>

</ul>
</div>

- 　RT-スポットの中心を移動してみます　
- 　⟨スコープ⟩の値を40、60、80、100に変えてみます
- 　結果を見比べます
- 　画像はまだ黄色味を帯びています

##### 色順応を調節 - cat16

<div>

<figure>
<img src="/images/catLAlogadap.jpg" title="catLAlogadap.jpg" width="600" />
<figcaption>catLAlogadap.jpg</figcaption>
</figure>

</ul>
</div>

- 　観視条件の中の"色順応Cat16⟩のスライダーを左に動かすと画像の印象が冷たくなります。
- 　スライダーを10ポイント減らす（左）ことは、色温度を300K下げることに相当します。
- 　試しに-23まで下げてみます。

#### ハイダイナミックレンジ画像 + 色の見えモデル

　本画像の補正は簡単ではありません。濃い影の中に、強い逆光が射しています。RawTherapeeのデフォルト設定を使い、⟨ロック式カラーピッカー⟩を本例の様に置き、処理による画像の変化が分かるようにします。

<div>

<figure>
<img src="/images/ciecam_light_prepa.jpg" title="ciecam_light_prepa.jpg"
width="600" />
<figcaption>ciecam_light_prepa.jpg</figcaption>
</figure>

Rawファイルへのリンク(Pixls.us - Creative Commons Attribution-Share
Alike 4.0)：
[21](https://drive.google.com/file/d/1ctjOWX2lVmgcAzJtBwt69FGpxZOq-LyP/view?usp=sharing)

</ul>
</div>

##### 対数符号化と色の見えモデルを使う

　"現在のスポットに機能を追加"で⟨対数符号化⟩を選択します（機能水準は⟨高度⟩）。設定は任意に以下のようにしました。この画像を[対数符号化で](local_controls/jp#using_log_encording)使った画像と比較します：

- 　⟨スコープ⟩（このモジュールの中にあるスコープ）を79にします。
- 　⟨自動⟩ボタンを押します。

<div>

<figure>
<img src="/images/ciecamlog1.jpg" title="ciecamlog1.jpg" width="600" />
<figcaption>ciecamlog1.jpg</figcaption>
</figure>

</ul>
</div>

- 　RT-スポットを動かして効果の違いを見ます。
- 　⟨スコープ⟩を変えて効果の違いを見ます。

##### 対数符号化モジュールの中の色の見えモデルの設定を変える

- 　⟨場面条件⟩の周囲環境を⟨薄暗い⟩に変えます。画像が少し明るくなるはずです。
- 　⟨画像の調整⟩パネルの中の、⟨彩度（S）⟩を30、⟨コントラスト（J）⟩を-10にします。
- 　シャドウの変化を確認します。

<div>

<figure>
<img src="/images/ciecamlog_cie.jpg" title="ciecamlog_cie.jpg" width="600" />
<figcaption>ciecamlog_cie.jpg</figcaption>
</figure>

</ul>
</div>

　更に、"全ての機能"パネルを拡張して：

- 　⟨彩度（S）⟩の代わりに⟨鮮やかさ（M）⟩を使ってみます。
- 　⟨コントラスト（J）⟩の代わりに⟨コントラスト（Q）⟩を使ってみます。
- 　⟨明るさ⟩を変えてみます。

#### 対数符号化 – 覆い焼きと焼き込み – 色の見えモデル

##### 準備

　これは対数符号化と色の見えモデルを使った別な覆い焼きと焼き込みの方法です。RT-スポットを顔の部分に持って行き、ロック式カラーピッカーを例の様に配置します。

<div>

<figure>
<img src="/images/Dblogciecamprepa.jpg" title="Dblogciecamprepa.jpg"
width="600" />
<figcaption>Dblogciecamprepa.jpg</figcaption>
</figure>

　Rawフィルへのリンク(Copyright - Jean Christophe Frisch - Creative
Commons Attribution-Share Alike 4.0)：
[22](https://drive.google.com/file/d/1oyPu-U6CD1DjWuO8LuqJdIdDau1-2yY1/view?usp=sharing)

</ul>
</div>

##### 手動モードで対数符号化を色の見えモデルと合わせて使う

- 　"現在のスポットに機能を追加"で⟨対数符号化⟩を選択します。
- 　機能水準は⟨高度⟩を使います。
- 　⟨自動⟩ボタンを押します。
- 　求める効果になるまで⟨ホワイトEv⟩を少し上げます（本例では3.0から5.0に上げています）。
- 　⟨彩度⟩（S）を少し上げます。
- 　"すべて"をクリックし、明るさ（Q）を少し減らします。
- 　"周囲環境"を、薄暗い、暗いなどに変えてみます。
- 　⟨スコープ⟩の値を変えたり、RT–スポットの位置を変えたりしてみます。

<div>

<img src="/images/Dblogciecam.jpg" title="Dblogciecam.jpg" width="600"
alt="Dblogciecam.jpg" />　

</ul>
</div>

### **対数符号化とハイライト復元**

　⟨対数符号化⟩を使用した際に、時折、予期せぬ結果になることがあります。撮影時条件によって露出過多になってしまったハイライト部分がある場合、そのハイライト部分を復元する必要がありますが、対数符号化を適用した時に、復元したハイライトが"上書き"されてしまい、予想外の結果（例、輝度や色相、彩度が変わってしまう）をもたらすことがあります。2つの方法を使って、これら復元したハイライト部分を保護します：

- 　マスクと復元処理を使う方法
- 　⟨除外スポット⟩を使う方法

#### 準備

Rawファイルへのリンク (Pixls.us Jonathan Dumaine - Creative Common
Attribution-share Alike 4.0)：
[23](https://drive.google.com/file/d/1I-Y6xqFoYMaxj9v3uEcvXfZomuJxyX6R/view)

pp3へのリンク
[24](https://drive.google.com/file/d/1JQG52i76FxFWUWqi4Mz_5seWpLD-rvT6/view)

　基本的な設定

- 　⟨ホワイトバランス⟩の調整（カラータブ）：撮影者以外、撮影時の条件（背景の光の種類；LED？蛍光灯？前景に当たっている光の種類）は分からないので、その場合は：
  - 　カメラのホワイトバランスをそのまま使う
  - 　或いは、⟨自動⟩の中の"色温度の相関関係"を使う
- 　"ハイライト復元"の方法：本例ではEmil
  Martinecが設計した優れた方法、⟨色の波及⟩を使っています。

　RT–スポットの準備

- 　RT–スポットを作成⁄追加し、スポットのタイプは"長方形"を選びます。
- 　スポットの外周がプレビュー領域の外になるように広げます。
- 　"変移の階調"の⟨変移の位置⟩はある程度高い値にします。
- 　⟨ロック式カラーピッカー⟩をスクリーンショットの様に配置します。
- 　⟨ロック式カラーピッカー⟩のL\*a\*b\*の値が、⟨設定⟩モジュールの中の"マスクと融合に関する設定"の"背景の色⁄輝度のマスク"を0にして実際の値と同じになるようにします。

<div>

<figure>
<img src="/images/Loghigh-prepa.jpg" title="Loghigh-prepa.jpg" width="600" />
<figcaption>Loghigh-prepa.jpg</figcaption>
</figure>

</ul>
</div>

#### 対数符号化を適用

- 　現在のスポットに機能を追加で⟨対数符号化⟩を追加します。
- 　機能の水準モードは⟨高度⟩（或いは標準）を選択します。
- 　⟨自動⟩ボタンを押します。
- 　対数符号化モジュールの⟨スコープ⟩値を80以上にします。

　⟨対数符号化⟩は自動で画像、特に前景（被写体）を中心に調整しますが、先に⟨ハイライト復元⟩で復元された後景のハイライト部分の彩度は下がり、明るさも減ります。

　しかしそれだけではなく、全体的には彩度が強くなり過ぎて、露光の配分も不適切になっています。

#### マスクの作成

　RawTherapeeで通常使われるマスクとは異なる種類のマスクを作ります。このマスクは⟨対数符号化⟩を適用していない画像と、適用した画像を融合するために直接的に使います。

　"輝度マスクをベースにした復元"の設定に応じて：

- 　マスクの暗い部分では、融合した画像のその部分は限りなく元画像に近くなります。
- 　マスクの非常に明るいでは、融合した画像のその部分は限りなく元画像に近くなります。
- 　上記2つの部分以外で、⟨対数符号化⟩の調整が働きます。

　本例では、LC(H)カーブを使っていますが、他の画像ではL(L)カーブを使う必要があるかもしれません。注意：C(C)カーブは融合の効果がありませんが、領域選定の質を向上するのには使えます。

<div>

<figure>
<img src="/images/Loghigh-mask.jpg" title="Loghigh-mask.jpg" width="600" />
<figcaption>Loghigh-mask.jpg</figcaption>
</figure>

</ul>
</div>
<div>

<figure>
<img src="/images/Loghigh-log.jpg" title="Loghigh-log.jpg" width="600" />
<figcaption>Loghigh-log.jpg</figcaption>
</figure>

</ul>
</div>

#### マスクを使ってハイライトを部分的に復元

- 　"マスクを有効にする"のボックスにチェックを入れます。
- 　"輝度マスクをベースにした復元"のパネルを拡張します。
- 　"復元のしきい値の設定"：設定値を"2"に近づけるほど、マスクの暗い、或いは非常に明るい部分の広範囲が考慮され、元画像に近い輝度を復元します。
- 　"暗い領域の輝度のしきい値"と"明るい領域の輝度のしきい値"スライダーを使って、効果が及ぶ領域を増やしたり減らしたりします。これら2つの値が明暗の境界になります（例えば、スクリーンショットでは暗い領域の境界値が25.5、明るい領域の境界値が98.3になっています）。境界値より低い、高い領域では調整効果が漸進的に働きます。
- 　必要であれば、"減衰の強さ"で、減衰の働きを調節します。

<div>

<figure>
<img src="/images/Loghigh-recov.jpg" title="Loghigh-recov.jpg" width="600" />
<figcaption>Loghigh-recov.jpg</figcaption>
</figure>

</ul>
</div>

#### 除外スポットを使ったハイライト復元

　⟨ローカル編集⟩の特筆すべき機能、⟨除外スポット⟩を使ってハイライト復元を行います。調整の加減は任意です。

<div>

<figure>
<img src="/images/Loghigh-exclu.jpg" title="Loghigh-exclu.jpg" width="600" />
<figcaption>Loghigh-exclu.jpg</figcaption>
</figure>

</ul>
</div>

#### CAM16を使った最終調整

　様々なパラメータの調整を終えた後に最終的な仕上げを行います。ここでは⟨CIECAM16⟩の設定を使った方法を紹介します。

- 　コントラストを増やします。
- 　彩度を下げます、特に肌色の。
- 　画像の印象を少し冷たくするために色順応を調整します。

　もちろん、人によって感じ方は違うので、設定値は任意です。

最終的な留意点:

- 　ハイライト部分は復元出来ましたが、ノイズが多い画像なので、更にノイズ低減を使って仕上げを行う必要があるでしょう。しかし、この項の説明趣旨とは外れるので手順は省きます。

<div>

<figure>
<img src="/images/Loghigh-ciecam.jpg" title="Loghigh-ciecam.jpg" width="600" />
<figcaption>Loghigh-ciecam.jpg</figcaption>
</figure>

</ul>
</div>

### **対数符号化を使った他の例**

- 　本例では、J.DesmisによってRawTherapeeの〈ローカル編集〉に組み入れた〈対数符号化〉（Darktableのフィルミックモジュールから派生した機能で、A.GriggioのARTにも採用されています）を使います。
- 　本例では、〈対数符号化〉モジュールの能力を示すため、設定の中の〈階調フィルタ〉を使わずに、このモジュールを使って輝度の階調を変えます。
- 　3つのステップで行います：準備、自動設定、調整

#### 準備

- 　RT–スポットを以下の様にセットします:
  - 　RT–スポットの中心をスクリーンショットに示したように画像の左下に置きます。
  - 　RT–スポットの右辺上が画像の境界に来るようにセットします。
- 　⟨対数符号化⟩を追加します。機能の効果を示すため、スクリーンショットは敢えて機能を無効にしています（デフォルトでは機能を追加した際に有効になります）。

<div>

<img src="/images/encodlogprepa.jpg" title="encodlogprepa.jpg" width="600"
alt="encodlogprepa.jpg" /> Rawファイルへのリンク
[25](https://drive.google.com/open?id=1RXoXp-AHWzo6mzbd-VyRTRvmRlFtyZDq)

</ul>
</div>

#### 自動設定

- 　"自動"ボタンを押します（自動なのでスライダーがグレーアウトします）。
- 　画像が明るくなります。
- 　自動ボタンをもう一度押すとスライダーに新たにブラックEv値とホワイトEv値が表示され、スライダーを手動で動かせるようになります。
- 　自動で設定されたブラックEv=-6.7、ホワイトEv=6.9という結果は、この画像のダイナミックレンジがEv=13.6の幅を持つことを示しています。
- 　場面条件の"平均輝度（Yb％）"の値は(自動で設定されます) は1.2です。

### **CAM16とHDR機能を使う**

#### 序文

　⟨色の見え（CAM16とJzCzHz）⟩のモジュールはHDR画像の一定の側面を考慮することが出来ます。但し、対数符号化、JzCzHz、CAM16はHDR画像に関する一連の処理の一部でしかないことを覚えておいて下さい。他の側面、例えばHDRモニターの特性（LCMSのコードを含む）などは将来的に組み込む必要があります。

#### 高度な機能タブの色の見えと明るさ（CIECAM02/16）との違い

- 　このモジュールは⟨ローカル編集⟩特有の機能（ΔE、境界の諧調、マスクなど）が含まれています。
- 　色順応の処理が単純化されています。
- 　カーブの種類が少なくなっています。
- 　単純化したPQ（知覚量子化器）機能が含まれています。CAM16の処理工程の最初の方に置かれていて、⟨明るさQ⟩、⟨明度J⟩、⟨鮮やかさM⟩、⟨彩度S⟩、⟨色度C⟩の値が内部で計算されます。
- 　対数符号化Q或いはシグモイドQが、単独またはブラックEv/ホワイトEv（ダイナミックレンジ）と併用して使われます。

#### 重要事項

- 　場面条件の値はCAM16のアルゴリズムと、入力プロファイルの適用、デモザイク処理、作業プロファイルの選択といったローカル編集のアップストリームプロセスで計算されます。全て線形モードで行われます。
- 　ローカル編集の前後で行われる、RGB↔L\*a\*b\*変換でダイナミックレンジが変化することはありません。もし、ローカル編集に入る前の画像のダイナミックレンジが15Evであれば、ローカル編集終了後のダイナミックレンジも概ね同じになります（違いが生ずるとすれば、ユーザーの調整に起因するものです）。一方、JzCzHz⇔L\*a\*b\*変換に関しては事情が異なります。L\*a\*b\*は低い輝度値（0.005カンデラ/平方メートル以下）は考慮することは出来ますが、120カンデラ/平方メートル以上の高い輝度値はガンマの使用により考慮できません。但し、120カンデラ/平方メートル以上のハイライトはデータとしては維持されているので、高いハイライト部分の処理をデータ圧縮とみなすことは出来ます。将来的には、高いハイライト値の処理（HDR-L\*a\*b\*やその出力工程など）を考える必要があるでしょう。
- 　⟨設定⟩の2つのチェックボックス、"色ずれの回避"、"マンセル補正だけ⟩にチェックを入れておけば、ローカル編集のプロセス全てで、彩度の変化に関わらず色相は一定に維持されます。

#### HDRの前処理機能を備えたCAM16

　新たに組み入れた処理工程でこれによりユーザーは：

- 　画像処理で生理学的側面を考慮できると評価されているCAM16のポテンシャルをより有効に活用できます。
- 　CIECAMのアップストリーム、必要であればCAM16、にHDRの処理を統合します。　

　CAM16という名前を初めて聞くユーザー、或いは知っているが技術的なことには興味がないユーザーは、この先の説明はスキップして構いません。　

##### CAMを実装する上での２つの大きな問題：６つの変数と明るさの関数Qの特性

###### CAMと６つの変数

　CAM16（同様にCAM02）のプログラミングには困難と制約が伴うことを知っておいた方がいいでしょう。CIECAMのプログラミング開発を始めたのは2011年から2012年にかけてです。3つの変数から成り立っているRGBやXYZ、L\*a\*b\*と言った色モデルとは異なり、CIECAMはJ（明度）、Q（明るさ）、C（色度）、s（彩度）、M（鮮やかさ）、h（色相）という6つの変数から成り立っています。そのため、著しいメモリーの消費と処理時間が長くなることは直ぐに分かりました。そこで、メモリー消費を抑えるため、作業ループ全体の中でそれら変数を一つずつ順に処理することにしました。但し、そのために作業ループの途中で呼び出された手続きの最適化が事実上不可能、という大きな問題が残りました。結果として、コントラストやシグモイドなどの最適化が一定の制限を受けることになりました。

　CAM16は次のことも可能です：

- 　シャドウ部分を上げる（明るくする）こと
- 　対数符号化のようなHDR処理の利用が複雑になるハイライト部分の知覚的処理

###### Q（明るさ）の特殊性

- 　設計上、Q（明るさ）の計算には絶対輝度を使います。そのため同じCIECAMのJ（明度）やL\*a\*b\*のL（明度）、そしてRGBやHSV、他の色モデルの輝度計算とは異なり、０～１や０～65535のような上限がありません。
- 　Jの尺度範囲が0～1の時、場面条件次第ではQの値が5や10になることがあります。このことは、アルゴリズムによる基準値（平均輝度やしきい値など）の設定に非常に大きな制約となり、それらの自動化が困難となります。
- 　しかし、多くの場合はQの値は人間の知覚に近い自然なレンダリングをもたらす値になります。

###### これまでCAM16の画像編集に入っていたHDR用モジュール、"対数符号化Q"と"シグモイドQ"を外す

<figure>
<img src="/images/sourcedata1.jpg" title="sourcedata1.jpg" />
<figcaption>sourcedata1.jpg</figcaption>
</figure>

　先に挙げた難しさから、次のような決定を行いました：

- 　HDRと測色に関する機能を、新たに作った⟨元データの調整⟩というモジュールに移します。このモジュールはCAM16の処理を行うCIECAMモジュールの前に置きます。しかし、インターフェイス上は"色の見えモデル（CAM16＆JzCzHz）"の中に入れるので、機能パネルの切り替えは行わずに済みます。このモジュールには画像の性質に応じて多かれ少なかれ役に立つ機能を入れています：
  - 　対数符号化：これはハイダイナミックレンジの画像が正しく処理できるように、あらかじめデータを対数で符号化する機能です。もちろん、どの様な画像に対しても使えますが、明らかに役立つのは画像のEv値が10を超える場合です。また、これを必要としない画像に適用すると全体の測色が変わることがあり、それを簡単に復元できるとは限りません。"明るさの圧縮"スライダーは、高い輝度値に関する作用に制限を加えるためのものです。[ダイナミックレンジ復元の評価の](local_controls/jp#ローカル編集に備わっている機能のダイナミックレンジ復元の評価)項も参考にして下さい。　
  - 　トーンリプロダクションカーブ（TRC）＆中間トーン：多くの場合、この機能は露出不足の画像（非常に暗いシャドウ部分がある）、或いは輝度のバランスが悪い画像の調整に役立ちます。手法はRawTherapeeでTRCが使われているモジュールと同じです。
    - 　ガンマ：ハイライト部分の効果を変えます。
    - 　スロープ：シャドウ部分を明るくします。
    - 　中間トーン：中間トーンの調整を行います。
    - 　ハイライトの減衰：ガンマ、スロープ、中間トーンによる調整効果を和らげて滑らかにする（ハイライトを下げる）機能です。但し、これは⟨ハイライト復元⟩機能の代わりにはなりません。
- 　原色と光源の機能：
  - 　画像の測色を調整します。例えば、複数の光源で撮影された画像で（例：自然光とLED）色ずれを生じる、或いは、撮影条件により（標準A光源による撮影や主体色が赤い花の色など）結果が不満足になった場合（ブルーやレッドの彩度が過度になる）に使う機能です。
  - 　注意：カラータブの中の作業プロファイル（デフォルトはProphoto）を変更した場合は、"変換先の原色"を手動で採用する必要があります（自動的には行われません）。
  - 　画像の色や彩度を部分的に、或いは、全体的に変更します：
    - 　システムが画像の主体色のxy値を計算し、それをCIExyダイヤグラム上にグレーポイントで表示します。
    - 　"色の微調整（ホワイトポイント）“スライダーを動かすと画像の彩度が変わります。
    - 　"シフトx"と"シフトy"を使ってグレーポイントの位置を変更することで、主体色を加える、或いは減らす（色相及び彩度）ことが出来ます。
  - 　色域の抑制：色域をコントロールします、特に原色が変更になった場合に。
  - 　マトリクスの採用：ブラッドフォード、CAT02、CAT16、フォン・クリースの係数、XYZスケールの中から選びます。原色が変更された際の色順応の選択を増やしてくれます。

　これら機能の幾つかはカラーマネジメントの解説にある[アブストラクトプロファイルの](color_management/jp#アブストラクトプロファイル)概念と似ています。それも参考にして下さい。

##### 元データの調整と場面条件

　場面条件とは何か、複雑な概念で多くのユーザーの誤解もありますが、ここでは詳しく説明しません（[色の見えモデル02/16&Jzazbzの](ciecam02/jp)解説を参照して下さい）。簡単に言えば、"場面条件"とは、撮影が行われた際のその環境を考慮する機能です。また、観視条件とは区別されます。観視条件は画像を見る環境のことを考慮する機能です。例えば、画像を表示するシステムの種類、輝度、コントラスト（HDR仕様或いは標準仕様のモニター、テレビの画面、プロジェクター、プリンターなど）、或いは背景の輝度（昼光だけ、暗い部屋の中など）のことを指します。注意：この観視条件を場面条件や元データの調整の不完全さを補正するために使うことは誤りです。　

###### CAM16による編集の前に、画像を調整する “対数符号化”や“場面条件”はどの様な原理で働くのか

<figure>
<img src="/images/whiteblackdisr.jpg" title="whiteblackdisr.jpg" width="400" />
<figcaption>whiteblackdisr.jpg</figcaption>
</figure>

　CAM16を使うためには以下の情報が必要です：

- 　絶対輝度：これは撮影時のExifデータ（シャッタースピード、絞り、露光補正など）から計算されます。
- 　平均輝度：“グレーポイント”とも呼ばれる値で、以下に説明されている方法で計算されます。　

ハイダイナミックレンジ画像を処理するためには、対数変換のための値を計算する必要があります：

- 　ブラックEvとホワイトEv、そして前述した“グレーポイント”です。

　これらの値はどの時点で、どの様に計算するべきでしょうか？場面条件の理論からすれば、有益なデータが取れる範囲で処理工程の出来るだけ初めの方、と言うことになります。対数符号化モジュールを開発したARTは、データの取得をデモザイク処理直後の画像で行っています。但し、この選択は、定義上、画像の処理が行われていない時点なので、色と明るさの分布が不明で信頼性が足りないというデメリットもあります。また、データ圧縮のための対数変換（Log2）は非線形であるという困難もあります。

　その結果として、デジタルノイズを考慮し、グレーポイント同様、RGBの最大値と最小値を推定しなければなりません。また、これらの調整は、その後起こりうる輝度の変化も考慮する必要があります。平均輝度とその結果であるグレーポイントの計算に関するおおよその経験的公式は、モジュールの設計者によって開発されたものです。しかしながら、結果が期待外れに終わることもあります。

　実際には、一旦計算が行われても、少なくとも元データのブラックEvとホワイトEv、平均輝度Y％（グレーポイント）、及び観視条件の平均輝度Y%を手動で調整（これらの調整を元データの調整と混同しないように）する必要があります。従って、結果を直感的に推測することが容易ではありません。

　そこで、この問題を解決するために、2つの極端なホワイトとブラックの調整機能を追加してみました。"ホワイトの分布"と"ブラックの分布"というスライダーです。画像処理に一般的ルールというものはないので、画像の最も露出が高い部分や低い部分を、弱めたり強めたりすることに不都合はありません。一貫した内部のアルゴリズムがブラックEv、ホワイトEv、平均輝度（グレーポイント）を再計算します。この解決策により調整がより直感的に行えるようになったと思います。他にも方法があるかもしれませんが、少なくともこの解決策が使えることが分かりました。

　この調整は場面条件の中にある⟨自動⟩のオプションを有効にした場合にだけ使えます。

##### 拡張パネルを使い、ユーザーインターフェイスを単純化し、より感覚的に使えるように

<figure>
<img src="/images/Cam16exp.jpg" title="Cam16exp.jpg" width="600" />
<figcaption>Cam16exp.jpg</figcaption>
</figure>

##### CAM16を使ったHDR画像補正の例

　使用画像：パリ市内のアレクサンドル３世橋、2021年10月撮影

- 　撮影に使用したカメラ：ニコンZ6 II
- 　Rawファイルへの リンク(Jacques Desmis - Creative Common
  Attribution-share Alike 4.0):
  [26](https://drive.google.com/file/d/17G1H-7S2uCyDa92CiJf9g35jhegvCZu_/view?usp=sharing)
- 　pp３ファイル ![Alex3-NEF.pp3](Alexandre3.pp3 "Alex3-NEF.pp3")

　この画像のダイナミックレンジは13.5Ev強と高く、露出オーバーの部分（Lが100以上）もあります。

　この解説の目的は、"ベスト"な補正の紹介ではなく、CIECAMのモジュールの前に、"元データの調整"という前処理のモジュールを置くことで、ハイダイナミックレンジ画像に前処理を施し、CIECAM（CAM16）による画像補正が行い易くなることを示すものです。

　別な画像を使ってトーンリプロダクションカーブ（TRC）を利用した補正も追加します。

###### 準備：適切な起点を定め、解決すべき問題を特定

　以下の基本設定を行います：

- 　画像をニュートラルプロファイルで開きます。
- 　ホワイトバランスの補正に⟨自動‐色温度の相関関係⟩を使用します。
- 　"ハイライト復元"を有効にします：方式はインペイントオポーズド、ゲインのしきい値は0.82です。

　基本設定だけの場合のレンダリングの結果：

- 　右上の鉄鋼構造部分のシャドウに詳細が殆どありません。
- 　ハイライト部分は許容範囲（L＝97）にあり、明らかな色ずれもありません。
- 　ヒストグラムを見るとレッドが飽和しています。
- 　レンダリングが良いとは言い難い画像です。

<figure>
<img src="/images/Alex3-neutr.jpg" title="Alex3-neutr.jpg" width="600" />
<figcaption>Alex3-neutr.jpg</figcaption>
</figure>

###### カメラ（ニコン）のトーンカーブを自動マッチングで適用した画像

　ニコンZ6IIの入力プロファイルを適用した画像です。

　このレンダリングの評価：

- 　先の画像よりは好ましく、バランスが取れています。
- 　シャドウ部分の詳細は多くありません。
- 　ハイライトに白飛びがあります（L＝100以上）。

<figure>
<img src="/images/Alex3-automatch.jpg" title="Alex3-automatch.jpg"
width="600" />
<figcaption>Alex3-automatch.jpg</figcaption>
</figure>

###### ダイナミックレンジを前処理で補正した画像

- 　⟨元データの調整⟩を有効にします。
- 　⟨対数符号化⟩を有効にします。

　このレンダリングの評価：

- 　ハイダイナミックレンジ：13.6Ev（計算と一致）
- 　シャドウ部分の詳細が復元されました（明るくなり過ぎたきらいがあります）。
- 　ハイライトは許容範囲にあります。L＝98
- 　ヒストグラムを見るとレッドが飽和しています。
- 　全体的な印象が明る過ぎます。

<figure>
<img src="/images/Alex3-logencode.jpg" title="Alex3-logencode.jpg"
width="600" />
<figcaption>Alex3-logencode.jpg</figcaption>
</figure>

　シャドウ部分を和らげ、ハイライトを減らします：

- 　場面条件の"ホワイトの分布"スライダーを‐74、"ブラックの分布"を‐59に設定します。設定値の選択は任意で、ユーザーの好みに準じます。
- 　⟨元データの調整⟩の中間トーンを‐70にして、平均輝度を好ましいレベルに復元します。
- 　元データの調整‐対数符号化の"明るさの圧縮"スライダーを90にして明るさを下げます。

<figure>
<img src="/images/Alex3-dynamic1.jpg" title="Alex3-dynamic1.jpg" width="600" />
<figcaption>Alex3-dynamic1.jpg</figcaption>
</figure>

###### 場面の印象を"夏っぽく"する

　秋の水面の映り（及び場面の清浄感）はあまり魅力的ではないので、夏の彩りに編集してみます。

　映りを少し鮮やかに変えてみたいと思います。２つ目のRT-スポットを追加します（スコープの値は60）。

　⟨元データの調整⟩のTRCで中間トーンを‐70にします。

　⟨原色＆光源⟩で"主体色"を選択します：

- 　2つのスライダー"シフトx"と"シフトy"を使い、主体色を表すグレーポイントを動かします。
- 　シフトx = 0.2, シフトy = -0.0454
- 　これによりホワイトポイント、グレーポイント（主体色）、及びレッドの原色を代表するブラックポイントがほぼ直線上に並びます。
- 　"色の微調整（ホワイトポイント）"を動かすことで、色相をブルー/グリーン寄りに変え、彩度を増やすことが出来ます。もちろん、こう言った編集はユーザーの好み次第です。

<figure>
<img src="/images/Alex3-seine1.jpg" title="Alex3-seine1.jpg" width="600" />
<figcaption>Alex3-seine1.jpg</figcaption>
</figure>

##### 別の編集例、トーンリプロダクションカーブ（TRC）や場面条件の周囲環境を使う‐トンネルの中のトラック

- 　Rawファイルのリンク(著作権- Roberto Posadas - Common
  Attribution-share Alike 4.0):
  [27](https://drive.google.com/open?id=1RXoXp-AHWzo6mzbd-VyRTRvmRlFtyZDq)
- 　pp3ファイルのリンク
  ![Truck-tunnel-1.pp3](Truck-tunnel.pp3 "Truck-tunnel-1.pp3")
- 　pp3ファイルのリンク ![](Truck-tunnel-2.pp3 "Truck-tunnel-2.pp3")
- 　pp3ファイルのリンク ![](Truck-tunnel-3.pp3 "Truck-tunnel-3.pp3")

###### 元画像

<figure>
<img src="/images/Van-tunnel-0.jpg" title="Van-tunnel-0.jpg" width="600" />
<figcaption>Van-tunnel-0.jpg</figcaption>
</figure>

###### 元データの調整‐TRCと中間トーンを適用した画像

- 　スコープ = 60;
- 　注目点：単純な設定でより直感的に調整
- 　ガンマ = 2.90　ハイライトを更に明るく
- 　スロープ = 80　シャドウを明るく

<figure>
<img src="/images/Van-tunnel.jpg" title="Van-tunnel.jpg" width="600" />
<figcaption>Van-tunnel.jpg</figcaption>
</figure>

###### 場面条件の周囲環境を変更した画像

　更に単純な調整

- 　スコープ = 60;

　場面条件:

- 　周囲 = 暗い

　元データの調整：

- 　ハイライトの減衰とレベル= 有効

　CAM16による調整：

- 　コントラストJ = 24.

<figure>
<img src="/images/Van-tunnel-surround.jpg" title="Van-tunnel-surround.jpg"
width="600" />
<figcaption>Van-tunnel-surround.jpg</figcaption>
</figure>

##### 2つのTRC（トーンリプロダクションカーブ）の違いとCIECAMの効果

　RawTherapeeの中にはTRCが2つあり、１つはカラーマネジメントタブの⟨アブストラクトプロファイル⟩モジュールの中、もう１つはローカル編集タブの⟨色と見え（CAM16＆JzCzHz）⟩の⟨元データの調整⟩モジュールの中です。

　どちらのモジュールに属するTRCもほぼ同一の機能ですが、後者（元データの調整）のモジュールには対数符号化機能が追加されています。この機能は、他の方法では解決できないような極端な画像の編集に使うべきものです。この機能によるレンダリングは予測が困難で、明るさや色のバランスが悪いことがしばしばあるからです。

　どちらのTRC機能も、データを変更するためにヴァーチャルプロファイルの利用を基本にしています。どちらにも以下の機能が含まれます：

- 　ハイライトを調整するためのガンマのスライダーと、シャドウを調整するためのスロープのスライダーを備えたトーンリプロダクションカーブ（TRC）。
- 　中間トーンとハイライトを調整するために、２つのスライダーと設定、チェックボックス或いはコンボボックス（元データの調整；SourceDataAdjustments;SDA）を追加しました：
  - 　中間トーン（スライダー）
  - 　ハイライトの減衰とレベル（コンボボックス）には4つの選択肢があります：
    - 　Evベース：Evの幅が０～12であれば、強すぎるハイライトを和らげることが出来ます。
    - 　ガンマベース（元データの調整）：場面の平均輝度Yb％（漸近展開多項式関数）を使うことで強すぎるハイライトを和らげます。
    - 　スロープベース（元データの調整）：ガンマとスロープを使ったトーンマッピングの組み合わせをベースにして強すぎるハイライトを和らげます。23ないし24のEv値を復元することが出来ます。スロープのスライダーはシャドウとハイライトのバランスを整えるために使います：
    - 　レベル（元データの調整）：上記のスロープベースと似ていますが、3つの色チャンネルR、G、B、を別々に調整します。場面条件/観視条件の平均輝度Yb％を考慮する、或いは全体的な明るさを維持することで、レンダリングを制御します。

<figure>
<img src="/images/Highattenuation.jpg" title="Highattenuation.jpg"
width="600" />
<figcaption>Highattenuation.jpg</figcaption>
</figure>

- 　⟨原色と光源⟩は、画像の測色を調整するための機能です。光源を選択し、主体色を調整します。

<figure>
<img src="/images/Primdom.jpg" title="Primdom.jpg" width="600" />
<figcaption>Primdom.jpg</figcaption>
</figure>

- 　主体色の調整は、⟨色の微調整⟩、或いはシフトxやシフトyを動かすことで、ダイヤグラム上のホワイトポイントを計算した主体色（グレーポイント）に向けて移動することで行います
- 　白黒：原色のモジュールをチャンネルミキサーとして使うことで画像を白黒に変えるオプションです。

###### 処理工程の中における両モジュールの位置

　カラータブのカラーマネジメントの中にあるアブストラクトプロファイルは処理工程の後ろの方にあります。ちょうど⟨色と見え＆明るさ⟩モジュールの直前です。ローカル編集タブの⟨色の見え（CAM16＆JzCzHz）⟩モジュールの中にある"元データの調整"は処理工程の中のホワイトバランスの直ぐ後ろにあります。つまり、処理工程の前の方に位置します。処理工程の中の置かれた位置が違うので、2つのモジュールによるシャドウとハイライトのレンダリング結果は異なります：　

- 　元データの調整モジュールは、露光補正、トーンカーブの自動マッチング、そして露光補正タブに備わっている全てのスライダーやカーブの前にあります。
- 　つまり、デモザイク処理直後のRGBデータを内部の計算と場面条件に使います。
- 　一方、アブストラクトプロファイルの演算は処理工程最後で計算されたRGBデータを使います。

　従って、アブストラクトプロファイルを適用した場合のシャドウとハイライトの分布は、その適用前にユーザーの行った各編集と、トーンカーブの自動マッチングの作用に左右されることになります。また、カメラの機種や画像によっても変わります。

　2つのモジュールでは、ガンマやスロープスライダーの反応も変わります：一般的に言えば、アブストラクトプロファイルモジュールのガンマやスロープを使う時に比べ、元データの調整ではガンマやスロープに低い値を使う必要があるでしょう。原色と光源の選択によっても結果は、特に主体色の観点で、変わります。

###### CIECAMの影響

　アブストラクトプロファイルは色の見えと明るさ（CIECAM）のモジュールから独立しています。また、処理工程の順で言えば、そのモジュールはCIECAMの直前にあります。従って、CIECAMによる編集では、アブストラクトプロファイルによる編集が行わていれば、その結果が考慮されます。一方、元データの調整はローカル編集タブのCIECAMモジュール（色の見え）に組み入れられています。そのため、元データの調整の設定はCIECAMの編集により影響を受けます。

###### CIECAMはどの様な働きをするのか

　ここではCIECAMの解説はしませんが、この色モデルは高度な機能タブ（グローバルな編集）の"色の見え＆明るさ"とローカル編集タブの"色の見えモデル（CAM16＆JzCzHz）"で使われています。人間の目と脳による知覚に起因する生理学的観点を考慮している色モデルです。

　完全とは言えませんが、RawTherapeeに組み入れられている2つのバージョンのCIECAMの効果に関する情報が、CIECAMの解説の中にあるので参考にして下さい。

　生理学的な影響、特に元データの調整に関係するものの殆どはプログラムにより自動的に考慮されます。

　しかし、スティーブンスの効果だけは別です。この効果は、場面条件と観視条件のモジュールにある"周囲環境"によって作ります。これら2つの周囲環境（コンボボックス）は、平均、薄暗い、暗い、非常に暗いという4つの選択肢を持ちます。

　これらの効果が考慮されると、画像が撮影された時、画像を見る時の条件に近い状態に画像が調整されます。もちろん、そう言った条件を正しく再現できるのは撮影した本人だけです。

　考慮される効果について少し補足します：

- 　"周囲環境"（スティーブンス効果）はシャドウ部分を明るくします。周囲環境を明るくするほど（例、"暗い"を選択）、トーンリプロダクションカーブの、特にスロープ、働きを弱める必要があるでしょう。
- 　
  "同時対比"は、自動的に考慮される効果で（彩度が上がる）、輝度の差が大きい画像ではより重要になります。従って、ハイライトとシャドウのバランスが悪い画像（その原因が自然であっても、ガンマやスロープの調整による人為的なものであっても）の場合、彩度が過度になることがあります。
- 　"ハントの効果"は、絶対輝度の値（算出に使うためのExifデータがある場合）をベースにしています。

　ローカル編集の⟨CAM16による画像の調整⟩パネルでの設定は、以下のような効果も考慮しています。例えば：

- 　明るさQ（そしてコントラストQ）は絶対輝度をベースにした演算を行うので、明度JやコントラストJとは異なります。
- 　彩度sは色度Cとは違った方法で色の鮮やかさを増やす演算を行いますが、シャドウ部分の色への効果は小さくなります。

　⟨元データの調整⟩のポイントをまとめると：

- 　場面条件の周囲環境を使って画像を明るくした場合、TRCのスロープやガンマの調整はカラーマネジメントの⟨アブストラクトプロファイル⟩のそれらに比べて小さくする必要があります。
- 　色の彩度はスロープやガンマの値が大きいと直接的な影響を受けます。従って、必要であれば彩度sのスライダー（CAM16による画像の調整モジュールの中）を調整します。
- 　元データの調整モジュールでパラメータを調整する時にはCAMの効果が考慮されます。つまり、ハイライトやシャドウの分布、そして色にも影響があると言うことです。アブストラクトプロファイルの設定を元データの調整の設定に置き換えることは出来ません（少なくとも、輝度、ガンマ、スロープ、中間トーンなどは）。全体への効果を減らす場合を除き、その反対の置き換えも然りです。

###### まとめ

　CIECAMの機能、特に2020年から22年かけて開発したCAM16は大変質の高い機能です（完璧とは言わないまでも）。筆者の知る限り、CIELabやOKLab、Jzazbzとは異なり、色の見えモデル（CAM）の全ての概念を網羅した唯一の機能です：

- 　処理工程は場面条件、画像編集、観視条件の3つに分けられます。
- 　各機能と処理は、人間の視覚と脳の知覚特性である同時対比、周囲環境、色順応などを考慮します。
- 　CAMに必要な6つの変数、明度J、明るさQ、色度C、彩度s、鮮やかさM、色相h、全てを利用します。

　
　しかしながら、1つ弱点があります。CAM16による画像の解析はピクセル毎で、全体的なものではありません。そのことが難しい画像（例えば、ハイダイナミックレンジの画像）を処理する際のハンデとなります。

　⟨元データの調整⟩はこの問題を部分的に解決するためのモジュールです。関連機能（対数符号化、TRCの中間トーンなど）を使ってトーンと色の全体的な編集を実行します。CAM16と部分的に関係しています。言い換えれば、元データの調整による変化はCAM16の調整による影響を受けます。つまり、扱う画像によっては、"元データの調整"で行った調整やその後の処理（CAM16による画像の調整、など）で、画像の一定部分、特にシャドウ部分、のコントラストが強くなり過ぎたり、彩度が強くなり過ぎたりすることがあります。

　（CAM16による）画像編集のツールを（彩度sや明るさなど）使った、画像全体、或いは追加的なRT‐スポットによる特定の部分の編集はユーザーの手に委ねられています。注意として、シャドウ部分で多くの編集を行うとノイズが増加することがしばしばあるので、その抑制が必要です。そのためには⟨ぼかし/質感＆ノイズ除去⟩のモジュールを適宜使うべきでしょう。

### **色の見えモデルとJzCzHzのチュートリアル**

　"色の見え＆明るさ（CIECAM02/16）と色の見え（CAM16-JzCzHz）のチュートリアル"の解説を参照。

### **試験的なモジュール　JzCzHz**

　このモジュールの概略は"色の見え＆明るさ"の解説も参照して下さい。

#### CAM、SDR、HDRの設定に関する理解　全般

　このモジュールに関する概略は、"色の見え＆明るさ"の"全般"の項を参照。

#### CAM、SDR、HDRの設定に関する理解　イントロダクション

　このモジュールに関する概略は、"色の見え＆明るさ"の"イントロダクション"の項を参照。

##### Jzを使った実例

<figure>
<img src="/images/Jzsettings.jpg" title="Jzsettings.jpg" width="600" />
<figcaption>Jzsettings.jpg</figcaption>
</figure>

　⟨場面条件⟩のパネルの中にJzに影響する設定が6つあります：

- 　場面条件の⟨平均輝度（Y%）⟩はデモザイク処理直後の画像の平均輝度のことです。グレーの割合（%）で表します。スライダーを右に移動すると画像が暗くなります。このスライダーの調整は⟨対数符号化Jz⟩で使われる基準値にも影響し、対数変換前の画像のコントラストが明らかに変化します。
- 　⟨絶対輝度（La）⟩のスライダーは以下に示したような必要性に応じて、絶対輝度の値を補正するスライダーです：
  - 　JzとQで使われる実際の値を考慮し、共通であるCAM（色の見えモデル）のモジュールに作用させるため。
  - 　"PU（均一的知覚）‐順応"と非線形的に相互作用させ、著しく小さくなるとわかっている内部のJz値を扱いやすい幅の値に変更するため（コンセプトに関する筆者の解釈に基づいています）。PQ関数によるレンダリングは非線形なので、高い絶対輝度値は内部のJz値を増します。

<!-- -->

- 　"PU‐順応"により、絶対輝度とは独立して内部のJz値が調節できます。
- 　"Jzの基準値100カンデラ"。このスライダーはSDR（最大輝度120カンデラ/平方メートル）とHDR（最大輝度10,000カンデラ/平方メートル）の間のJzの8ビット/10ビット比率を変えるものですが、本当のHDRモニターを使用した時の調整機能なので、今は使う必要がありません。
- 　"PQの最大輝度"はPQ関数の内部で使われる"最大輝度"のことです。HDRに関わる全部の計算で使われるこの内部の値は、HDRモニター（手に入るようになれば）に割り当てられる値とは異なります。スライダーを動かして、シャドウやハイライト、彩度が変わることを確認して下さい。
- 　⟨Jz　再マッピング⟩の中の3つの設定は内部で使われるJz値の適応を改善するためのものです。カーブやスライダー、機能が正しく動作するようにするため、一時的に2次補正がこれら設定機能に適用され、Jz値が0～1.0に収まるようにします。
- 　パネルの一番下にある"観視時の周囲環境"のコンボボックス（平均、薄暗い、暗い）は撮影時の周囲環境を考慮する機能です。撮影時の背景の明るさ、平均的、薄暗い、暗い、に応じて画像の明るさが少しずつ明るくなります。
- 　6つの設定を動かして変化を見極めて下さい。注意：その幾つかはJzの調整、⟨対数符号化Jz⟩、⟨シグモイド
  Jz⟩、"JzCzHzによる画像調整"と組み合わせて使用しないと効果が現れません。
- 　これら設定の効果はコンソールで見ることが出来ます、例えば以下の様に：

La=250.0 PU_adap=1.6 maxi=0.018249 mini=0.000016 mean=0.002767,
avgm=0.249170 to_screen=42.941518 Max_real=0.783651 to_one=1.276078

上記の内：

"to_screen" は実際の処理でJzに適用される乗数

"to_one"
はJzの範囲を０～1.0に収めるために、カーブや関数に適用する2次乗数

#### HDR用の機能、シグモイド Jzと対数符号化 Jz

　対数符号化のJz版の概念と通常の対数符号化の概念は似ていますが、輝度の査定方法が異なります。通常の対数符号化はRGB色空間で動作し、査定が不完全な場合に色相にずれが生ずることがあります。

　一方、対数符号化のJz版は輝度の査定にCAMの様な特性を持つJzを使います。色の変化はJzazbzの開発者が導入した変換マトリクスによるものだけです。Jzで実行される査定の結果はCAM16の様に優れていて色相のずれが生じません。

　輝度の構成でRGBではなくJzを選択すると、"場面条件の平均輝度（Yb％）"と"観視条件の平均輝度（Yb％）"の値の考慮の仕方も変わります。特に２つのグレーポイントの計算が変わります。

　対数符号化JzとシグモイドJzに関しては、デモザイク処理直後の画像データを使って、a）ブラックEv（画像の最も暗い部分）、b）ホワイトEv（画像の最も明るい部分）、c）場面条件の平均輝度（Yb％）を計算し、査定します。

- 　これらの値は対数モードで使われ、輝度Jzは（log2(Jz)‐ブラックEv）/ダイナミックレンジで表せます。
- 　対数符号化Jzに関しては、値を線形にするために対数方程式に対する一意的な解がa）、b）、及び観視条件の平均輝度（Yb％）から求められます。c）の値は、この計算には影響しませんが、コントラストの配分に影響します。次に説明するシグモイドは異なります。

**シグモイドJz**
<img src="/images/Sigmoidjz1.jpg" title="Sigmoidjz1.jpg" width="600"
alt="Sigmoidjz1.jpg" />

- 　"色の見えモデル02/16＆Jzazbz"のシグモイドJzも参照して下さい。
- 　 Rawファイルe (Rawtherapee - Creative Common Attribution-share Alike
  4.0):
  [28](https://drive.google.com/file/d/1ziux382pWgdYa4jySimwKaKnK_KdDhno/view?usp=sharing)

　前述の通り、HDR画像（本例のダイナミックレンジは14.8Ev、絶対輝度は2000カンデラ毎平方メートル）をSDRモニター（ダイナミックレンジ7Ev、絶対輝度120カンデラ毎平方メートル）にそのまま表示することは出来ません。何らかの妥協が必要です。対数符号化Jz、或いはシグモイドJzを使えば、色相は維持されますが、シャドウ、中間トーン、ハイライトの配分はユーザー自身が好みに合わせて調整するよりありません。また、対数符号化Jzを使った場合、場面条件の平均輝度（Yb％）はコントラストの変化に強い影響を与えます。観視条件の平均輝度（Yb％）は画像全体の輝度に影響します。他の2つの設定、ブラックEvとホワイトEv（対数）も、場面条件の平均輝度同様、シャドウとハイライトの配分に影響します。もちろん、結果はこれら6つの設定値と画像次第で変わります。

## 原理全般

### RT-スポットのオブジェクト指向プログラミング

　冒頭で述べた様に、このシステムはNik
Software©によって開発されたアプリケーションに近いものですが、大きな違いは：

- 　画像（全体）の中に部分的に作成した各RT-スポットは、それぞれを一つの画像と見做すことができ、それぞれで最大640種類に及ぶ編集操作が可能です。機能水準を“基本”にすれば、使用頻度の高い160種類の操作に絞ることが出来ます。また、使用する機能は有効にも無効にもできます。編集は、スライダー、カーブ、コンボボックス、オプション、拡張、マスクなどを使って行います。
- 　RT-スポットで使える編集機能は次の通りです：⟨色と明るさ⟩、⟨シャドウ/ハイライト&トーンイコライザ⟩、⟨自然な彩度‐ウォーム/クール⟩、⟨対数符号化⟩、⟨色の見え
  (CAM16＆JzCzHz)⟩、⟨ダイナミックレンジ&露光補正⟩、⟨共通のカラーマスク⟩、⟨ソフト&独自のレティネックス⟩、⟨ぼかし/質感
  &ノイズ除去⟩、⟨トーンマッピング⟩、⟨霞除去&レティネックス⟩、⟨シャープニング⟩、⟨ローカルコントラスト&ウェーブレット⟩、⟨詳細レベルによるコントラスト調整⟩。尚、色の見え（CAM16＆JzCzHz）に関しては、[色の見えモデル02/16&Jzazbzの](ciecam02/jp)解説も参照して下さい。
- 　RT-スポットは、GIMPなどのソフトウェアで使われる"レイヤー"と同等に見做すことが出来ます。各RT-スポットは透明なので、重なり合うことがあっても、その部分では前のRT-スポットによる編集結果を考慮しながら、次のRT-スポットによる編集作業が出来ます。また、後のRT-スポットで"除外"モードを使うと、重なり合う部分では前のRT-スポットによる編集がキャンセル（つまり、リバースモードに似た効果）され、その部分が元の画像になります。
- 　画像全体を対象とした通常の編集では、その作業にRGBとL\*a\*b\*のどちらも使えますが、RT-スポットの編集作業で使えるのはL\*a\*b\*だけになっています。
  - 　これに対し、ユーザーの中には「何故、扱えるダイナミックレンジが7EvしかないL\*a\*b\*なのか？」と疑問を持つ人もいるでしょう。しかし、実際には、7Evの制限は、８ビットでプログラムされている出力ICCプロファイルにだけ適用されるものです。また、色度を大きく調整した際に生じる色ずれ（特に、ブルーとパープル間、レッドとオレンジ間）の問題は、その後に何の補正も施さなかった場合の問題です。
  - 　しかし、32ビットリアルモードでL\*a\*b\*の計算を行い、RawTherapeeに備わっているマンセル補正（色ずれの回避）を組み合わせれば、こう言った問題の殆どは解決されます。残る問題はHDR画像の高輝度部分の処理だけです。筆者が行ったHDR画像に関するテストによれば、L\*a\*b\*は15Ev以上のダイナミックレンジでも処理出来ますが、これ自体一般のSDRモニターの表示能力を遥かに上回るものです。仮にHDR画像を表示できるモニターが手に入るのであれば、試験的に導入したJzCzHzモジュールを使ってHDR画像の処理を行うことが可能です。
  - 　更に詳しい情報が、"\[<http://rawpedia.rawtherapee.com/Toolchain_Pipeline/jp#%E6%B8%AC%E8%89%B2-%E8%89%B2%E3%81%AE%E8%A6%8B%E3%81%88%E3%83%A2%E3%83%87%E3%83%AB%E3%81%A8L*a*b*%E3%81%AE%E9%87%8D%E8%A6%81%E6%80%A7>　測色‐色の見えモデルとL\*a\*b\*の重要性\]"の節にあるので参考にして下さい。

<!-- -->

- 　RT-スポットのオブジェクト指向プログラムは"for文"（初期化、条件、繰り返し）で管理されています。
- 　機能のコードに重複はありません。例えば、⟨ぼかし/質感&ノイズ除去⟩の"ノイズ除去"は、ウェーブレットによる分解の回数を上げるために、ディテールタブの⟨ノイズ低減⟩と同じ機能を使っています。⟨霞除去＆レティネック⟩などに関しても同じことが言えます。一方、⟨色と明るさ⟩などのように、露光補正タブのそれとは異なるコードを持つモジュールも幾つかあます。
- 　ローカル編集の多くの機能は他の編集タブで使われる機能と重なっていますが、新たに追加された機能もあります。
  - 　⟨シャドウ/ハイライト＆トーンイコライザ⟩のモジュールにある⟨トーンイコライザ⟩或いは⟨トーンリプロダクションカーブ（TRC）⟩です。これらを使えば露光補正の際に微妙な違いを付けることが出来ます。
  - 　⟨ソフトライト＆独自のレティネックス⟩は覆い焼きと焼き込みが出来ます。
  - 　⟨対数符号化⟩は単純な対数符号化を使った一種の"トーンマッピング"と言えます。
  - 　⟨自然な彩度＆ウォーム/クール⟩のウォーム/クール機能は、メインの⟨ホワイトバランス⟩の色温度の調整に似た働きをします。
  - 　⟨ぼかし/質感＆ノイズ除去⟩は、ぼかしをかけたり、逆に質感を高めたり、ノイズの様なザラつき感を加えたり出来ます。
  - 　⟨色の見えモデル（CAM16&JzCzHz）⟩のシグモイド関数を使ったJzCzHzとCAM16、その他の高度な機能は将来的なHDR画像の処理に道を開いた機能です。
  - 　⟨ローカルコントラスト&ウェーブレット⟩のモジュールには多くの新しい機能（トーンマッピング、減衰応答、明瞭など）が追加されています。

### 編集領域の境界‐RT-スポットの概要

　
ローカル編集を有効にして、RT-スポットを"追加/作成"すると画面にRT-スポットが表示されます：

- 　
  RT-スポットの中央には中心円があり、直径の大きさを変えることが出来ます。位置はマウス或いはスライダーを使って変えます。
- 　RT-スポットの外枠には4つの境界節点が設けられていて、その位置をマウスやスライダーで変えることが出来ます。各境界節点の位置を変えることで、編集目標領域を適切に囲むことが出来ます。
- 　4つの境界節点で仕切られたRT-スポットの領域内で様々なアルゴリズム（色と明るさ、シャドウ/ハイライト&トーンイコライザなど）が働きます。また、アルゴリズムの動作にが"インバース"モードが適用されていない限り、形状検出や構造検出のアルゴリズムも、この領域で動作します。
- 　境界節点の位置を"入れ替える"（例、上と下の節点）ことは出来ません。理由は二つあります。一つは、それを可能にするためのユーザーインターフェースの改良が簡単ではないこと。もう一つの理由は更に複雑で、それを可能にするためのアルゴリズムの改良が大変だからです。

　RT-スポットの境界節点は画像（プレビュー領域）の外側に置くことも出来ます。RTスポットのタイプが"画像全体"であれば、境界節点は常にプレビュー画像から大きくはみ出した外側になります。

### 3種類の諧調調整

　RT-スポットのオブジェクトは3種類の諧調をベースにしています：

- 　非対称による諧調：RT-スポットの４つ境界節点を中心円から非対称的に配置することが出来るので、RT-スポット囲まれた領域内で自然な諧調を作り出せます。
- 　作用の推移による諧調：RT-スポットの中心円から外枠に向かって作用を減衰させて諧調を作ります。
- 　色の違い（ΔE）による諧調：⟨スコープ⟩のスライダーを使って、ΔE　‐　中心円の色の基準値（輝度、色度、色相）と目標ピクセルの色の違い　‐　の大きさに応じて作用の範囲を調整し諧調を作ります。低い値ほど色の違いによる作用の制限が強くなり、高い値（80以上）ほど制限が弱くなります。スコープの値を100にすると制限がなくなり全ての色に作用が及びます。

　以上3種類の諧調は、どの機能（色と明るさ、詳細レベルによるコントラスト調整、トーンマッピングなど）においても組み合わせて使うことが出来ます。また、各機能の多くは独自の諧調フィルタ機能も持っています。どの諧調に関しても、諧調の基準となるのはRT-スポットの中心円の画像データです。

### RT-スポット　4つのタイプ

　RT-スポットには4つのタイプがあります：

- 　標準スポット：デフォルトで設定されているタイプのRT-スポットです。このタイプは、2つ目のRT-スポットが追加/作成されても、1つ目のRT-スポットで行われた編集が変わることはありません。従って、1つ目のRTスポットと重なる領域に２つ目のRT-スポットが追加/作成され、そこで編集が行われると、重なる部分では１つ目のRTスポットで行われた編集結果に対して追加的な編集になります。ビットマップ系ソフトのようなレイヤーを被せる編集ではなく、再帰呼び出しを使った編集です。
- 　除外スポット：このタイプは、編集した画像を元の画像に戻すことが出来ます。従って、１つ目のRTスポット（標準スポット）と重なる領域に、２つ目のRTスポットが除外モードで追加/作成されると、１つ目のRTスポットで編集された画像部分が元画像に戻ります。但し、RTスポット（除外モード）の中心円の基準値は、そのRT-スポットで別な編集が行われた場合のために保持されています。また、このモードのRTスポットは、幾つかの機能モジュールに備わっている“インバース“オプションに似た働きをするためにも使えます。
  - 　原理はCapture
    NX2©の"Counterpoint"に似ています。不要な部分に及んだ編集効果を取り去る、或いは特定の部分に効果が及ばないようにしたい場合に使います。例えば、ポートレート画像で、初めのRTスポットで全体的に彩度を増やしたが、目や露出の異なる部分は元のままに維持したいので、目や露出の異なる部分に除外スポットを適用して彩度を元に戻します。
  - 　使われているアルゴリズムは、ローカル編集の至る所で使われているアルゴリズムと似ています。ΔEの違いと画像の構造（Sobel‐Canny変換を応用）をベースにしています。完璧ではありませんが、上記に示した例の様なケースで7割程度は満足のいく結果が得られると思います。
  - 　除外スポットはどの様に使うのか？：
    - 　前のスポットで行った編集に対してその効果を除外したい部分に新しいRTスポットを作成します。
    - 　"設定"パネルで、RTスポットのタイプを"除外スポット"にします。
    - 　目標の効果が得られるように、⟨RTスポットのサイズ⟩をはじめ、⟨スコープ⟩、⟨境界値⟩、更にRT-スポットの４つの境界節点を調整します。更に微調整が必要であれば、⟨色と明るさ⟩機能などを追加して微調整を行います。
    - 　画像によっては（ΔEの違いが小さい画像など）、"形状検出"の中の⟨ΔE‐スコープのしきい値⟩スライダーをデフォルトより下げる必要があるかもしれません。
  - 　除外スポットを使って"インバース"モードの効果を真似る：
    - 　機能モジュールの中には⟨インバース⟩モードのオプションを備えているものがあります。基本的には、モジュールの機能をRT-スポットの内側ではなく外側に働かせるモードです。例えば、RT-スポットの内側を明るくする編集を行った後に、このインバースモードを有効にすると、内側は元に戻り、外側の画像が明るくなります。
    - 　これと同じ効果を、除外スポットを使って作ることが出来ます。つまり、"インバース"オプションを備えていないモジュールでも同じことが出来るということです。手順は簡単です：
      - 　RT-スポットのタイプを"画像全体"にするか、或いは標準タイプのRT-スポットで4つ境界節点を手動で画像の外側に配置し、画像全体を囲むようにします。
      - 　先の例のように⟨色と明るさ⟩の機能を使って画像を明るくします。上記の設定によって、RT-スポットが画像全体を囲っているので、一部ではなく全体が明るくなります。
      - 　そして、この編集（明るくした）をキャンセルしたい部分に、除外タイプのRT-スポットを追加/作成して配置します。必要であれば⟨スコープ⟩の値を調整します。
      - 　これで、先に挙げた"インバース"オプションに近い効果を得られますが、注意点が2つあります：
        - 　ほぼ似たような効果が得られるものの、作用のあり方が異なるので結果が"全く同じ"になることはありません。効果が及ぶ領域が異なるからです。
        - 　また、除外スポットを使うと言うことは、それにより囲まれた領域の画像が元画像に戻ることを意味し、除外スポットの適用前に行われていた編集は全てキャンセルされます。
  - 　目標とする編集領域の画質が均一な場合（例えば青空）、"スポットの構造"スライダー（一部の機能で使用可）が編集領域選別の助けになるでしょう。

<!-- -->

- 　画像全体を対象とするスポット
  - 　画像全体が編集対象になり、通常の編集（ローカル編集を有効にしていない）と似たような作業を行うことが出来ます。異なる点は、編集の際にΔEを考慮することが出来るので、より精度の高い調整が可能です。ΔEを考慮したくない場合は、⟨スコープ⟩の値を100にすることで影響がなくなり、通常と同じ状態で編集が行えます。
  - 　このタイプのRT-スポットの形状は長方形で、4つの境界節点は自動的に画像の外側に配置されます。目標とする効果に合わせてこれらの節点を動かすことが出来ます。
  - 　画像全体を対象にすることから、デフォルトでは⟨変移の位置⟩が100％に設定されます。従って、変移の位置に基づく階調効果はありませんが、階調を付ける場合は境界値を変更します。
  - 　上記の2つのRTスポット同様に、このRTスポットもΔEが考慮されるので、画像（全体）のレンダリングは中心円の位置次第で変わります。RTスポットの中心円の位置と、その直径の大きさで編集のための基準値が算出されます。
  - 　画像全体を編集対象とするRTスポットの使用には注意が必要です。例えば、⟨ぼかし/質感＆ノイズ除去⟩の"ノイズ除去"や、⟨ローカルコントラスト＆ウェーブレット⟩の"ウェーブレット"、⟨霞除去とレティネックス⟩の"レティネックス"はメモリー消費量が大きい機能なので、画像のサイズ次第で応答が鈍くなるかもしれません。スムーズな応答確保には、８或いは16メガ以上のRAM容量が必要でしょう。また、高速フーリエ変換を利用する際にも多くのメモリーが使われます。

<!-- -->

- 　グローバル
  - 　このタイプを選ぶと、ローカル編集以外の機能と同じように、画像全体を対象にした編集が行えます。
  - 　但し、他のタイプのRT-スポットとは異なり、"ΔE"や"変移の階調"のアルゴリズムは適用されません。従って、このモードの作用は従来のRawTherapeeの他の機能と似たようなものになります。
  - 　"諧調フィルタ"など、幾つかの機能の作用はRT-スポットの中心円の位置次第で変わります。
  - 　このモードを選択した場合、編集のために追加する機能全てにこのモードが適用されます。
  - 　グローバルモードで行った編集に対し、別なRT-スポットを"通常スポット"、quot;除外スポット"、或いは"画像全"で追加して部分的な編集を加えることが可能です。

<!-- -->

- 　環境設定の一般タブの"ローカル編集のスポットの方式を決める"で、デフォルトのRT-スポットのタイプを定義することが出来ます。

### 3つの機能水準

　各機能モジュールには、機能の水準（基本、標準、高度）を変えるドロップダウンメニューが備わっています。

- 　基本：デフォルトで設定されている水準で、編集で使われる頻度の多い機能の大半は基本モードにも含まれています。但し、マスク機能は含まれていません、また、カーブも僅かです。
- 　
  標準：基本に幾つか機能を追加して強化した水準です。例えば、〈諧調フィルタ⟩、カーブや単純なマスク機能が追加されています。
- 　高度：ローカル編集のための機能が全てそろっている水準です。経験を積んだユーザーが使う機能が含まれています。例えば：
  - 　⟨色と明るさ⟩機能には"ファイルの融合"というPhotoshop©のレイヤーの融合に近い編集機能が備わっていて（ここで言うレイヤーは本プログラムではRTスポットのことです）、差異、乗算、ソフトライトなどのモードが使えます。
  - 　機能を追加したマスク：高度な編集を行うための、⟨構造のマスク⟩や⟨マスクぼかし⟩などが備わっています。

### 色相/色度/輝度による基準値とアルゴリズムの原理

　RawTherapeeの強力な形状検出アルゴリズムは以下をベースにしています：

- 　
  RT-スポットの中心円が基準値を決定する部分です。その直径の大きさに応じて、円内の色相、色度、輝度が計算されます（但し、ノイズ除去機能が使われる場合は、ノイズの影響を軽減するために、計算の前に円内部分に若干のぼかしをかけます）。
- 　中心円の直径の大きさは編集の目的に応じて変えます。例えば、RT-スポットの中の葉を編集したい場合は、他の（例、花びら）色や輝度に影響を与えず、葉の色や輝度だけを調整したいので直径は小さくするべきでしょう。一方、人物の顔の肌などの編集では、シミやまつ毛、目など異なる情報を含めて全体的に編集（例えば、明るくする）をしたいので直径は大きくするべきでしょう。目だけ元のままにしておきたい場合は、前述の"除外"モードを使ったRT-スポットで補正します。
- 　RT-スポットの領域は4つの象限に分けられ、各象限で以下の様にアルゴリズムが働きます：
  - 　中心円領域と目標ピクセルのΔE（色相、色度、輝度を考慮した２色間の知覚的違い）を計算します。
  - 　上記のΔEに基づいて、作用の影響力を減衰させます。減衰の強さは"形状検出"パネルの中の⟨ΔEの減衰⟩のスライダーで調整します。１は線形的、２はパラボリック、と徐々に強くなります。

上記の基準値を使って、RT-スポットの画像に対する編集作用に差を付けます。例えば、ΔEの算出基準となる中心円を葉の上に置けば、RT-スポットの内の他の色（例、空の色）に影響を与えずに、スポット内の全ての葉の編集（例、葉の色度を上げる）が一度に出来ます（lassoタイプのソフトウェアにはこれが出来ません）。

- 　
  ⟨変移の位置⟩のスライダーで作用が及ぶ範囲を変えることが出来ます。例えば、スライダーの値を50にすると、中心円からRT-スポットの外枠までの距離の半分に相当する領域では編集が100％作用し、半分から外枠に向かう領域では編集作用が徐々に減衰していきます。デフォルトでは線形的な減衰が設定されていますが、⟨変移の減衰⟩のスライダーでパラボリックなどに変えられます。
- 　
  ⟨スコープ⟩はΔEに応じて編集領域を選別する機能です。設定値を大きくするほど、ΔEによる選別が緩くなり、編集作用が及ぶ領域が増えていきます。スコープの値が80以上になると、ΔEが徐々に無視されるようになり、100で完全に選別されなくなり、RT-スポット内の全てのピクセルに編集作用が及ぶようになります。但し、一般的には、80以上の設定は特殊な場合（例、輝度の階調だけを変えたい）を除いて行わない方がいいでしょう。
- 　逆に、スコープの値を下げると、ΔEによる領域の選別が厳しくなり、中心円の基準値に近いピクセルであっても編集作用が及びません。例えば、同じ花びらの色でも陰影の違いで作用が及ばない花びらの色が出てきます。

　形状検出のアルゴリズムは基本的に、標準スポットで使うように設計されています。一部の機能ではインバースモードでも使えますが、制限も出ます。例えば、⟨色と明るさ⟩でインバースモードを使うと：

- 　カラー補正グリッドが使えない
- 　カーブの種類が少なくなる
- 　"ファイルの融合"が使えない

#### 基準値を繰り返し更新する

　"特有の設定"パネルの中の"基準値を繰り返し更新"オプションを有効にすると：

- 　同じRT-スポットで、複数の機能を使う場合、機能が追加される度に色相、色度、輝度、Sobelフィルタで算出される基準値が更新されます（オプションが無効の場合は、初めの基準値が維持されています）。
- 　 C(C)、 L(L)、LC(H) のマスクで表示される基準値とh(H)も更新されます。

#### ΔEの活用

　ΔEの算出には最も単純な方式を用いています。L\*a\*b\*の構成要素である、L\*が0から100、a\*が-128から+128、b\*が-128から+128の範囲ならば：

- 　Lc、ac、bcを現在のピクセル値、Lr、ar、brを基準値（LCHの基本値からの変換）とすれば
- 　ΔE = sqrt(SQR(Lc - Lr) + SQR(ac - ar) + SQR (bc - br))と表せます。
- 　従って、前述の⟨ab-Lのバランス⟩、⟨C-Hのバランス⟩、⟨ΔEの減衰⟩を使って、効果を調整できます。

スコープ値との対応：

- 　スコープとΔE、ΔEの減衰、ΔEとスコープのしきい値との間には関係があります。
- 　ΔEとスコープのしきい値は、作用するピクセル値の範囲を調整する機能です：
  - 　デフォルトは2に設定されています。この場合ΔEの値の範囲は2～155になります。
  - 　しきい値を下げるとΔEの最大値が130まで下がります。逆に上げると最大値が230まで上がります。明るく鮮やかな花の画像のように色域の変化が非常に大きい場合には、一般的には、しきい値の幅を広くするのが適当です。
    - 　但し、ΔEを最大値230にするのはかなり特殊なケースです。例えば、L\*が80、a\*が158、b\*が145の場合などの様に、明るく鮮やかな花の色、或いは人工色が多い画像で、しかも調整範囲が非常に大きく、輝度や色度を著しく増やした画像です。

ΔEのしきい値が2の場合

- 　ΔEの範囲は2（スコープ値＝0）から155（スコープ値＝100）です。もちろん、最小・最大の範囲を上記で説明したように、任意に変えることは出来ますが、殆どのケース場合この範囲で十分な効果が得られます。
- 　ΔE=2という色の差は人の目では認識できませんが、認識することが目的ではありません。
- 　ΔE=155は非常に高い値です。例えば、"a\*"（グリーンとレッドの補色次元）の差が80、"b\*"（ブルーとイエローの補色次元）の差が80、"L\*"（輝度）の差が80、或いはL\*の差が50、a\*の差が105、b\*の差が100といったケースです。

　"スコープ"が15に設定された場合、ΔEが３より小さいピクセルには機能モジュールの作用が100％働きます。ΔEが27.5より大きいピクセルには作用が及びません、ΔEが3以上、27.5以下のピクセルには作用が27.5に近づくにつれ減衰します。

- 　ΔEが3になる組み合わせは、基準値（中心円）との差が例えば以下の様な場合です：
  - 　L\*の差が2
  - 　a\*の差が1
  - 　b\*の差が2
- 　ΔEが15になる組み合わせは、例えば以下の様な場合です：
  - 　L\*の差が10
  - 　a\*の差が9
  - 　b\*の差が6.6
- 　ΔEが27.5になる組み合わせは、例えば以下の様な場合です：
  - 　L\*の差が15
  - 　a\*の差が14
  - 　b\*の差が18.3

　"スコープ"の値が50の場合は、ΔEが4.5より小さいピクセルに作用が100％働き、ΔEが80より大きいピクセルには作用が及ばす、ΔEが4.5以上、80以下のピクセルには作用が80に近づくにつれ減衰します。

#### 選別された領域のプレビュー（ΔEのプレビュー）

　設定パネルにある⟨ΔEのプレビュー⟩ボタンを押すと、ΔEで選別された編集作用が及ぶ領域が薄いグリーン（デフォルト）で表示されます。但し、このプレビュー機能は変移の位置を考慮していません。選別された範囲の表示色及びその濃さは、⟨
ΔEのプレビューカラー　強さ⟩のスライダーで変えられます。ΔEのプレビューで視覚化される編集領域は、輝度やコントラストを変える調整だけで、色を変えるカーブやスライダーの調整は反映されません。しかし、"形状検出"パネルの中のスライダー；⟨ΔE‐スコープのしきい値⟩、⟨ΔEの減衰⟩、ab-Lのバランス⟩、⟨C‐Hのバランス⟩、⟨
ΔEのプレビューカラー　強さ⟩の調整は反映されます。

　設定パネルの中のΔEのプレビューが使えるのは、作成されたRT-スポットに追加された機能（例えば、色と明るさ）が一つだけの場合です。そこに別な機能（例えば、ダイナミックレンジ＆露光補正）が追加された時には、その機能モジュールの中の"マスクと修正"パネルのコンボボックスの中にあるΔEのプレビューを使います。

### 設定パネルの異なるオプションの概略

　設定パネルの中の全ての設定はRT-スポットの操作に共通しています。例えば：

- 　どの様な機能モジュール（⟨色と明るさ⟩、⟨ダイナミックレンジ＆露光補正⟩、など）をRT-スポットに追加しようとも、"変移の階調"の設定は同一の設定です。
- 　特定の機能だけに属した設定は、その機能モジュールの中で扱います。例えば、⟨色と明るさ⟩、⟨シャドウ/ハイライト＆トーンイコライザ⟩及び⟨自然な彩度＆ウォーム/クール⟩以外のΔE（スコープ）は各機能モジュールにあるそれを使います。

#### RT-スポットの操作に関する機能

　ローカル編集の最初にあるのがRT-スポットに関する５種類の設定です。

- 　追加/作成
- 　削除
- 　複製
- 　（選択したRT-スポットの）名前変更
- 　（選択したRT-スポットの）表示/非表示

#### RT-スポットの形状に関する機能

　RT-スポットの形状はドロップダウンリストから楕円形か長方形かどちらか選択します。殆どの場合、形状による効果の差は小さいものです。デフォルトは楕円形です。RT-スポットのタイプが"画像全体"の場合は、形状は常に長方形になります。

#### RT-スポットのタイプに関する機能

　"スポットのタイプ"はドロップダウンリストから、"標準スポット"、"除外スポット"、"画像全体"の3つから選びます。デフォルトは標準スポットになっています。RT-スポットで使う目的の機能を、最下段にある"現在のスポットに追加する機能"のドロップダウンリストから選択します。

#### RT-スポットの中心円の大きさに関する機能

　殆どの場合、デフォルトで設定されている半径の大きさで十分です。小さい半径は⟨スコープ⟩と組み合わせて使う方がいいでしょう。例えば、RT-スポット内の木の葉の色を調整する場合です。大きい半径は基準値（色相、色度、輝度）の計算が小さい変化に対して緩くなるので、肌の色を調整する場合などに有効です。

#### 変移の階調に関する機能

　4つのスライダーを使って下記の調整が出来ます：

- 　⟨変移の位置⟩：このスライダーは中心円から外枠までの距離を100％として、中心円からその途中までの距離を、“x％”で表したものです。x%を超えた外枠までの範囲では、使用する機能の作用が徐々に弱くなります（外枠及びその外側では0）。その結果、効果が表れる領域は次の3つのゾーンに分けられます（注意点：各アルゴリズムにおいてモードをインバースにした場合は、効果が逆になります）：
  - 　ゾーン0：RT-スポットの外側の領域。この領域では機能は作用しません。
  - 　ゾーン1：x%の位置から外枠までの範囲を指します。使用する機能の作用が外枠に近付くにつれ減衰します。
  - 　ゾーン2：RT-スポットの中心円からx％で定められた位置までの範囲を指します。使用する機能が100％作用します。

　補足：変移の位置を非常に小さくすれば、画像の欠損箇所の補正などに役立てられます。

- 　⟨変移の減衰⟩：上記のゾーン1における減衰の度合いを設定します：1は線形的な減衰で、2はパラボリック、3から25までは指数的に減衰します。
- 　⟨XY軸方向による変移の差別化⟩：スライダーの値が0以外の場合、X軸方向とY軸方向で階調を施す領域に差が出ます。マイナスの値を設定するとY軸方向の領域が減ります、プラスの値はその逆です。
- 　⟨フェザー処理（階調フィルタ）⟩：機能モジュールの中には⟨階調フィルタ⟩を備えているものがあり、それを使った際にこのフェザー処理を組み合わせることが出来ます。RT-スポットの対角線に対する割合で効果が変わります。

#### 形状検出に関する機能

　これは冒頭の方で解説した、3種類の諧調調整の一つ、"色の違い（ΔE）による諧調調整"に関わる機能です。

- 　⟨ΔEの減衰⟩：ΔEをベースにしている諧調作用の減衰率の強さを、べき乗関数を使って変えるスライダーです。1は線形で、それ以上はべき乗的に作用が減衰します。最大値は10です。高い値は色域が非常に広い画像に適しています。
- 　⟨ΔE‐スコープのしきい値⟩：⟨（カラー機能の）スコープ⟩の感度を変えるためにΔEの値を微妙に調整するスライダーです。高い値は、色域の限界に近い色の画像（例えば、花の色や人工色など）に適しています。
- 　⟨ΔEのab-Lバランス⟩：値が1（デフォルト）の時は、ΔEを算出する際に、L\*a\*b\*の3つ構成要素（L\*、a\*、b\*）を等しく考慮しますが、値を高くするとL\*に対する比重が増えます。低い値はその逆で補色次元（a\*とb\*）に対する比重が増えます。
- 　⟨ΔEのC-Hのバランス⟩：
  値が1（デフォルト）の時は、ΔEを算出する際に、色度と色相を等しく考慮しますが、値を高くすると色相に対する比重が増えます。低い値の場合はその逆です。
- 　⟨ΔEのプレビューカラー　強さ⟩：これは⟨ΔEのプレビュー⟩の表示色を変える機能です。デフォルトはグリーンです。スライダーを左に動かすと色がブルーになります（編集対象がグリーンの場合に見分けがつけ易くなります）。スライダーの位置を両サイドに近付けるほど表示色が強くなります。

#### 色ずれの回避

　マンセル補正を適用する前に、色域から外れているピクセルを作業プロファイル（L\*a\*b\*）の中に収める試みを行うオプションです。多くの場合、"色ずれの回避"と"マンセル補正だけ"のオプションを組み合わせて使うことを勧めます。そうすることで、画像の彩度を編集する際のL\*a\*b\*の弱点（特定色の色ずれ）を補い、露出オーバーの画像で色域の制御がアーティファクトを発生させるのを防ぎます。

#### 編集を白黒で行う

　ローカル編集を使う前に、メインの白黒モジュールや白黒のフィルムシムレーションで編集を行った場合は、ローカル編集の際に再び色が表示されないようにするオプションです。

#### 基準値を繰り返し更新

　同じRT-スポットに機能を追加する度に、中心円の基準値を再計算させるオプションです。

#### RT-スポットの変形方法

　RT-スポットの形状を調節する方法は4つあります。"特有の設定"パネルを開き、"スポットの変形方法"のコンボボックスから選択します。

- 　4つの境界節点を独立で変える （マウスのみ使用） - デフォルト
- 　4つの境界節点を左右、或いは上下で対称的に変える（マウスのみ使用）
- 　4つの境界節点を独立で変える（マススとスライダーを使用）
- 　4つの境界節点を左右、或いは上下で対称的に変える（マススとスライダーを使用）

#### ウェーブレットのマザー関数の変更

　RT-スポットの画像をウェーブレットで分解する際のマザー関数、Daubechies関数の係数の等級を変えるオプションです。等級はD2（Harrの関数と同等）からD20までありますが、D2（低）、D4（標準）、D6（標準＋）、D10（中間）、D16
（高）の5つの中から選択します。等級が上がるにつれウェーブレット分解による画像の詳細の判別が強くなります。処理時間も多少増えますが、無視できる程度です。効果の程は小さく無視できるものです。

　係数の選択と編集結果の質の間に直接的な関係はありませんが、画像に応じて適切な係数を選択することで、細かい詳細部分と残差画像の質を上げることが出来ます。

- 　通常はD6以上の係数を使うのがいいでしょう。
- 　但し、画像によってはD2がベストな係数になることもあります。

#### マスクと融合

　"マスクと修正"機能を持つモジュール（表示のためにはモジュールの機能水準を標準以上にする必要があります）でマスクが使用する時に（例えば、LChカーブ）、"マスクと融合"パネルに含まれる設定を使うことが出来ます。

- 　"ΔE画像のマスク"のオプションを有効にすると：
  - 　編集領域が変化してしまわないように、以下のマスク機能が使われた場合にはΔEを考慮します。ガンマ、スロープ、色度、コントラスト、（ウェーブレットのレベルに応じた）ローカルコントラスト、ぼかしのマスクと構造のマスク。
  - 　インバースモードが使われた時は無効になります。
- 　スコープ（ΔE画像のマスク）：マスクを作成した時にΔEを考慮するもので、マスクによる選別の精度上げるものです（このスコープの作用は他のスコープに影響しません）。マスクツール（色度のマスク、ガンマのマスクなど）の何れかが使用されると働きます。
- 　色ノイズのマスク：マスクの色ノイズを抑制する設定です。特にLC(h)カーブが使われた時に、色ノイズを抑制し、アーティファクトが発生するのを回避します。
- 　背景の色/輝度のマスク："マスクと修正"のコンボボックスで"修正された領域をマスクと共に表示"が選択された場合に、マスクの背景色のグレーの濃さを調整する設定です。

### 補完的アルゴリズム　‐　ソフトな半径

　以下の機能モジュールは作用が強くなり過ぎることがあるので、それを和らげるための機能です（機能水準を標準以上にする必要があります）。

- 　色と明るさ
- 　ダイナミックレンジ&露光補正
- 　詳細レベルによるコントラスト調整

　元画像と編集画像の輝度の違いにガイド付きフィルタを使って行き過ぎた作用を和らげます。

　補足：このアルゴリズムは⟨シャドウ/ハイライト＆トーンイコライザ⟩の一部にも組み入れられています。

### 補完的アルゴリズム　‐　諧調フィルタ

　このアルゴリズムは露光補正タブの⟨減光フィルタ⟩をベースにしていますが、更に2種類の諧調調整機能を加えました：

- 　色度：色度を変えて色の諧調を施すことが出来ます（例、空や人物画像）。
- 　色相：色相を変えて色相の諧調を施すことが出来ます（例、風景画像、微調整、特殊な効果）。

　基本操作の説明のなかの[諧調フィルタを施すに](local_controls/jp#輝度、色度、色相をベースに階調フィルタを施す)例があります。

下記の機能モジュールは幾つかの"諧調フィルタ"を備えています。

- 　色と明るさ：輝度、色度、色相
- 　ダイナミックレンジ&露光補正：輝度
- 　シャドウ/ハイライト＆トーンイコライザ：輝度
- 　自然な彩度‐ウォーム/クール：輝度、色度、色相
- 　ローカルコントラスト＆ウェーブレット：ウェーブレットをベースにしたローカルコントラスト

　RT-スポット内の諧調の幅を変える⟨フェザー処理⟩は設定の"境界の諧調調整"パネルの中にあります。

　今のところ、諧調フィルタの角度を変えるためにマウスは使えません。スライダーでその角度（‐180°から＋180°）を設定します。
諧調フィルタを使用しても、境界値やスコープの設定に影響はありません。

### 補完的アルゴリズム　‐　ファイルの融合

　⟨色と明るさ⟩のモジュールには、"ファイルの融合"というオプションが備わっています（機能水準を高度にする必要があります）。4種類の融合が可能です：

- 　なし :
  融合は実行されません。マスクを含むRawtherapeeの全ての機能が通常通りに動作します。
- 　元画像 : 現在のRT-スポットの画像を元画像と融合します。
- 　前の画像:
  現在のRTスポットの画像と一つ前のRTスポットの画像と融合します。
- 　背景：
  現在のRTスポットの画像と選択した背景色（色相と色度）と背景の輝度を融合します。

　"ファイルの融合"機能を使った例が、[RT-スポット（レイヤー）の融合にあります](local_controls/jp#ブレンドモードを使ったスポット（レイヤー）の融合)。

#### 背景オプションを使ってブラシ効果を真似る

　手順：

- 　小さい大きさのRT-スポットを作成
- 　⟨境界値⟩の設定値を非常に小さくする
- 　⟨境界値の減衰⟩の設定値を高く設定する
- 　RT-スポットを複製する

#### マスクの使用・未使用に関わらない、ファイルの融合のタイプ

　どの場合も、スコープと境界値には影響しません。

融合の方法は、Photoshop©やGIMPのブレンドモード機能に似たものです：

- 　通常、減算、差分、乗算、追加、除算、旧ソフトライト、ソフトライトイリュージョン、ソフトライトW3C、強光、オーバーレイ、スクリーン、暗くするだけ、明るくするだけ、除外、色相、彩度、色、輝度、が用意されています。
- 　ファイルを融合する割合は⟨不透明度⟩のスライダーを使って調節します。
- 　背景の融合（ΔE）：ファイルを融合する際に、ΔEを考慮します（少しスコープに似ています）。

#### ファイルの融合を使った編集例

　"ファイルの融合"の応用は多岐に渡りますが、１つの例として、"ぼかした背景に2重の諧調を施す"
手順を解説します。

- 　まず、１つ目のRT-スポットを"楕円形"、"標準スポット"で追加/作成します。
  - 　"現在のスポットに機能を追加"のドロップダウンリストで、⟨ぼかし/質感＆ノイズ除去⟩を追加し、"ぼかし＆ノイズ除去"のパネルを開きます：
  - 　"インバース"のオプションボックスにチェックを入れて有効にします。
  - 　RT-スポットの４つ境界節点を動かして、ガウスぼかしを掛けたくない部分を予め囲みます。
  - 　"ぼかし＆ノイズ除去"パネルのコンボボックスで"ガウスぼかし – ノイズ
    –
    質感"を選択し、付属する機能を調整します。これでRT-スポット以外の部分にぼかしがかかります（インバースモードにしているから）。
    - 　半径は1000から100000（高速フーリエ変換を使う場合）に設定します。
    - 　輝度ノイズを加味したい場合は、⟨ノイズ⟩のスライダーを調整します。

<!-- -->

- 　次に、２つ目のRT-スポット（形状：楕円、タイプ：標準スポット）を追加/作成します。デフォルトで60に設定されている境界値は必要に応じて後から変更します：
  - 　RT-スポットの中心円を１つ目のRT-スポットの内側の領域（ぼかしがかかっていない）に置きます。
  - 　4つの境界節点を動かして、1つ目のRT-スポットの外側のぼかされた領域内で、ぼかしの効果を変えたい（２重の諧調調整を施す）部分を選別します。そのために２つ目のRT-スポットが１つ目のRT-スポットを囲むような配置となります。そして下記に示したような編集を行えば、１つ目のRT-スポットの外側から２つ目のRT-スポットの外枠までの部分でぼかしの効果が変わります。注意：2つ目のRT-スポットの境界節点を画像の外側に配置してしまうと、諧調効果は２重ではなく単一になってしまいます。２重の諧調にするために：
  - 　２つ目のRT-スポットに⟨色と明るさ⟩の機能を追加します。機能水準は高度にします。
  - 　⟨カラー機能のスコープ⟩の値を100、或いは100に近い値に設定します
  - 　"ファイルの融合"パネルを拡張し、コンボボックスの中から、"元画像"を選択します。
  - 　その下の"融合するファイルの選択：元画像/一つ前の画像/背景"のコンボボックスで"標準"モードを選択します。効果を知るために、ファイルの融合を背景にする、融合のモードを"ソフトライト"などに変える、⟨背景の融合⟩を50にする、不透明度を50にする、コントラストのしきい値を調整する、などして効果の違いを知って下さい。

<figure>
<img src="/images/doubleblur.jpg" title="doubleblur.jpg" width="300" />
<figcaption>doubleblur.jpg</figcaption>
</figure>

### RT-スポットとレイヤー

　新たに追加/作成されたRT-スポットは、それぞれが２枚の"レイヤー"で構成されています。１番目のレイヤーは、何の変更も加えていない元画像のデータを保持しているレイヤーで、"ファイルの融合"で元画像と融合する時や、RT-スポットに除外モードが適用された時に使われます。２番目のレイヤーは、実際のRT-スポットの大きさが画像より小さくても、全ての編集を含む前の画像の情報を保持しています。これにより、前述の"融合のタイプ"を前の画像や元画像に適用することが出来ます。

　ファイルの融合や融合のタイプの機能は、個別のRT-スポットの設定に敏感なので、⟨カラー機能のスコープ⟩を100にしないと上手く働かないことがあります。

### 補完的アルゴリズム　‐　輝度マスクをベースにした詳細の復元

　⟨色と明るさ⟩や⟨シャドウ/ハイライト＆トーンイコライザ⟩などのモジュールには、
"マスクと修正"のL(L) や
LC(H)カーブの効果が強すぎる場合に、輝度の情報をベースに和らげる機能、⟨
輝度マスクをベースにした詳細の復元⟩が備わっています。

　⟨復元のしきい値⟩の値が1より大きいと、"マスクと修正"の中のマスクは画像に対して行った前の修正（スムーズな半径、色度など）を考慮しますが、モジュールの機能（色と明るさ、ウェーブレットなど）による調整は考慮しません。復元のしきい値が1以下の場合は、マスクは前の修正も考慮しません。どちら場合でも、復元のしきい値は現在の機能で修正したマスク画像に対して働きます。

　2つのスライダー、⟨暗い領域の輝度のしきい値⟩、と⟨明るい領域の輝度のしきい値⟩は、復元機能を減衰させる範囲を決めるもので、しきい値より暗い/明るい部分で作用が減衰します。両しきい値の間では、作用が100％働きます。

### 補完的アルゴリズム　‐　マスクと修正

　マスクを使った例が次のリンクにあります：[単純なマスクを使って色の選択を増やす](local_controls/jp#単純なマスクを使って色の選択を増やす)

#### 序文

　ローカル編集で使われているマスクのアルゴリズムは、Jacques
Desmisにより設計されました。カラータブの⟨カラートーン調整⟩の方法の一つ、"L\*a\*b\*の補正領域"で使われるL、C、Hのマスクをベースにしています。ユーザーインターフェースに実装する上の制限で、マスクを回転させたり、領域をベジエ曲線などで囲んだりすることは出来ませんが、以下に示したような一般的なソフトウェアのマスクにはない特性を備えています。これらのマスク機能を使うためには、モジュールの機能水準を"高度"にする必要があります（単純なマスク機能だけであれば標準モードでも使えます）：

- 　構造のマスク：画像の構造を単独で、或いは他のマスク機能と併用して調整することが出来ます。明るい部分と暗い部分の調整の違いを強化します。
- 　ぼかしのマスク：マスクのコントラストを変える機能で、やはり明るい部分と暗い部分の調整の違いを強化します。
- 　ウェーブレット：ウェーブレットの詳細レベル、最も細かいレベルから粗いレベルに応じて、マスクの修正を行います。

#### イントロダクション

　11個の機能モジュール、⟨色と明るさ⟩、⟨ダイナミックレンジ&露光補正⟩、⟨シャドウ/ハイライト＆トーンイコライザ⟩、⟨自然な彩度＆ウォーム/クール⟩、⟨対数符号化⟩、⟨色の見えモデル（CAM16とJzCzHz）⟩、⟨詳細レベルによるコントラスト調整⟩、⟨ローカルコントラスト＆ウェーブレット⟩、⟨トーンマッピング⟩、⟨霞除去&レティネックス⟩、⟨ぼかし/質感＆ノイズ除去⟩、で“マスクと修正領域”が使えます。

- 　色と明るさ、ダイナミックレンジ＆露光補正、シャドウ/ハイライト＆トーンイコライザ、の3つの機能モジュールでは、インバースモードでもマスクを使うことが出来ます。但し、幾つか制限があります。
- 　ぼかし/質感＆ノイズ除去のモジュールでは、マスクは共通して使います。
- 　トーンマッピング、霞除去＆レティネックス、の2つのモジュールでは、モジュールの機能による調整の前でも後でもマスクを使うことが出来ます。

　設定パネルの中の"マスクと融合に関する設定"にある⟨マスクの背景色と輝度⟩の値は0から30まで変えられます。デフォルトは10に設定されています。値を下げるとマスクによる修正が見易くなりますが、画像の詳細が見え難くなります。値を上げるとその逆になります。

#### マスクと修正の詳細

　"マスクと修正"のパネルを開くと、トップにコンボボックスがあります。必要に応じて使用するモードをここで選択します：

- 　修正された画像：モジュールの機能による調整、及びマスクによる効果全てを反映した画像を表示します。
- 　修正領域をマスクなしで表示：修正領域でマスクが適用される前の状態を表示します。"変移の階調"の設定値は反映されます。
- 　修正領域をマスクと共に表示：修正領域でマスクが適用された後の状態を表示します。"変移の階調"の設定値は反映されます。
- 　マスクの表示：カーブやフィルタを使ったマスクの様子を表示します。変移に関する設定やΔEは反映されません。但し、"マスクと融合に関する設定"の中の⟨ΔE画像のマスク⟩オプションにチェックが入っている場合は、次のマスクツールによる修正が表示に反映されます：ガンマ、スロープ、コントラストカーブ、ローカルコントラスト（ウェーブレット）、ぼかしのマスクと構造のマスク。これら機能のスコープは、ΔE画像のマスクオプションの下にある、⟨スコープ（ΔE画像のマスク）⟩のスライダーで微調整が出来ます。
- 　スポットの構造を表示：機能水準を"高度"にすると、⟨スポットの構造⟩のスライダーが使えます。このモードを選択すれば、その調整の効果を見ることが出来ます。
- 　ΔEのプレビュー：使用されているツールに関わらず、画像とΔEを見ることが出来ます。

#### マスクの２つの目的

1.  　形状検出の感度を上げて、編集領域の選別の精度を強化し、余計な領域に作用が及ばないようにします。稀にΔEによる形状検出だけでは選別の精度が不十分な場合があるので、そのために使います。
2.  　マスクと元画像を合成することで、特殊な効果を出します。

#### 各種機能

##### L、C、Hのカーブ

　多くの機能モジュールの"マスクと修正"に含まれるカーブは、モジュールの機能（例えば、色と明るさの"明度"）による調整が適用される前に画像を修正するマスクを生成します。但し、⟨トーンマッピング⟩と⟨霞除去＆レティネックス⟩のレティネックスのカーブは機能の調整の前後どちらでも適用できます。これらのマスク、及びマスクツールによるマスクの修正は、どの時点で適用しても、形状検出や変移の階調の設定を考慮しています。もちろん、どの時点で適用するかで、最終的な仕上がりは変わります。マスクを生成するカーブを備えている機能モジュールは以下の通りで、使用開始時点の各カーブは最大値1.0に設定されています：⟨色と明るさ⟩、⟨ダイナミックレンジ＆露光補正⟩、⟨シャドウ/ハイライト＆トーンイコライザ⟩、⟨自然な彩度＆ウォーム/クール⟩、⟨対数符号化⟩、⟨色の見え（CAM16
&
JzCzHz）⟩、⟨詳細レベルによるコントラスト調整⟩、⟨トーンマッピング⟩、⟨ぼかし/質感＆ノイズ除去⟩、⟨ローカルコントラスト＆ウェーブレット⟩

- 　C＝f(C)：色度に応じてその色度を変えるカーブです。色度を下げて、編集領域の識別を強化する時に使います。
- 　L＝f(L)：明度に応じてその明度を変えるカーブです。明度を下げて、編集領域の識別を強化する時に使います。
- 　LとC＝f(H)：色相に応じてその色度と明度を変えるカーブです。色度と明度の両方を下げて、編集領域の識別を強化する時に使います。

　使用開始時点とは逆にカーブを0に近づけると、作用が反転します。

##### 構造マスク

　
　画像の構造をベースにしたマスクで、低コントラストの部分（均一的な構造を持つ青空など）と高コントラストの部分（建物や凹凸のある山肌など）の区別を強化します。２通りの使い方があります：

- 　構造マスクの中の"機能としての構造マスク"のオプションを無効にしたままで、⟨構造マスクの強さ⟩のスライダーを調整する：

この使い方では、３つのカーブ（マスク）が使われていなくても、構造を示すマスクが生成されます。但し、調整は控えめに行うことを勧めます。

- 　構造マスクの中の"機能としての構造マスク"のオプションを有効にして、⟨構造マスクの強さ⟩のスライダーを調整する：

この使い方では、L(L)或いはLC(H)カーブが使われた時だけ構造マスクが生成されます。この場合マスクは、他のマスク機能であるガンマやスロープなどと似たような効果になります。画像の構造に応じて、作用のあり方に違いを付けることが出来ます。

　⟨構造マスク⟩の機能が使えるのは、⟨ぼかし/質感＆ノイズ除去⟩と⟨色と明るさ⟩のモジュールだけです。

##### マスクぼかし

　"ぼかしのマスク"は半径の大きなぼかしを生成する機能で⟨色と明るさ⟩の機能モジュールだけに備わっています（機能水準が高度の場合）。画像のコントラストを変えたり、画像の選択された部分を暗くしたり、明るくしたり出来ます。

- 　⟨コントラストのしきい値⟩：画像の質感をベースに、作用の影響を受ける部分と受けない部分を選別します。
- 　⟨半径⟩：ガウスぼかしの半径を0から100の間で設定します。
- 　FFTWƒ：高速フーリエ変換を使うオプションです。これを有効にすると上記の半径の大きさを1000にまで拡大できます。但し、その分処理時間が増えます。

##### スムーズな半径とラプラス変換のしきい値

　これら2つのスライダーを同時に調整することは勧められません（偏微分方程式の解を求めることが出来ません）。

###### スムーズな半径

　"ガイド付きフィルタ"を使うこの半径のスライダーは境界部分のアーティファクトを減らし、滑らかにします。

###### ラプラス変換のしきい値

　これはハイライト部分の輝度を増やすために使います。

##### ガンマ、スロープ、色度

　
　次の３つのスライダーを使って、マスクを調整します（つまり、画像編集に対しては反対の効果となります）：

- 　色度：色域（sRGB、Prophotoなど）の広さを含め、幾つかの要因で決まる画像の色度に応じて、マスクの色度の強さを変えます。
- 　ガンマとスロープ：これらはsRGBガンマと同じ原理をベースにしています。輝度チャンネル（L\*）に作用します。暗い部分での作用は線形で、その後の作用は放物線的になります。カーブは不連続のない連続のカーブを描きます。

##### ブレンド

　マスクを現在の画像と融合する程度を調整するスライダーです。

##### コントラストのカーブ、ウェーブレットのローカルコントラスト、色相カーブ

- 　全ての機能モジュールの"マスクと修正"の中のマスクツールに⟨コントラストカーブ⟩が備わっています。これは上記の⟨ガンマ⟩や⟨スロープ⟩の様に使うことが出来ますが、通常は暗い部分を除いたマスクの明るい部分だけを目標にして使います。
- 　⟨色と明るさ⟩と⟨ぼかし/質感＆ノイズ除去⟩機能には、更に、ウェーブレットによる詳細レベルを使ったローカルコントラスト調整機能が備わっています。
  これは特定の輝度範囲に作用することで、目標とするマスクの詳細レベルに対する作用に強弱を付けます。
- 　更に、⟨色と明るさ⟩機能には、H＝f(H)カーブが備わっていて、色を微妙に調整する（例えば、肌の色）ことが出来ます。

##### 設定の中のΔE画像のマスクとスコープ（ΔE画像のマスク）

　設定パネルの中の"マスクと融合に関する設定"（パネルのトップにある"全ての項目を表示"オプションを有効にする必要があります）にあるチェックボックスとスライダーは、RT-スポットにより選別されている編集領域が変化してしまわないように、ΔEを考慮する機能です。

- 　これら機能はそれぞれのマスクで使えます。
- 　マスクが作成された後にスライダーとカーブを使ってマスクを修正します。
  - 　スライダー：⟨ガンマ⟩と⟨色度⟩、⟨スロープ⟩
  - 　カーブ：⟨コントラストカーブ⟩、⟨ウェーブレットのレベルによるローカルコントラスト⟩、⟨色相カーブ⟩
- 　 ⟨スコープ⟩の値を低くすると作用の差が大きくなります。
- 　この機能は“インバース”モードでは使えません。

#### 実例

　マスクを使用する主な目的 -
形状検出の感度を上げて編集対象の選別を向上させ、余計な部分に作用が及ばないようにする
–
を実践する際には、RT-スポットの中心円部分の情報が変わってしまわないように注意します。この部分が編集の基準値（輝度、色度、色相の情報）となっているからです。各カーブを開いた時に、明るいグレー部分と暗いグレー部分に分かれていますが、その境界が基準値に該当します。従って、基準値が変化してしまわないようにカーブの節点の位置取りに気を付けます。

- 　注意：設定パネルの"特有の設定"にある、"基準値を繰り返し更新"のオプションが有効になっていると、明るいグレーと暗いグレーの境界位置が変わってしまいます。従って、特定の機能モジュール（例えば、⟨ダイナミックレンジ＆露光補正⟩の⟨露光量補正⟩を調整）の中でマスクを調整する際には、一時的にこのオプションを無効にすることを勧めます。
- 　基準値の繰り返し更新オプションを無効にした後、色度或いは輝度を目的の効果になるように調整します。殆どのケースで、Ｙ軸の値を10％ないし20％下げれば十分でしょう。

<figure>
<img src="/images/mask_sensi_obj1.jpg" title="mask_sensi_obj1.jpg"
width="600" />
<figcaption>mask_sensi_obj1.jpg</figcaption>
</figure>

- 　また、この目的の場合は、⟨ブレンド⟩のスライダーは0にしておくのが望ましいでしょう。　

　マスクを使用するもう一つの目的 –
マスクに使われた画像と元画像を合成して特殊な効果を出す –
のための手順は、どの様な効果を目標にするか次第で変わりますが、それでも上記の手順を踏襲することを勧めます。但し、カーブの下げ方は主な目的の場合と異なり、20％以上、場合によっては100％にします。注意点は、下げ方を大きくすることで選別の感度も高くなるので、効果も強まります。これを踏まえて、⟨ブレンド⟩のスライダーを以下の様に調整します：

- 　マイナスの値にするとマスクによる補足分が元画像から減算されます。例えば、輝度のマスクを使っている場合は、画像が暗くなります。
- 　プラスの値にするとマスクによる補足分が元画像に加算されます。輝度のマスクを使っている場合は画像が明るくなります。

　マスクを調整する際に、その視覚化を補助する選択肢が用意されています：

- 　マスクの表示
- 　修正領域をマスクなしで表示（但し、モジュールのモードがインバースの場合は不可）
- 　修正領域をマスクと共に表示（但し、モジュールのモードがインバースの場合は不可）

　構造のマスクを表示するオプションもあります（インバースモードでは使えません）。複数のマスクを同時に調整することは出来ないので、個別に作成する必要がありますが、作成されたマスクを組み合わせて使うことは出来ます。

　表示モードの"修正領域をマスクなしで表示"と"修正領域をマスクと共に表示"では、修正の見え方を変えることが出来ます。設定パネルの"形状検出"を開き：

- 　⟨&DELTA;Eのプレビューカラー‐強さ⟩のスライダーを使います。
  - 　プラスの値であれば、修正領域の色の見え方は変わりません。
  - 　マイナスの値にすると、表示にL\*a\*b\*のb\*補色次元が追加されるので輝度の変化が見易くなります。

　注意点："マスクと修正"の機能は対象領域が広くなるほど、メモリー消費量が多くなります。また、通常の画像編集と異なり、マスクに対する修正は画像に対しては反対の効果になります。

#### マスクだけを使う

　
　⟨ソフトライト＆独自のレティネックス⟩以外の機能モジュールにはマスク機能が備わっています（機能水準を標準或いは高度にする必要があります）。それらモジュールは本来の機能を全く使わなくても、"マスクと修正"の機能だけで使うことが出来ます。この仕組みを利用すれば、ローカル編集の処理工程の前の方でマスクを使うことも、後の方で使うことも出来ます。例えば：

- 　⟨対数符号化⟩はローカル編集の処理工程全体の中で最もアップストリームに位置しています。⟨ぼかし/質感＆ノイズ除去⟩がその次です。両モジュールともマスク機能を備えており、対数符号化やノイズ除去の機能を使わなくても、マスクだけで使うことが出来ます。従って、これらのマスク機能を使えば、他の機能モジュールによる編集に先駆けてマスクを施すことが出来ます。
- 　一方、⟨色の見えモデル（CAM16＆JzCzHz）⟩は、処理工程全体の最もダウンストリームに位置するモジュールですが、マスク機能も備えていて、それだけで使うことも出来ます。つまり、このマスク機能を使えば、他の機能モジュールを使って画像に編集を施した後に、マスク機能を適用することが出来ます。

#### 複数のマスクを使う

　
　⟨トーンマッピング⟩や⟨ダイナミックレンジ＆露光補正⟩など、マスク機能を有する機能モジュールで、特定のRT-スポットで使えるマスクは1つだけですが、簡単な手順で複数のマスクを使うことが出来ます。

　注意：マスクの効果は前のマスクの効果に対して追加的になります。　

##### 同じRT-スポットで複数のマスクを使う方法

　最初にRT-スポットに追加した機能モジュール（例えば、色と明るさ）に属しているマスクを使った後、別な機能（例えば、詳細レベルによるコントラスト調整）を追加して、その機能に属するマスクを使うだけです。その際、追加した機能そのものを使う必要はありません。但し、そのマスク処理は、追加した機能の処理工程上の順番に準じます。また、追加した機能のマスクは、その機能次第で若干特性が異なります。

- 　例えば、機能水準を高度にしている場合、⟨色と明るさ⟩と⟨ぼかし/質感＆ノイズ除去⟩のマスクならば、ウェーブレットを使った⟨ローカルコントラスト⟩でマスクのシャドウ、中間、ハイライトトーンを調節出来ます。
- 　更に、⟨色と明るさ⟩の場合、色相カーブでマスクを修正することが出来ます。
- 　⟨自然な彩度＆ウォーム/クール⟩のマスクは少し特別です。自然な彩度は、色域抑制を別にして、輝度には作用しないので輝度に対する効果は非常に鈍くなります。

　もちろん、"マスクの融合"を使った組み合わせ、⟨&DELTA;E画像のマスク⟩も使用が可能です。

##### RT-スポットを複製して、同じ機能で複数のマスクを使う

　これも簡単です。RT-スポットの複製を利用して複数のマスクを使います。これにより以下のことが可能となります：

- 　複製されたRT-スポットの位置次第で、新しい基準値（色相、色度、輝度）が利用できる。
- 　編集領域を変えられる。
- 　マスクの作用の順番を変えられる。

##### レティネックス　特殊なケース

　⟨霞除去＆レティネックス⟩に備わっているマスクは他のマスクと同じように見えますが：

- 　編集領域の選別感度を上げるという目的でマスクを使う場合は、"マスクと修正"の中にある、"透過マップを使う"オプションを無効にします。
- 　このオプションが有効になっていると、マスクの作用が違うものになります：
  - 　レティネックス機能がローカルコントラストの効果に大きく依存するようになります。注意：レティネックス機能は⟨ブレンド⟩スライダーの値が正でも負でも同じように反応します。
  - 　基準値（色相、輝度、色度）を示す、明るいグレーと暗いグレーの境界線は参考になりません。

#### 共通のカラーマスク

[共通のカラーマスクの使い方](local_controls/jp#共通のカラーマスクの使い方)
に例題があります。

　このモジュールのツールは、これまで説明してきたマスクと同じ特性を持ちますが、その原理や動作は異なります：

- 　通常のマスクは、編集領域の選別を改善したり、モジュールに備わった本来の機能（色と明るさ、自然な彩度、など）で編集した画像の状態を補正したりするために使います。

　しかし、共通のカラーマスクはそれ自体がツールの様に動作します：

- 　 C(C)、 L(L)、
  LC(H)、3つのカーブに加え、機能水準を高度にすれば、他に"構造のマスク"や"ぼかしのマスク"が使えます。これらにより、元画像に対し色や構造の違いを付けることが出来ます。
- 　ここで言うところの違いとは、例えば、⟨色と明るさ⟩のモジュールで“輝度”や“色度”を調整することと同じです。

　このマスクの特殊な動作を利用する上で、３つのスライダーが用意されています：

- 　スコープ：RT-スポットの位置と設定パネルの設定値によってきますΔEの基準値を調節します（この場合、他のスコープは全て動作が止まります）。
- 　マスクの輝度の加減：元画像に対し、輝度のマスクを加えたり減じたりします。
- 　マスクの色度の加減：元画像に対し、色度のマスクを加えたり減じたりします。
  - 　上記２つのスライダーは、値が０の場合は動作しません。
- 　スコープはこれら２つの加減のスライダーによって生まれた差に対して作用します。

#### 色ずれの回避

　これは設定パネルの"特有の設定"の中にあるオプションを指します。有効にすると次の2つの機能を使うことが出来ます：

- 　現在の作業プロファイルの色を、相対的色域の中に収めることを試みる。
- 　L\*a\*b\*で見た色度が著しく変化、特にレッド/オレンジとブルー/パープルで、した時に、"マンセル補正"を使って補正する。

　問題点：

- 　L\*a\*b\*モードの使用には制限がないため、色度を大きく変えた時に、RGB色空間の限界に近かった色が偽色に変化してしまうことがあります。そのため色域の抑制が必要です。
- 　"色ずれの回避"アルゴリズムは、飽和したハイライトの処理が上手く出来ません。そのため、露光補正の⟨ハイライト復元⟩機能の効果が損なわれてしまいます。

　そこで、色域の限界に近い色を持つ画像（例えば、花）の場合、ハイライト復元を行った後に色度を上げる時は以下の様な対処で妥協点を探ります：

- 　"色ずれの回避"オプションを無効にします。但し、その場合は、レッド/オレンジとブルー/パープルで色ずれが発生します。
- 　"色ずれの回避"は無効にしますが、"マンセル補正だけ"のオプションを有効にします。この場合は、人間の目には見えない偽色が発生します。
- 　"色ずれの回避"及び"マンセル補正だけ"を共に有効にして使い、ハイライト復元の効果を保持したい部分に除外スポットを適用します。通常はこの使い方がいいでしょう。

#### 高速フーリエ変換

　RawTherapeeは高速フーリエ変換に"FFTWの実数コサイン変換"を使っています。特に、ローカル編集において3つの目的で使います：

- 　ガウスぼかしを生成する時
- 　ラプラス作用素を用いた後に、ポアソン偏微分方程式の解を求める時
- 　ノイズの軽減を図る時

　注意：画像サイズそのものが大きい場合やRT-スポットで画像全体モードを使う場合は処理時間が増えます。

##### ガウスぼかし

　ローカル編集の2つの機能モジュールには、"高速フーリエを使う"というオプションが付いています。高速フーリエ変換（FFT）はマルチスケールレティネックス（高度な機能タブのレティネックスでは使っていません）に必要なぼかしの生成と、⟨ローカルコントラスト＆ウェーブレット⟩のアンシャープマスクに使われます。注意：マルチスケールレティネックスはスケールのスライダーを使って呼び出します。高い値ほど演算の繰り返しが多くなり、レティネックスの効果が強まりますが、その分メモリー消費は増えます（高速フーリエ変換を使う、使わないに関わらず）。特に、ぼかし機能を使った場合に増えます。

- 　ぼかしの生成にはガウス関数が用いられ、フーリエ変換後、その逆変換前に適用されます。
- 　使われるガウス関数はG(x,y) = (1/2\*PI\*sigma) \* exp(-(x^2 + y^2) /
  2\* sigma^2)

ですが、"高速フーリエを使う"オプションを有効にすると、

- 　G(x,y) = exp((-sigma^2)\*(PI \* x^2 + PI \* y^2))になります。

　この関数は、シグマの半径の大きさに関係なく適用出来ます。

　注意：ぼかしの関数に関しては、高速フーリエ変換を使う方が、RawTherapeeの他の編集機能で使われている一連の近似値計算より、効果の質が高くなります。マルチスケールレティネックスに関しては、RawTherapeeの"options"ファイルの中にある変数、Fftwsigmaを"true"から"false"にすることが出来ます（推奨ではありません）。この場合、高速フーリエ変換のアルゴリズムが、FFTWを使わない旧式を真似るように変化します。

##### ポアソン偏微分方程式の解

　以下、２つの機能に関わります：

- 　⟨ソフトライト&独自のレティネックス⟩"独自のレティネックス"で使われます。輝度の差異を軽減します（特に、ポートレートの場合）。
- 　⟨ダイナミックレンジ＆露光補正⟩の２つの機能；"コントラストの減衰"と"ダイナミックレンジの圧縮"で使われます。

##### ノイズ低減

　ローカル編集には、輝度ノイズと色ノイズを軽減するために、ウェーブレットに加え高速フーリエ変換を使う機能があります（ディテールタブの⟨ノイズ低減⟩にはない機能です）。

##### 高速フーリエ変換の最適化

　高速フーリエ変換（FFT）の処理時間は、処理する領域の大きさとアルゴリズムによる関数の呼び出しの回数（例えば、スケールスライダーで選択するマルチスケールレティネックスの繰り返し計算回数）で決まります。ガウス関数の適用には時間はかからず、半径の大きさも関係しません。注意点は、FFTの最適化は処理される領域の寸法（高さと幅）が素因数を使ったウェーブレット分解に対応している場合に限られるということです：２のn乗、３のp乗、５のq乗、７のr乗、11のa乗、13のb乗（a+b=0または1）。

- 　コードは適切な寸法を選択するための表を使いますが、今のところ幅或いは高さが18144ピクセルまでの領域です。
- 　この最適化はプレビューには反映されません。
- 　処理時間の節約は2倍から10倍まで変わります。RT-スポットの処理領域が2のn乗タイプの場合は10倍、素因数の組み合わせが多数の場合は2倍になります。このためFFTWは実質的には大きい領域より小さい領域に対する処理時間の方が多くかかります。
- 　処理領域として全体画像を対象とした場合、FFTWで処理する領域の大きさは、画像全体より若干（数ピクセル）大きくなります。

##### 計算精度

　FFTWの計算は浮動小数点で行われます。何回かテストを行った結果、これで十分であることが判明しています。変換後と逆変換の後で、画像全体で見つかった幾つかのピクセル値の差は1000分の1より小さいので問題とはなりません。

## L\*a\*b\*モードで使うローカル編集の機能と他の機能との違い

　前述した様に、ローカル編集に備わっている機能は、RawTherapeeの他のタブに備わっている編集機能とよく似ていますが、異なる点もあります。例えば、ローカル編集以外の多くの機能は編集作業にRGBとL\*a\*b\*のどちらのモードも使うことが出来ますが、ローカル編集はL\*a\*b\*だけです。また、同じL\*a\*b\*を使う機能でも、ローカル編集の機能と他の機能ではアルゴリズムの実行の仕方が違います。

### 色と明るさのモジュール

　ローカル編集で使われている輝度とコントラストのアルゴリズムは、露光タブの⟨Lab調整⟩のそれとは異なります。従って、調整によって得られるレンダリングの結果も異なります。使い方に関しては、最初のステップの[色と明るさの機能を追加を](local_controls/jp#色と明るさの機能を追加)参照して下さい。

　ローカル編集には、カラータブの⟨カラートーン調整⟩と同じように⟨L\*a\*b\*カラー補正グリッド⟩が備わっていますが、ローカル編集のそれは、"カラートーン調整"と"直接"という2つのオプションを持っています：

- 　カラートーン調整：

1.  　こちらのオプションは色度を変える際に輝度が考慮されます。
2.  　グラフの中のホワイトポイントとブラックポイントはデフォルトでは重ねられて中心に置かれていますが、ホワイトポイントの位置はそのままで、ブラックポイントの位置だけを変えると、色相カーブを調整することと同じになります。つまり入力された色相に応じて、出力の色相を変えることになります。
3.  　ホワイト及びブラックポイントの両方の位置を変えた時は、カラータブのカラートーン調整と同じ効果になります。

- 　直接：

こちらのオプションを選択すると、直接的に色度に影響します。

<img src="/images/Colorspace_flowers.jpg" title="Colorspace_flowers.jpg"
width="300" alt="Colorspace_flowers.jpg" />
<img src="/images/Colorspace_flowers-grid2.jpg"
title="Colorspace_flowers-grid2.jpg" width="300"
alt="Colorspace_flowers-grid2.jpg" />

　効果の強弱は⟨強さ⟩のスライダー及び他のスライダー（機能水準が高い場合）で調整します。特に、設定パネルの⟨カラー機能のスコープ⟩スライダーを使えば、特定の色を分離できるので作用が及ぶ範囲を制限することが出来ます。

- 　スコープ機能を有する⟨色と明るさ⟩はインバースモードを使うことで、諧調を施す、ヴィネット効果を真似る、画像に外枠を施す、或いは特殊な効果を付けることが出来ます。外枠に関する編集では、明るさを‐100にして、色度を下げ、（カラー機能の）スコープ値を75以上にすれば、黒い枠で画像を囲むことが出来ます。

特殊な設定：

- 　⟨ガンマ⟩（モジュールの機能水準が高度の場合）：HDRモードで編集を行う場合、L\*a\*b\*で使われるガンマを変えることで、デフォルトのガンマ＝3を線形にすることが出来ます。
- 　⟨スポットの構造⟩：ΔEによる形状検出の感度を上げるために、画像の構造を考慮したSobel-Cannyアルゴリズムを使います。
- 　⟨形状検出のぼかし⟩：形状検出によりアーティファクトが発生した場合、それを軽減するために結果に若干のぼかしを施します。

#### カーブ

- 　L=f(L)カーブとC=f(C)カーブは、各RT-スポットにおいて、入力された画像の輝度と色度に応じて出力される輝度と色度を調整するカーブです。
- 　L=f(H) カーブは
  (機能水準が高度の場合のみ)、各RT-スポットにおいて、入力された色相に応じて出力される輝度を調整するカーブです。
- 　C=f(H) カーブ
  は(機能水準が高度の場合のみ)、各RT-スポットにおいて、入力された色相に応じて出力される色度を調整するカーブです。
- 　H=f(H) カーブは(機能水準が高度の場合のみ)
  、各RT-スポットにおいて、入力された色相に応じて出力される色相を調整するカーブです。
- 　L=f(C)カーブは (機能水準が高度の場合のみ)
  、各RT-スポットにおいて、入力された色度に応じて、出力される輝度を調整するカーブです。
- 　C=f(L) カーブは (機能水準が高度の場合のみ)、各RT-スポットにおいて、
  入力された輝度に応じて出力される色度を調整するカーブです。

　これらカーブを使うためには、"カーブのタイプ"のコンボボックスから"通常"を選択します。また、機能水準次第で、利用できる機能が追加されます：例えば、機能水準が高度であれば、マスクと構造検出が使えます。但し、インバースモードを有効にすると、L=f(H)、
H=f(H)、 L=f(C)、
C=f(L)のカーブは使えません。また、変更のプレビューを見ることも出来ません。

RGBトーンカーブ (機能水準が高度の場合のみ)　

- 　RGBトーンカーブには４つのモードを用意しました：標準、加重平均、輝度、フィルム調
- 　また、このカーブ機能には"RGBカーブの特殊な利用"というオプションがあります。ローカル編集のこのアルゴリズムは設計上、RGBトーンカーブの結果を元の画像と適合させるように働きます。そのため、特にネガフィルムを真似るためにカーブを反転させた場合は、予期せぬ結果になることがあります。オプションを有効にするとRGBトーンカーブによる処理が分離され、変移の位置以外の設定値（スコープや他のスライダー値、マスクなど）による調整効果が排除されます。オプションを有効にして行った調整に更に調整を追加するのであれば、別なRT-スポットを同じ位置、或いは近い場所に配置して行います。

#### ファイルの融合

　Photoshop©やGIMPなどで使われている様なブレンドモードを使って、２つのRT-スポット、或いは１つのRT-スポットと背景を融合することが出来ます。

- 　21種類のモードが使えます：標準、減算、加算、乗算など
- 　融合処理をコントロールするために3つのスライダー；背景の融合（ΔE）、不透明度、コントラストのしきい値、があります。

### ダイナミックレンジ＆露光補正のモジュール

　露光タブにある⟨ダイナミックレンジ圧縮⟩のアルゴリズムとは若干異なりますが、３つの同じスライダー；量、ディテール、アンカー、を持ちます（各働きも若干異なります）。更に、別な機能も追加されています：

- 　"ガンマ（機能水準が高度の場合）"：HDRモードで作業する場合、L\*a\*b\*で使われるガンマをデフォルトの３から線形に変えます。逆ガンマ変換は処理の最後に行われます。
- 　"スポットの構造（機能水準が高度の場合）"：ΔEによる形状検出の感度を上げるために画像の構造を考慮するSobel-Cannyアルゴリズムを使います。
- 　"形状検出のぼかし"：アーティファクトを軽減するために、ΔEによる形状検出の結果に若干のぼかしを掛けます。

　ダイナミックレンジ＆露光補正にはマスク機能もあります（インバースモードの場合は、その使用に多少の制限が加わります）。

#### 偏微分方程式（PDE）を応用したアルゴリズム

##### コントラストの減衰ƒ

- 　これはJacques
  DesmisがIpolのアルゴリズムを改良したもので、コントラストの減衰を行う機能です。露光タブの⟨ダイナミックレンジ圧縮⟩にはありません。４つのスライダーがあります：
  - 　"ラプラシアンのしきい値"：しきい値以下を無視して、畳み込み演算を行う機能で、値を増やすほどコントラストが減衰します。
  - 　"線形性"：平均値以下の輝度を増やすための機能です。
  - 　"ラプラシアンのバランス"：偏微分方程式の結果を基準値のデータと統合する際のバランスを変えます（１は偏微分方程式の結果が100％になります）。
  - 　"ガンマ"：ラプラス作用素の前後でガンマを変えて輝度の配分を変えます。
  - 　"ノイズ低減"：ラプラス作用素が適用される前にノイズ低減を行うかどうか決めるドロップダウンリストです。ノイズ低減のオプション（メディアンフィルタ）は画質を損ない易いので、ノイズ低減を行う場合は、⟨ぼかし/質感＆ノイズ除去⟩の機能を使って、ラプラス作用素が適用される前にノイズを減らすことを勧めます。理由があって、作用素の適用後に行いたい場合は、別なRT-スポットを追加/作成して行います。

　この項で言う偏微分方程式の解とは、フーリエ変換後のポアソン方程式（ラプラス変換+フーリエ変換）の解を指します。

#### 露光補正ƒ

　この機能はRGBモードで作業する露光タブの⟨露光補正⟩と似ていますが：

- 　ローカル編集の露光補正ƒはL\*a\*b\*モードで作業を行います。従って、調整結果のレンダリングは異なります。
- 　露光タブの機能と違い、明るさ、コントラスト、彩度のスライダーはありません（これらスライダーは⟨色と明るさ⟩のモジュールにあります）。
- 　⟨色度の補間⟩というスライダーは、L\*a\*b\*の短所である色ずれを回避するための機能です。通常はデフォルトの設定値で十分でしょう。
- 　⟨シャドウ⟩のスライダーを追加しています。⟨シャドウ/ハイライト＆トーンイコライザ⟩のモジュールと同じアルゴリズムを使っています。
- 　⟨色と明るさ⟩モジュールのL=f(L)に似たカーブが１つあります。もちろん、このカーブのレンダリングは露光タブのRGBモードのL=f(L)のレンダリングとは異なります。色と明るさと露光補正ƒのカーブ両方を合わせて使うことも出来ます。
- 　⟨ハイライト圧縮⟩を使えば、効果の微調整が出来ます。

　留意点：画像（RT-スポット）の輝度が非常に低いと、調整が上手くいかないことがあります。その場合、このダイナミックレンジ＆露光補正モジュールの代わりに、⟨シャドウ/ハイライト＆トーンイコライザ⟩のモジュールを使って補正してみて下さい。

使い方のヒント：

　RawTherapeeの露光タブで使われている露光補正のアルゴリズムには幾つか短所がありますが、ユーザーが既にその対処に慣れているので、動作の改善に多少の改良は加えていますが、ローカル編集の露光補正でもそれら短所が残っています。

- 　そこで、代わりの補正方法を紹介します（最初のステップの解説に他の例もあります）：
  - 　上記の留意点でコメントしたように、⟨シャドウ/ハイライト＆トーンイコライザ⟩機能を使います。
  - 　上記と同じモジュールの中のトーンリプロダクションカーブ（TRC）を使います。スロープのスライダーはシャドウを線形的に明るくする、ガンマは中間トーンとハイライトを明るくする働きをします。

### シャドウ/ハイライト＆トーンイコライザ

　2.2の"例を使った基本操作"の項に[TRCを使う方法の](local_controls/jp#露光を変えてシャドウを明るくする5つの方法)解説があります。

　このモジュールには（機能水準を標準以上にした場合）、⟨諧調フィルタ⟩と⟨輝度マスクをベースにした詳細の回復⟩が備わっています。

　非常に暗い部分を編集する場合は、⟨ぼかし/質感＆ノイズ除去⟩のモジュールも使う必要があるかもしれません。

#### シャドウ/ハイライト

　露光タブにあるシャドウ/ハイライトと同じ機能ですが、こちらが使える色空間はL\*a\*b\*だけです。

#### イコライザ

　これは元々darktableによって開発された機能ですが、後にAlberto
GriggioがRawTherapeeにも採用しました。露出の値（Ev）に応じて、諧調を漸進的に調整する機能です。

　4つのスライダーで、最も暗いシャドウから最も明るいハイライトまでの輝度をカバーし、ディテールのスライダーで調整の範囲を特定します、例えば、Ev‐16からEv‐18までのシャドウを明るくする、などです。

#### トーンリプロダクションカーブ（TRC）

　これを使って画像のガンマとスロープ（勾配）を調整することが出来ます：

- 　単純なガンマ補正ではなく、アーティファクトを抑制し、カラーレンダリングを向上させるために使います。
- 　デフォルトの設定は、ガンマ＝2.4、スロープ＝12.92（sRGB）で、これはRawTherapeeの出力設定に対応しています。但し、RawTherapee内部の演算で使われるガンマは全て1.0です。
- 　他の設定でも全体的な仕上がりはあまり変わった印象にはなりませんが、シャドウとハイライトの効果は変わります。
  - 　BT709: ガンマ = 2.22, スロープ = 4.5
  - 　L\*a\*b\*: ガンマ = 3.0, スロープ = 9.02
  - 　中間トーンからハイライトにかけての調整にはガンマスライダーを使います（必要に応じて高い値が使えます）。
  - 　シャドウ部分の調整にはスロープを使います。

### 自然な彩度＆ウォーム＆クールのモジュール

- 　機能水準が標準以上であれば、マスク機能が備わります。
- 　諧調フィルタが備わっています。機能水準が標準の場合は輝度のフィルタだけですが、高度にすると輝度に加え、色度及び色相のフィルタが備わります。　
- 　輝度マスクをベースにした詳細の回復機能があります。

#### 自然な彩度

　このアルゴリズムはカラータブに入っている⟨自然な彩度⟩と似ています。

#### ウォーム/クール

この1本のスライダーで：

- 　画像の"暖かみ"を加減することが出来ます。
- 　複数の光源の下で撮られた画像では、特定の偽色を軽減、或いは除去することが出来ます。

　スライダーは⟨ホワイトバランス⟩のそれに似ていますが、アルゴリズムは異なります。これはCAT02による処理を行う機能で、色の見えモデルで採用されているアルゴリズムの一つです。光源D50で撮影した画像に暖かみを加えるのであれば、スライダーの値を上げることで観視条件の色温度が下がります。逆に画像を冷たい印象にする場合は、スライダーの値を上げれば、観視条件の色温度が上がります。同じような効果は高度なタブの⟨色の見え＆明るさ⟩で以下の様な設定で得ることが出来ます：

- 　場面条件：ホワイトポイントモデル＝"任意の色温度 + 色偏差 +
  Cat02/16 + \[出力\]"、色温度 = 5000K、周囲環境 = 平均、CAT02/16 =
  100、 平均輝度Yb%=18、 絶対温度 = 400
- 　画像編集の設定はそのまま
- 　観視条件：CAT02/16 = 100、絶対輝度 = 400、周囲環境 =
  平均、平均輝度Yb% = 18、色温度 = 目的に合わせて任意に調整

### ローカルコントラスト＆ウェーブレットのモジュール

　この機能モジュールには2つのオプション（アンシャープマスクとウェーブレット）があり、スライダーの下にあるドロップダウンリストから選択します：

- 　⟨アンシャープマスク⟩：ディテールタブのシャープニングツールに備わっているアンシャープマスクと似た機能です。
- 　⟨ウェーブレット⟩（機能水準が標準以上の場合）：高度な機能タブに備わっているウェーブレットとアルゴリズム及び機能性は似ていますが、ノイズ除去機能は含まれていません（ノイズ除去は⟨ぼかし/質感＆ノイズ除去⟩のモジュールにあります）。ローカル編集のウェーブレットはΔEをベースにした処理が出来るだけでなく、幾つかの改良も加えています。
  - 　機能水準が標準のモジュールは、高度な機能タブのウェーブレットを単純化したもので、"最終的なローカルコントラスト"や"コントラストカーブ"（最終調整パネルの中）に似たアルゴリズムも含まれています。これらのアルゴリズムを組み合わせれば、明瞭の効果を出すことが出来ます
  - 　機能水準が高度になると、更に2つのメニュー；ピラミッド１とピラミッド２が加わり以下の機能が使えます：
    - 　諧調フィルタ、エッジのシャープネス、ぼかし
    - 　詳細レベルによるコントラスト調整、トーンマッピング、方向性に応じたコントラスト

　アンシャープマスク、ウェーブレット、どちらも機能水準に関係なく、"輝度マスクをベースにした詳細の回復"機能があります。

#### アンシャープマスク

　処理工程の中で置かれている位置が違うので、調整によるレンダリングはディテールタブのアンシャープマスクのそれとは異なります。

　"ƒ高速フーリエ変換を使う"オプションを有効にすると、ローカルコントラスト調整に必要なぼかしを形成します。ガウスぼかしが適用されるのは、フーリエ変換が行われた後と、その逆変換が行われる前になります。

使われるガウス関数は、

G(x,y) = (1/2\*PI\*sigma) \* exp(-(x^2 + y^2) / 2\* sigma^2)、で

そのフーリエ変換形式が、

G(x,y) = exp((-sigma^2)\*(PI \* x^2 + PI \* y^2))、となります。

　この関数は、シグマの半径に関わらず適用できます。尚、詳細に関しては[高速フーリエ変換を](local_controls/jp#高速フーリエ変換)参照して下さい。

#### ウェーブレット

　単純なウェーブレットは（ピラミッドを使わない）は以下のコントロールが可能です（例を使った基本操作の説明の中に[例となるスクリーンショットがあります](local_controls/jp#難し過ぎる？ウェーブレットを使う)）。

##### ウェーブレットのレベル

　単に分解する詳細レベルの最大数を選択するのではなく、⟨ウェーブレットのレベル⟩と表示されている"詳細レベルのセレクター"を使って、詳細レベル数の範囲を決めます。編集領域が小さければ（ピクセル数）、アルゴリズムが自動的に詳細レベルの最大数を減らします。例えば、編集領域の大きさが1024x1024ピクセルより小さい場合は、分解される詳細レベルの数は8までです。512x512ピクセルより小さければ、レベルの数は7まで、という様にレベルの数が下がっていきます。

##### ローカルコントラスト

- 　⟨ローカルコントラスト⟩のカーブはコントラスト（輝度）に作用しますが、全体の輝度に対し直接的にではなく、ウェーブレットで分解した各詳細レベルの輝度に対して作用します。言い換えると、このカーブは設定に応じて、2x2ピクセルの詳細レベルから最大1024x1024ピクセル（RT-スポットの大きさが十分に大きければ）の詳細レベルの各輝度と、分解されていない画像部分の輝度に作用します。但し、詳細レベルの画質が均一であれば、その詳細レベルにコントラストが存在しないので、作用は働きません。
- 　この⟨ロールコントラスト⟩のカーブと⟨ウェーブレットのレベル⟩の詳細レベルのセレクターを使えば、輝度に応じて細かくコントラストを変えることが出来ます。例えば、中間トーンのコントラストを増やす一方で、シャドウのコントラストを下げるような調整が可能です。必要であれば、別のRT-スポットを追加/作成して他の調整を加えます。

##### 残差画像（メイン）

　このパネルには以下の様な機能が備わっています：

- 　残差画像のコントラストを調整するスライダー。
- 　残差画像の彩度（色度）を調整するスライダー。
- 　残差画像のシャドウ/ハイライトを調整する４つのスライダーがあり、マイナスの値も設定できます。
- 　シャドウ、中間トーン、ハイライトを構成するためのガンマとスロープのスライダー。

##### 明瞭＆シャープマスクとブレンド＆ソフトな画像（ディテール）

- 　詳細レベルのセレクター（ウェーブレットのレベル）で"明瞭"と"シャープマスク"の使い分けをします。レベルの数4以下ではシャープマスクが使われ、5以上では明瞭が使われます。
- 　⟨輝度の融合⟩は輝度に対する効果の強さをコントロールするスライダーです。
- 　⟨色度の融合⟩は色度に対する効果の強さをコントロールするスライダーです。
- 　ピラミッドの機能を使った調整を行う場合、それが明瞭やシャープマスクの調整に干渉することを避けたい時は、"元画像だけと融合"のオプションを有効にします。
- 　注意：輝度の融合、及び色度の融合機能はウェーブレットによる処理全体を考慮するので、その利用に関しては明瞭だけになります。
- 　⟨ソフトな半径⟩：これはガイド付きフィルタのアルゴリズムを使った機能で、シャープマスク、明瞭、ピラミッド機能による調整で生じるハロやその他の異常を軽減します。　機能を無効にする場合は、設定値を0にします。

##### ガンマ（ウェーブレットピラミッド）

　HDR画像の編集を行う場合は、デフォルトのL\*a\*b\*ガンマ（=3）を1（線形モード）に変える必要があります。処理の最終段階でガンマは元に戻されます。

##### ウェーブレットのピラミッド1と２

###### 諧調フィルタとローカルコントラスト（ピラミッド１）

　ローカルコントラスト対し任意の角度の諧調を適用できます。諧調作用は輝度に対してではなく輝度の差に作用します。

###### エッジのシャープネス（ピラミッド１）

　この機能の目的と作用は高度な機能タブのウェーブレット（機能水準は高度）の中にある⟨[エッジのシャープネス](wavelets/jp#エッジのシャープネスのモジュール)
⟩と同じで、複雑さも同程度です。輪郭（エッジ）のローカルコントラストをターゲットにして調整を行います。

　加えて、ローカル編集に組み入れたことで、スコープや境界の諧調調整、複数の編集領域などの恩恵も受けられます。

###### ぼかしのレベル（ピラミッド１）

- 　⟨詳細レベルごとのぼかし⟩は、個々の詳細レベルや、一定範囲の詳細レベルをぼかす時に使います。水平軸はウェーブレットの詳細レベルを表しており、左端が最も細かい詳細レベル（2x２ピクセル）で右になるほど粗い詳細レベルになります。⟨ぼかしの効果の強さ⟩は、ウェーブレットのレベルの設定に関係なく、ぼかしの効果を最大にすることが出来るスライダーです。⟨詳細レベルの色度⟩は、輝度の割合（プラス又はマイナス）に応じて色度を調整するスライダーです。
- 　⟨残差画像のぼかし⟩のスライダーを使うと残差画像をぼかすことが出来ます。詳細レベルのセレクターを使ってレベルの数を変えると（右側の上下節点の位置を変える）、面白い効果が得られるでしょう。

###### レベルによるントラスト調整（ピラミッド2）

- 　ピラミッド2のパネルに含まれるこの⟨レベルによるコントラスト調整⟩は、ディテールタブの⟨詳細レベルによるコントラスト調整⟩や高度な機能タブに備わっているウェーブレットの⟨コントラスト⟩のモジュールと同等の機能です。フラットカーブの構成も同様に、水平軸が詳細レベルの番手を表し、縦軸がコントラストの増減を表します。
- 　⟨減衰応答⟩は、レベルによるコントラスト調整の働きを減衰させるために使います。コントラストの調整は中間コントラストのディテールに対し最も強く働き、高いコントラスト/低いコントラストのディテールに対しての働きは強くありません。このスライダーはその働きをどれだけ素早く減衰させるか調節します。高い値を設定すると、コントラスト調整の効果が表れる輝度の範囲が広くなりますが、アーティファクトが発生するリスクも増えます。低い値にすると輝度の範囲が狭まり、働きがピンポイントになります。
- 　⟨オフセット⟩のスライダーはコントラストの中間値をシャドウ或いはハイライト方向に移動する機能です。
- 　⟨詳細レベルの色度⟩は、輝度の設定値に対する割合でL\*a\*b\*の補色次元a\*とb\*に作用します。

　この⟨レベルによるコントラスト調整⟩は、前述の⟨ローカルコントラスト⟩のカーブを使用する/使用しないに関わらず、見かけのコントラストを強めたり、弱めたりします。

###### 詳細レベルの方向によるコントラスト（ピラミッド２）

　このモジュールはトーンマッピングの効果を作るために使われます。３方向（水平、垂直、対角）で解析されている各詳細レベルのコントラストに作用します。対角線方向と水平/垂直方向の解析結果の違いに基づいてエッジに効果を及ぼします。⟨ウェーブレットのレベルの圧縮⟩カーブは輝度に応じて作用します。

- 　⟨減衰応答⟩のスライダーは作用を平均コントラストに近い部分に集中させ、平均より高い/低いコントラスト部分では少なくさせるために使います。スライダーを右に動かすほど、作用が集中する範囲が平均より広がります。
- 　⟨デルタバランス⟩は、減衰応答が作用する詳細レベルの位置を変えるために使います。スライダーを左に動かすほど、番手の低い（細かい）レベルで減衰応答が強くなり、右に動かすと番手の高いレベル（粗い）レベルで強くなります。

###### トーンマッピング（ピラミッド２）

　この機能を使った例が、[最初のステップの](local_controls/jp#最初のステップ)中の質感を強める3つの方法にあります。

　この機能は、分解した各詳細レベルと残差画像に適用できる圧縮のアルゴリズムで、ウェーブレットだけを使っています。アーティファクト軽減のための減衰にはガイド付きフィルタが使われます（以下に説明）。

- 　⟨減衰応答⟩により、調整作用を平均コントラスト近くに集中させ、極端に高い/低いコントラスト部分に対する作用を減衰させます。スライダーを右に動かすほど、作用が集中するコントラストの範囲が平均付近から広がります。
- 　⟨バランスのしきい値⟩は効果のバランスをとるための機能でシャドウを明るくするような一定のケースで使うことが出来ます（デフォルト値は1.4になっています）。
- 　マイナスの値を設定すると、データが圧縮されてトーンマッピングの様な効果になりますが、RawTherapeeの他の部分で使われるアルゴリズム（MantiukやFattalなど）とは異なります。調整の感度はディテールが多い領域ほど高くなり、均一な画質部分では低くなります。
  - 　プラスの値を設定すると、見かけのコントラストが減り、⟨独自のレティネックス⟩に似た効果となります。同モジュールは覆い焼きや焼き込みを真似るために使いますが、このモジュールを使っても似た効果が得られます。
  - 　⟨残差画像の圧縮⟩は残差画像のコントラストの増減に使います。
- 　アーティファクトの軽減を促進するために、⟨明瞭＆シャープマスクとブレンド＆ソフトなイメージ⟩の機能を併用することを勧めます。デフォルトの設定値は1ですが、それ以下でも殆どのケースには十分でしょう。

##### 留意点

　目標とする効果を上げるためには⟨スコープ⟩（効果の調整）や⟨除外スポット⟩（効果の除外）を併用することも忘れずに。特に、トーンマッピングをレベルの圧縮と共に使う場合は、シャドウ部分の過度な効果を取り除くのに除外スポットの使用が有効です。

##### 減衰応答の重要性

　減衰応答は、コントラストの分布がまったくガウス分布でなくても、モデルとしては標準偏差に働きます。ウェーブレットのピラミッド機能多くは、各詳細レベルの平均コントラスト、標準偏差、コントラストの最大値を考慮し、アーティファクトを避けるために各詳細レベルを非線形的に処理します。マイクロコントラストは平均値に近いほど増幅され、平均値より高い/低いマイクロコントラストは増幅が少なくなります。　

### トーンマッピング

　画像の質感を高めるために使います：最初のステップの[質感を強める3つの方法に](local_controls/jp#質感を強める3つの方法)画像例があります。露光タブのトーンマッピングとは以下の点で異なります：　

- 　マスク、及び輝度マスクをベースにした詳細の復元機能が使えます。
- 　彩度を調整するスライダーが付いています（Mantiuk方式は彩度が不十分になることがあるため）。
- 　露光タブのトーンマッピングでは"強さ"という名称のスライダーは本来の目的を意味する"圧縮の強さ"に変えました。設定値の範囲も、‐0.5から2.0になっています。
- 　ローカル編集のガンマの設定範囲は0.4から4.0になっています。
- 　"再加重反復"の範囲は 0から3.0までになっています。
- 　ローカル編集のトーンマッピングには、"輝度の標準化"というオプションがあります。有効にすると、最終画像のコントラストの平均値と分散値が元画像と同じになります。
- 　ローカル編集のトーンマッピングにはマスク機能が付いています。　

　⟨トーンマッピング⟩をスコープと組み合わせて使うことで、特定の領域に"明瞭"の効果を施せます。

### ソフトライト＆独自のレティネックス

　ソフトライト機能の方はカラータブにあるものと同じです。

　最初のステップの解説に[覆い焼きと焼き込みに](local_controls/jp#覆い焼きと焼き込み)画像例があります。

　ローカル編集に⟨独自のレティネックス⟩（Ipolの研究成果を応用）を組み入れました。このアルゴリズムはRawTherapeeのこのモジュールためだけに設計したもので、他のソフトウェアにもありません。人間の目は暗い所でも、輝度の変化が大きい所でも、観視対象を正しく知覚することが出来ますが、カメラのセンサーにとっては難しいことです。例えば、ポートレート写真の場合、フラッシュや強いライトを使うと、顔のシャドウ、或いはハイライトが強くなり過ぎることがよくありますが、こういった場合の補正には、"覆い焼き"や"焼き込み"という方法が使われます。

　これを真似た"覆い焼き"や"焼き込み"機能は、通常、ブラシ機能を使って目的の部分を明るくしたり、暗くしたりしますが、RawTherapeeのこの機能はそれを自動で行うものです。

　この機能のベースになっているIpolのコードを知りたい方は、以下のリンクを参照して下さい：[29](https://www.ipol.im/pub/art/2011/lmps_rpe/)

　この複雑なアルゴリズムは幾つかのステップに分けられます：

1.  　画像の解析
2.  　信号強度を決定するしきい値を持つ離散ラプラス変換の応用です。強度値が70程度の場合、内部のしきい値は4程度になります（典型的なラプラス変換の場合）。
3.  　 ⟨ラプラシアンのしきい値
    ΔE⟩は、ΔEに応じてラプラス変換のしきい値に差を付けるためのスライダーです。しきい値より高い領域では、効果の100％が1次ラプラス変換によるものになり、しきい値より低い領域では、1次の効果と2次ラプラス変換（1次から60％減衰）を合わせた効果になります。このメカニズムは、画像への効果全体を加減する⟨スコープ⟩と異なり、背景と前景を差別する働きになります。
4.  　 2次元フーリエ変換の応用（DTC：離散コサイン変換）
5.  　プログラムの安定を図るためにポアソン方程式（偏微分方程式）の解を求めます。
6.  　 2次元フーリエ変換の逆変換を行います。
7.  　元画像を基準として輝度の標準化を図ります（同じ、偏差と分散）

　"フーリエの処理を表示"というドロップダウンメニューを使い、上記の各ステップの画像を確認することが出来ます：

1.  　 1次ラプラス変換の画像
2.  　フーリエ変換を使う離散ポアソン方程式（偏微分方程式）の解を求めた画像。但し、この画像は比較的上記の画像と似ています。
3.  　逆変換後の画像（プレビューでは見ることが出来ませんが、最終結果には反映されています）
4.  　輝度の標準化を行った画像（光源が不明な場合）

　様々な画像、特にポートレート、を使って試してみて下さい。

### 霞除去＆レティネックス

　霞除去はディテールタブに備わっている⟨霞除去⟩と似ています。レティネックスと併用することで仕上がりの質を高めることが出来ます。

#### レティネックス：高度な機能タブのレティネックスとの大きな違い

　質感を高めるためにこの機能を使った例を示します：最初のステップの質感を高める３つの方法の中に[レティネックスを使う](local_controls/jp#質感を強める3つの方法)例があります。

　ローカル編集のレティネックスは高度な機能タブの中の同じ機能に近いものですが、幾つか大きな違いがあります。

　レティネックスを使って期待通りの結果を出すためには厳格な条件を満たす必要があります。非常に大きな半径のガウスぼかしを使うためのリソースの確保です。しかし、この点においてRawTherapeeの基本設計が常に正確にプレビューを表示するための条件を満たしているとは言えず、結果として、プレビューがTIFやJPEGの出力画像と同じになりません。特に、以下の様な条件の下では違いが大きくなります：

- 　RT-スポットのサイズが小さい場合
- 　⟨スケール⟩の値が高い場合
- 　⟨半径⟩の値が非常に大きい場合

　高度な機能タブに入っているレティネックスは画像全体を対象に作用するため、この様な制限はありません。

　ローカル編集のレティネックスは、以下の様な条件の下では必要なメモリー量、及び処理時間が増加します：

- 　大きなスポット
- 　大きな半径
- 　高いスケール値
- 　マスクの使用
- 　高速フーリエ変換の使用

　レティネックスは有力な機能ですが、処理に必要なメモリーが大きくなります。例えば、ニコンD850の画像（8280x5512ピクセル）を処理する場合、RT-スポットのタイプが画像全体で、半径が500、スケールが10、マスクは使用しないという条件の下でも、最低9ギガバイトのメモリーが必要でしょう。

#### 高速フーリエ変換

　"ƒ
高速フーリエ変換を使う"というオプションを有効にすると、マルチスケールレティネックスに必要なぼかしを生成することが出来ます。大きな半径の値を使うことで効果の質を上げることが出来ますが、その代わり、処理時間が著しく増えます。

#### ユーザーインターフェイス

　以下のユーザーインターフェイスの解説はモジュールの機能水準を"高度"にした場合の機能も含んでいます：

- 　霞除去のパネルに、⟨深度"の調整スライダーがあります（以前はレティネックスのパラメータを使って算出していました）。
- 　レティネックスのパネルに、適用するモードを線形（コントラストを調整する場合に適切）もしくは対数（霞除去により適しているモード）に変えるためのチェックボックスが付いています。対数モードを使うと、よりローカルコントラストを強めることが出来ますが、その分ハロが発生する可能性も高まります。
- 　"高度なレティネックス機能"のパネルを拡張すると、⟨透過マップ⟩が表示されます。カーブにより内部の透過パラメータを調整することで、アーティファクトの発生を軽減します。
- 　透過マップには、復元されたデータが表示されます。
- 　⟨復元されたデータの切り詰め（ゲイン）⟩のスライダーは、⟨しきい値⟩や他のスライダーと併用しながら、表示されている透過マップの値を調整します。
- 　⟨ΔEアーティファクトの軽減⟩は、透過マップが適用された後のデータに作用します。
- 　画像全体を編集対象とする一連の機能の中で、霞除去（ディテールタブ）とレティネック（高度な機能タブ）が分かれていますが、これは2つの機能が別々に開発されたという過去の経緯によるもので、元々両機能の目的は似たものです（霞の軽減）。ローカル編集タブでは、これら2つを同じ機能モジュールに入れたので、利便性が高まっています。

　両者の機能は似ていますが、ローカル編集タブのレティネックスは、処理工程（[ツールチェーンパイプライン](toolchain_pipeline/jp)）の最後の方に置かれています。高度な機能タブのレティネックスは処理工程の最初に置かれています。また、設定機能の数も異なり、以下に示したような特長が追加されています：

- 　このモジュール（霞除去＆レティネックス）は、ディテールタブ及び高度な機能タブに属しているそれら機能と同等のアルゴリズムを使っています。２つのアルゴリズム（レティネックスと霞除去）の組み合わせは、大気現象である霞の問題解決に力を発揮します。２つの機能は似ていますが、それぞれ別の強みを持ちます。レティネックスは前景と背景に違いを持たせることが出来ます。霞除去は全体的な霞の除去を簡単に行え、幅広い種類の画像に適用できます。

　レティネックスのアルゴリズムは⟨強さ⟩のスライダーを0.2以上にした場合のみ作動します。

- 　⟨スケール⟩の値を1にすると、レティネックスアルゴリズムの一部が迂回され、通常よりかなり大きい値を使ったローカルコントラスト調整に似た効果になります。また、ここではマスクやトーンマッピング機能を外して、他の調整機能（半径、分散、しきい値）を入れました。
- 　⟨暗さ⟩と⟨明度⟩のスライダーは、設定値が0の時は何の効果も生みません。他の値を設定すると、マルチスケールレティネックスによる処理の最終段階で、ローカルコントラスト調整に使われるものに近いアルゴリズムが呼び出されます。⟨強さ⟩のスライダーに関係するこれら暗さと明度のスライダーはローカルコントラストに作用します。
- 　それぞれの設定や調整効果が多少違うことがあっても、原則、⟨強さ⟩、⟨半径⟩、⟨しきい値⟩、及び⟨コントラスト⟩と併せて、ドロップダウンリスト（高、均一、低）のオプションは高度な機能タブのレティネックスと類似したものです。
- 　"輝度の標準化"オプションを有効にすると、最終画像の輝度は、元画像と同じ平均値と分散（コントラスト）になるように調整されます。

　"マスクと修正"機能（レティネックスだけに使用可）は、ローカル編集の他のモジュールに備わっているものと基本的に似ています。⟨透過マップ⟩による処理の前、或いは後で適用されます。

　例えば、霞の強い画像を処理する場合：

- 　最初のステップは、ディテールタブに属している霞除去機能を使って補正することです。しかし、画像によっては、あまり効果が得られず、画像に霞が残ります。
- 　その場合、ローカル編集の⟨霞除去＆レティネックス⟩を有効にして、RT-スポットを霞が残る部分に配置します。
  - 　⟨強さ⟩、⟨深度⟩、⟨彩度⟩のスライダーを使って霞除去の強さを調整します。
  - 　⟨半径⟩の値を比較的大きく（100から150）します。注意：低い値で十分な場合もあります。
  - 　⟨分散（コントラスト）⟩の値は比較的小さめ（100以下）にします。注意：高い値が必要な場合もあります。
  - 　⟨スケール⟩の値は3以上にします。それ以上にする場合は、分散の値を大きくする方がアーティファクトの軽減につながります。
  - 　強さと⟨スコープ⟩の値を、目的の効果が得られるまで調整します。

　要点をまとめると、このモジュールは主に以下に示した目的で使用します（そのための設定は異なります）：

- 　霞のある画像を処理する。
- 　大きな半径の値を使ってローカルコントラストを増やして、"明瞭⟩に似た効果を出す。

##### アーティファクトとハロの抑制

　レティネックスは非常に優れた機能ですが、複雑であることに加え、輝度が変わる部分でアーティファクトが発生し易い、ハロが発生し易い、という短所があります。
　
アーティファクトやハロの発生を抑制するために、必要最低限の設定（半径、分散、スケール、暗さ、透過のゲイン、及びスケール）を行った後に：

- 　⟨透過マップ⟩のデータを参考にします。
- 　マップに表示されている復元されたデータの最小値、最大値がそれぞれ0と32768に近付くように、復元されたデータの切り詰め（ゲイン）、オフセット、しきい値を調整します。必ずしも正確にこの値にする必要はありませんが、例えば、最小値が25000、最大値が90000になるような調整は避けます。
- 　それでも、アーティファクトが引き続き残るようであれば、以下に示すような調整を行います。透過マップのカーブの中ほど（平均値）をX軸に向かって下げます。最小値と最大値にあたる部分を変えてみるのもいいでしょう。例えば、最小値の部分を持ち上げ、最大値の部分を下げるなど。
- 　"透過のゲイン"のカーブを調節します。
- 　⟨ΔEアーティファクトの軽減⟩をデフォルト値より大きくしたり、⟨スコープ⟩の値を調整したりします。
- 　RT-スポットを移動して編集の基準値（中心円のデータ）を変えてみます。
- 　最初の必要最低限の設定を変えてみます。
- 　透過マップのカーブと透過のゲインのカーブが使われていれば、輝度の構成を変えるために、"マスクと修正"の機能を補助的に使います。最適なコントラストを得る、ハロや霞除去ために⟨ブレンド⟩や⟨ソフトな半径⟩などを調整します。

　以上のように、この機能は多少複雑ですが、ローカルコントラストの調整には力を発揮するので、より良い結果が得られるので利用する価値はあります。

### シャープニング

　このモジュールが備えているのはRLデコンボリューションだけです。調整効果は画像を100％以上に拡大しないと確認できません。

### 詳細レベルによるコントラスト調整

- 　デフォルトではこの機能を使うためのRT-スポットの最小サイズが64x64ピクセルになっていますが、メイン設定の⟨境界の諧調設定⟩のスライダーを使って簡単に限度を下げることが出来ます。
- 　この機能を使う際には画像を100％に拡大することを勧めます。
- 　肌色を保護に関するスライダーはありません。RT-スポットで採用されたシステムに置き換えられました。
- 　色度のスライダーが追加されています。
- 　残差画像に対して明瞭とコントラストの調整が出来ます。

　機能水準を標準以上にすれば、"マスクと修正"と"輝度マスクをベースにした詳細復元"が使えます。

　ローカル編集のこのアルゴリズムには幾つか改良を加えています：

- 　人肌の欠点（例、シミ跡）を弱める効果が改善されました。
- 　遠近感を増やし、詳細な色と構造持つ領域を浮き上がらせることが出来ますが（ウェーブレット機能のように）、⟨スコープ⟩を使って、その効果が及ぶ領域を制限できます。
- 　センサーに起因する不良（グレーや色の付いたドット）を除去する能力が改善されました。

　注釈：編集領域が大きく、基準値と似たような色相、色度、輝度、コントラストを持つ対象物が複数存在する場合、それら全てに効果が及びます。

### ぼかし/質感＆ノイズ除去

#### ぼかし&ノイズ

　この機能パネルには3つのオプションが入っています（２番目のコンボボックス）：ガウスぼかし‐ノイズ‐質感、メディアン、ガイド付きフィルタです。そして、これらオプションを次の３つのモードで使えます（３番目のコンボボックス）：輝度だけ、色度だけ、輝度と色度。

##### ガウスぼかし‐ノイズ‐質感

- 　半径：ガウスフィルタに適用する半径ですが、ぼかしが有効になるのは半径が1.6以上の時だけです。⟨スコープ⟩の値をデフォルトから大きく下げ、且つ、輝度だけのモードを使うことで、色相に応じて違いを付けたぼかしを施せます。
- 　ノイズ：画像に輝度ノイズを加えることで質感を高めます。
- 　フィルム調の粒子
- 　粗さに関わる2つの設定が可能です：
  - 　配分（ISO）：ISO感度を変えた時の質感を真似ます。
  - 　ガンマ：効果の配分を変えます。値を高くすると変化が強まります。
- 　強さ：効果の強さを制御します。

##### メディアンフィルタ

- 　4種類、３x3、5x5、7x7、9x9、のウィンドウ（隣接ピクセルの集合）から選択できます。フィルタ適用の回数の選択は1回から4回です。このアルゴリズムはディテールタブのノイズ低減に使っているものと同じです。

##### ガイド付きフィルタ

- 　効果の強さを制御する3つのスライダーがあります：⟨ソフトな半径⟩、⟨強さ⟩、⟨ディテール⟩

　このぼかし&ノイズパネルの機能は、補正の難しい画像に関して、ディテールタブのノイズ低減と併用（特に、メディアンとガイド付きフィルタ）して使うことが出来ます。

### ノイズ除去

　例題が[ノイズ除去のモジュールを使うにあります](local_controls/jp#最初のステップ)。

　このパネルの機能は、ディテールタブの⟨ノイズ低減⟩とは異なる点が幾つかあります：

- 　輝度ノイズだけを処理の対象とした、"非局所平均フィルタ"を備えています。
- 　"平均値"としての基本的なウェーブレット関数を使っていますが、分解レベルの数を増やすために変更を加えてあります：
  - 　輝度ノイズの処理、特に画質が均一な部分（より多くの情報を必要とする）に差を付けるため、レベルの数を5から7に変えました。
  - 　色度のレベルの数は6から7へ変えました。
- 　また、ノイズ低減にはない機能も追加しました：
  - 　DCT（離散コサイン変換）アルゴリズムは色度の構成要素にも適用出来ます。
  - 　補正の匙加減が難しい画像に関して、他の機能にウェーブレットの作用を組み合わせることが出来ます。例えば、バイラテラルフィルタの様な働きをするガイド付きフィルタは、色の補正に効果があります。
- 　
  2つの拡張パネルの中の機能で、マスクに含まれる輝度の情報をベースに輝度ノイズを補正できます：
  - 　輝度マスクをベースにしたノイズ除去
  - 　輝度マスクをベースにした詳細復元

　次の様な使い方も出来ます：

1.  　ディテールタブの⟨ノイズ低減⟩機能の補助的役割：例えば、ノイズ低減で画像全体のノイズを控えめに軽減した後、更にローカル編集の⟨ノイズ除去⟩を使って目標とするノイズの軽減を続けます。
2.  　ローカル編集のモジュールが処理工程の半ばに位置していることを（ディテールタブのノイズ低減は処理工程の最初の方にあります）利用します。つまり、編集中の機能調整で発生したノイズを処理することが出来ます。編集の最後でRT-スポットを追加して、ノイズ除去機能を有効にして行います。

#### モード

　ノイズ除去には、"なし"、"控えめ"、"積極的"、"非局所平均フィルタだけ"、という４つのモードがあります。

- 　非局所平均フィルタだけ：これはパッチを使ったノイズ除去だけのモードです（ウェーブレットを使わない）。
- 　控えめと積極的なウェーブレット使うモードです。

　"
非局所平均フィルタだけ"モードを除いて、ウェーブレットを組み合わせて（輝度と色度）ことが出来ます。

#### 非局所平均フィルタ (パッチを使ったノイズ除去)

　パッチを使ったノイズ除去とは？通常、ノイズ低減は目標とするピクセルの"近傍のピクセルの平均"を使います。一方、非局所平均フィルタは画像全体のピクセルの平均を使い、目標ピクセルとの類似点をベースに加重平均を掛けてノイズを軽減します。こうすることで画像の特徴の維持（ディテールの損失を避ける）を図ります。５つのスライダーを使って制御します：

- 　強さ：作用の強さを調整します（値が０の時は作用しません）。
- 　詳細の復元：画質が均一な領域への作用と構造とディテール維持のためにラプラス変換を使います。
- 　ガンマ：値を低くするとディテールと構造の維持が図れます。高い値にするとノイズ除去の作用が強まります。
- 　"パッチの最大値"：ノイズを除去したい対象のサイズに合わせてノイズ除去を行います。
- 　"半径の最大値"：高い値にするとノイズ除去の作用が強まりますがその分処理時間が増えます。

#### ウェーブレットの活用

　ノイズ除去の機能には幾つか使い方があります。但し、結果確認のためには画像を100％に拡大する必要があります：

1.  　目標とする領域（例えば、色に応じて）だけでノイズ除去を実行し、その他の領域はそのままを維持するような調整が出来ます。
2.  　著しいプラスの露光補正を行った時、或いはシャドウ部分を明るくした時のノイズの増加を軽減します。
3.  　ボケの効果を真似るために、低い番手のレベル（0、1又は2）に対してガウスぼかしを施します。

- 　ウェーブレットを活用するためには、RT-スポットのサイズが128x128ピクセル以上であることが必要です。
- 　カーブの種類は少ないですが、その分適切なウェーブレットの分解レベルを選択し、精緻な結果を得るためのスライダーを増やしています。

##### 輝度ノイズ

　輝度ノイズ除去のモジュールは以下の機能を備えています：

- 　分解されたレベルに応じたノイズ除去の作用を調整するカーブがあります。Y軸はノイズ除去の強さ、X軸はウェーブレットの分解レベル（細かいディテールは、レベル0から2まで、レベル3以降はディテールが少なくなっていきます）を表します。
- 　徐々にディテールを復元させるためにDCT（離散コサイン変換）を使っています。スライダーの値が0の時はDTCの作用が最大なので、値が増えるにつれ作用が弱まりディテールが復元されます。
- 　⟨イコライザ
  白黒⟩：シャドウ或いはハイライトのノイズ軽減作用のバランスを変えるスライダーです。
- 　ガンマ：低い値の時は画像のディテールと構造が保持され、値が高くなるとノイズ軽減の作用が強まります。
- 　"ノイズ除去　色相イコライザ"：色相に応じたノイズ除去を行うカーブです。

##### 色ノイズ

- 　詳細レベル（ウェーブレット）の番手に応じて、色ノイズの除去の作用に差を付けることが出来ます。細かいレベルは、レベル0から３の色ノイズのことを指し、粗いレベルはレベル４以上の色ノイズを指します。
- 　色ノイズの除去にもDCT（離散コサイン変換）のスライダー、"色の詳細の回復"、があります。デフォルトは50で、100にすると機能が無効になります：
  - 　このアルゴリズムは色ノイズに関してフーリエ変換も使っています。スライダーの値が0の時は、DCTによる詳細回復効果が最小で、値を増やすに従ってディテールを復元します。
- 　色のイコライザ：色ノイズ軽減の働きを、ブルーからイエローの範囲の色、又はレッドからグリーンの範囲の色にバランスを傾ける機能です。

##### 2つの拡張パネル

###### 輝度マスクをベースにしたノイズ除去

　"マスクと修正"のL(L)、或いはLC(H)マスクの輝度の情報を使って、ノイズ除去カーブの作用を補助します。そのため、L(L)とLC(H)のマスクのどちらか、或いは両方が有効になっている必要があります。

- 　⟨暗い/明るい領域での補助⟩：明るい領域と暗い領域でノイズ除去のカーブの作用を補助します。

　⟨ 暗い/明るい領域での補助 ⟩に関係するスライダーが2つあります：

- 　⟨暗い領域の輝度のしきい値⟩：これは上記のスライダーの値が１より大きい場合、しきい値で設定された輝度値（デフォルトは12）を０％、マスクで示されている最も低い輝度値を100％として、ノイズ除去の作用を徐々に強めます。
- 　⟨明るい領域の輝度のしきい値⟩：しきい値で設定された輝度値（デフォルトは85）を100％、マスクで示されている最も高い輝度値を0％として、ノイズ除去の作用を徐々に減衰させます。
- 　2つのしきい値の間の輝度範囲では、ノイズ除去のカーブはマスクの影響を受けません。

###### 輝度マスクをベースにした詳細復元

　この機能も、"マスクと修正"のL(L)、或いはLC(H)マスクの輝度の情報を使います。従って、L(L)とLC(H)のマスクのどちらか、或いは両方が有効になっている必要があります。

- 　マスクの輝度が⟨暗い領域の輝度のしきい値⟩で設定されている値（デフォルトは12）より低い輝度領域では、ノイズ除去が徐々に適用されます。
- 　マスクの輝度が⟨明るい領域の輝度のしきい値⟩で設定されている値（デフォルトは85）より高い輝度領域では、ノイズ除去が徐々に適用されます。
- 　2つのしきい値の間の輝度領域では、⟨グレー領域の輝度ノイズ除去⟩、又は⟨グレー領域の色ノイズ除去⟩を調整しない限り、ノイズ除去を適用する前の画像が維持されます。　

##### その他の制御

- 　⟨スコープ⟩スライダーで、編集対象のΔE及びRT-スポットの諧調調整（境界値）に応じて、ノイズ除去の作用を変えることが出来ます。スコープ値や境界値の設定次第で、ΔEが100％考慮される領域では、ノイズ除去の効果が最大となり、ΔEによる形状検出が下がる領域ほど効果が減ります。
- 　 2つのどちらかの色度のスライダーを調整すると、彩度が若干上がります。

#### ぼかし＆ノイズを合わせた調整

　ノイズの状況によっては、背景をぼかして編集対象や前景との差を付ける方が仕上がりは良くなります。そのために、以下のフィルタを利用します。

- 　ガウスぼかし‐ノイズ‐質感
- 　メディアン
- 　バイラテラルフィルタに似た働きをするガイド付きフィルタ（特に、補色次元に作用）

#### バイラテラルフィルタ

　このバイラテラルフィルタは、ディテールタブに入っている⟨インパルスノイズ低減⟩のレプリカです。基本的には白黒画像によく見られるソルト＆ペッパーノイズの除去で使われることが多いフィルタですが、違うタイプのインパルスノイズ除去にも適用できます。

### 対数符号化

#### 対数符号化が解説されているリンク

　この機能の使用例がある項のリンク：

[対数符号化](local_controls/jp#対数符号化)

[対数符号化とハイライト復元](local_controls/jp#対数符号化とハイライト復元)

[対数符号化を使った他の例](local_controls/jp#対数符号化を使った他の例)

#### イントロダクション

　これはAlberto
Aggrigioが開発してARTに導入した優れた機能モジュールです。露光不足の画像やハイダイナミックレンジ画像を処理出来ます。画像データを自動制御で対数尺度に符号化するデータ圧縮です。

　RawTherapeeのRGB対数符号化モジュールは、ローカル編集や高度な機能タブで使われているCIECAMの特性を幾つか取り入れています。この機能による処理の最初のステップは、画像のダイナミックレンジを計算するために、画像のブラックEvとホワイトEvを決定することです。デフォルト値は15Ev（ホワイトEv＝＋10、ブラックEv＝‐5）、場面条件の平均輝度は10％です。このダイナミックレンジの計算は処理工程のアップストリームであるsRGBやProphoto
などへの変換直後の画像を使って行なわれるため、処理工程の中間にRGBで行う編集調整や、ローカル編集で行う編集調整の前の画像のダイナミックレンジということになります。

　スコープ機能が取り入れられているので、ΔEをベースに、作用が及ぶ編集部分を制御できます。

#### 相対的な露光水準

- 　自動ボタンを押すと、システムがブラックEvとホワイトEvを計算します。
- 　アルゴリズムはRT-スポットのサイズを考慮し、必要であれば高いコントラスト部分、又は暗い部分を他の部分と区別することが出来ます。RT-スポットの形状で"画像全体"を選択し、スコープを100に設定すれば、ARTの対数符号化と似たような結果が得られるでしょう。

　もちろん、ブラックEvとホワイトEvは手動で直接設定することも可能です。

　デフォルトでは"画像全体のブラックEvとホワイトEv"オプションが有効になっています。

- 　"画像全体のブラックEvとホワイトEv"オプションが無効で、RT-スポットのセンターポイントの位置が画像の明るい部分にある場合、場面条件の⟨平均輝度（Yb%）⟩が異常に高くなることがあります。こうした場合は：
  - 　センターポイントの位置を暗い部分に移動します。
  - 　手動で平均輝度（Yb%）の値を下げます。
  - 　オプションを有効にします。

#### 場面条件

　処理を進める前のグレーポイントを自動で考慮したい場合は、場面条件のパネルの中の"自動平均輝度（Y%）"を有効にしたままにします。この自動計算には2つのアルゴリズムが使われています。初めに使われるアルゴリズムが上手く機能していないと判断された場合は、Yb（平均輝度）をベースにした２番目のアルゴリズムが使われます。調整可能なパラメータが３つあります：

- 　⟨平均輝度（Yb％）⟩：Ybは背景の相対輝度で、グレーの%で表しています。18％グレーは背景輝度がL\*で言う50％であることと同等です。データは入力画像の平均輝度をベースにしています。
- 　⟨絶対輝度⟩：撮影が行われた時の輝度をカンデラ毎平方メートルで表した数値で、Exifデータから自動的に算出されます。
- 　"周囲環境"：場面の周囲環境を考慮して、画像のトーンと色を変えます：
  - 　平均：平均的（標準的）な光環境
  - 　薄暗い：周囲が少し暗い状況、画像が少し明るくなります。
  - 　暗い：周囲が暗い状況、画像が明るくなります。

#### CAM16による画像の調整機能

- 　⟨ローカルコントラスト⟩：主に高周波データに作用します。
- 　⟨コントラスト（J）⟩：相対輝度を使ったコントラストの調整です。
- 　⟨コントラストのしきい値（J＆Q）⟩：2つのコントラストJとQの中間コントラストの作用を調整します。
- 　⟨彩度⟩：主に中間トーンとハイライトの彩度に作用します。

　モジュールの機能水準を高度にすると、"全ての機能"というパネルが追加されます。拡張すると以下のスライダーが表示されます：

- 　⟨明度（J）⟩：相対輝度の調整
- 　⟨明るさ（Q）⟩：絶対輝度の調整
- 　⟨コントラスト（Q）⟩：絶対輝度をベースにしたコントラストの調整
- 　⟨色度（C）⟩：同じ光環境において、刺激値の明るさと比較した刺激値の色を調整
- 　⟨鮮やかさ（M）⟩：グレーと比べて感じる色合いを調整

#### 観視条件

- 　⟨平均輝度（Yb％）⟩：背景の相対輝度のこと。グレーの%で表しています。18％グレーは背景輝度がL\*で言う50％であることと同等です。データは目標とする出力画像の平均輝度をベースにしています。
- 　⟨絶対輝度⟩：出力を観視する際の絶対輝度（デフォルトは16カンデラ毎平方メートルです）。
- 　⟨色順応⟩：色順応は色を時空間に応じて捉える機能です。ホワイトバランスがD50光源のホワイトバランスから著しく離れている場合などに使うことが出来ます。出力媒体（モニター、印刷など）の明るさに対して色を順応させることが出来ます。
- 　⟨周囲環境⟩：出力を観視する際の周囲の環境を考慮してトーンと色を変更します：
  - 　平均：平均的（標準的）な光環境
  - 　薄暗い：周囲が少し暗い状況、画像が少し暗くなります。
  - 　暗い：周囲が暗い状況、画像が暗くなります。
  - 　非常に暗い：周囲が非常に暗い状況、画像が非常に暗くなります。

#### 諧調フィルタ

　対数符号化処理の最後に、輝度の結果を調整する"強さ"と"角度"の2つスライダーを持つ諧調フィルタがあります。

### 色の見え (Cam16 & JzCzHz)

　色の見えとHDR機能を使った例が、[HDRからSDRへの処理：初めてのアプローチ（対数符号化‐CAM16‐JzCzHz‐シグモイド）にあります](local_controls/jp)。

- 　このモジュールは高度な機能タブの⟨色の見え＆明るさ（CIECAM02/16）⟩機能を単純化したものです：
  - 　CAM02は使えません、CAM16だけです。
  - 　機能モードに"自動シンメトリック"と"混成"の選択はありません。従って、処理工程の最後での色順応の適用は出来ません。
  - 　"ホワイトポイントのモデル"と光源に選択肢はありません。
  - 　場面条件と観視条件の色順応変換はCAT16だけです。
  - 　観視条件で色温度/色偏差の調整は出来ません。
- 　機能水準（基本、標準、高度）によっては、高度な機能タブの色の見え＆明るさ（CIECAM02/16）にない機能もあります：
  - 　HDRのPQ（知覚量子化器）を考慮することが出来ます：HDR処理の初めての試みです。
  - 　ブラックEvとホワイトEvを考慮するシグモイドQと対数符号化Qという関数を組み入れました。
  - 　マスクも使えます。
  - 　機能水準を高度にすると、HDRの処理を改善した試験的なモジュール、JzCzHzが使えます。

　全体的には、高度な機能タブの⟨色の見え＆明るさ（CIECAM02/16）⟩を単純化したモジュールで（少なくともCAM16に関して）、使い方がより直観的に分かると思います。また、ローカル編集で使われる様々なパラメータ、ΔE、スコープ、変移の位置、などが考慮されています。

　CAM16の概要に関しては、[CAM16とHDR機能を使うを](local_controls/jp#cam16とhdr機能を使う)参考にして下さい。

　JzCzHzに関しては、[試験的なモジュール　JzCzHzを](local_controls/jp#試験的なモジュール_jzczhz)参考にして下さい。

　[色の見え＆明るさ（CIECAM02/16）と色の見え（CAM16＆JzCzHz） -
チュートリアルも](CIECAM02/jp#色の見え＆明るさ（CIECAM02/16）と色の見え（CAM16＆JzCzHz）_-_チュートリアル.md)参考にして下さい。因みに、JzCzHzのモジュールはL\*a\*b\*で使える全てを代替え出来る機能が備わっています：

- 　カーブ：Jz(Jz), Cz(Cz), Cz(Jz), Jz(Hz), Hz(Hz), Cz(Hz)
- 　シャドウ/ハイライト Jz
- 　ウェーブレット Jz
  - 　ローカルコントラスト
  - 　明瞭とシャープマスク
