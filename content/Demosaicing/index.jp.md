---
title: Demosaicing jp
contributors:
  - Yz2house
---

<div class="pagetitle">

デモザイク

</div>
![](Chipincamera.jpg "Chipincamera.jpg")
![](Bayer_pattern_on_sensor.svg "Bayer_pattern_on_sensor.svg")
![](Bayer_pattern_on_sensor_profile.svg "Bayer_pattern_on_sensor_profile.svg")

## イントロダクション

　カメラの殆どはセンセル、或いはフォトサイトと呼ばれる、同種の感光性を持つ何百万ものエレメントで構成されるセンサーを使用しています。色を捉えるため、その上に[カラーフィルター配列](https://en.wikipedia.org/wiki/Color_filter_array)（CFA）が置かれていて、特定のフォトサイトが特定の波長の光を記録します。最も一般的なCFAが“\[<https://ja.wikipedia.org/wiki/%E3%83%99%E3%82%A4%E3%83%A4%E3%83%BC%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%BC>　ベイヤーフィルター\]”と呼ばれる、グリーン、ブルー、レッドそしてグリーンというパッチを繰り返す2x2のマトリクスを使うもので、殆どのカメラがこの方式を採用しています。“[X-Trans](https://en.wikipedia.org/wiki/Fujifilm_X-Trans_sensor)”と呼ばれる配列もあり、富士フィルム製のカメラがこれを採用しています。こちらはパッチが6x6のマトリクスです。各フォトサイトは特定帯域の光を取り込むように作られていますが、対処しなければならない大きな問題が3つあります：

1.  各フォトサイトは、フィルターを通過してフォトサイトに到達したフォトンによって誘発される単一の電荷を記録するだけなので、そこには色の概念がありません、
2.  レッドやブルーのフォトサイトの数に比べてグリーンのフォトサイトの数が倍です、
3.  つまり各カラーチャンネルの、半分（グリーン）或いは3/4（レッド、ブルー）がデータ不足のままで（ブラック、未露光のフォトサイトがある。例えばレッドフルタ―が施されているフォトサイトは4つに1つしかないので）構成されていることになります。

　従って、ベイヤーやX-TransといったCFAのセンサーを使うカメラで撮った画像を適切に表示する処理は思うほど単純ではありません。これら不連続なデータポイントのモザイクを適切な画像に変換する必要があります。その処理のことをデモザイクといいます。

　RawTherapeeは複数のデモザイクアルゴリズムを持っていますが、各アルゴリズムにはそれぞれ特徴があります。それら違いは僅かなものなので、違いを確認するには画像を100％以上にして見る必要があります。しかし、デモザイク処理が行われた画像は、その後の調整全てを行うベースになるので、使用するデモザイクの選択は最終的な画像の仕上がりに大きく影響することがあります、特に近づいて観察するとそれが分かるでしょう。デモザイクの選択で違いが顕著になるのが、微細な部分の色表現と縞模様の様なアーティファクトです。

　ベイヤーフィルターを使うカメラに関して言えば、低ISO画像であれば、一般的にAMaZEというアルゴリズムが最も適していると言えます。高ISO画像の場合は、LMMSEやIGVの方がいいかもしれません。X-Transを使うカメラの場合は、3-パス（Markesteijn）が最も適したアルゴリズムでしょう。

　因みに、Foveon
X3というセンサーを使っているカメラにはカラーフィルターがないので、それで撮影された画像にデモザイク処理をする必要がありません。但し、それら画像は今のところRawTherapeeではサポートされていません。

<div align="center">

Image:Demosaicing city1 amaze.png\|AMaZE Image:Demosaicing city1
igv.png\|IGV Image:Demosaicing city1 lmmse.png\|LMMS Image:Demosaicing
city1 eahd.png\|EAHD Image:Demosaicing city1 hphd.png\|HPHD
Image:Demosaicing city1 vng4.png\|VNG4 Image:Demosaicing city1
dcb.png\|DCB Image:Demosaicing city1 ahd.png\|AHD Image:Demosaicing
city1 fast.png\|Fast Image:Demosaicing city1 none.png\|デモザイクなし

</div>

## デモザイクの方式

- 共通した方式
  Fast  
  単純なアルゴリズムで動作は非常に速いですが、デモザイク処理の質が低いので奨めません。

  Mono  
  モノクロームカメラを使っている、或いはカメラからカラーフィルターを取ってしまったユーザーには便利でしょう。

  なし  
  デモザイク処理は行われません。ファイルの診断などには有効でしょうが、現像には使わないものです。

<!-- -->

- ベイヤー配列を使っているカメラに使う方式
  AMaZE  
  AMaZE（Aliasing Minimization and Zipper
  Elimination）は、デフォルトで設定されているデモザイク処理で、殆どの場合、最良の結果をもたらすアルゴリズムです。RawTherapee2.4或いはそれ以前のバージョンの時はAMaZE
  がなかったので、オリンパス製カメラの場合に他のデモザイク方式では発生することのあったメイズパターンを排除できるVNG4方式がよく使われていましたが、AMaZEが登場（バージョン3.0以降）してからはオリンパス製カメラのユーザーもAMaZEを好むようです。

  RCD  
  RCD（Ratio Corrected
  Demozising；変成比補正デモザイク）は丸い輪郭に力を発揮します。例えば、星を写した天体写真などです。しかも、AMaZEと同じ程度に詳細部分を保てます。

  DCB  
  DCBもAMaZEと似たような結果を生みます。細部のデモザイク処理はAMaZEの方がDCBより多少勝っている場合が多いようですが、偽色の発生に関してはDCBの方がAMaZEに比べ少ないようです、特にローパスフィルターが備わっていないカメラでは効果が高いようです。

  LMMSEとIGV  
  LMMSEとIGVは、ノイズの多い画像に適したデモザイクです。メイズパターンの発生を避けながら、ノイズ低減を強く行っても画像の質感が失われることがありません。IGVはモアレの発生を抑えるのにも力を発揮します。

  AHD、 EAHD、HPHD  
  AHD (Adaptive Homogeneity-Directed)やEAHD(Horvath's AHD) 、HPHD
  (Heterogeneity-Projection Hard-Decision)
  は昔使われていたアルゴリズムで、全般的に動作が遅く、パフォーマンスも他の方法に比べて劣ります。

  VNG4  
  中判デジタルカメラに対称型広角レンズ（例、Schneider Digitr
  28mm或いは35㎜）を使った場合、画像にクロストークが入り易くなります、特にあおり撮影を行うとその傾向が強まります（レンズからの入光がローアングルなため、漏れた光がセンサーの隣接するピクセルに影響してしまう）、そのためAMaZEやDCBでは、クロストークによる影響で、グリーンチャンネルが乖離して、メイズアーティファクトを引き起こします。アダプターを使ってミラーレスカメラに広角レンズを使っても、クロストークが入ります。この様な画像の場合は、微細な部分の質が多少犠牲になりますが、VNG-4（Variable
  Number of
  Gradients）を使う方がいいでしょう。また、別な手段として、Rawタブの前処理の中の“[グリーン平衡化](preprocessing/jp#グリーン平衡化)”を使い、グリーンチャンネルの差異を取り除く方法もあります。

  ピクセルシフト  
  ペンタックスとソニーのカメラの中には、ピクセルシフトによる撮影をサポートしているものがあります。これはセンサーを時計回りに1ピクセルずつ動かして撮影し、その4枚分の画像を一つの大きなrawファイルに収める方式です。RawTherapeeは動きによる画像の振れの部分を覆い隠しながら4枚の画像を1枚の画像として処理することが出来ます。この処理方法により、ノイズを抑え、画像のシャープネスを向上させることが出来ます。

<!-- -->

- 富士フィルムのX-Trans方式
  3-Pass  
  富士フィルムのX-Transセンサーで撮影した画像のデに使います。画像に対し3回処理を繰り返し、シャープ感を高める効果をもたらしますが、効果が得られるのは低ISO画像だけです。動作は1-Passより遅くなります。

  1-Pass  
  これも富士フィルムのX-Transセンサーです。処理速度は3-Passより速いですが、その分画像の質が下がりますが、違いが目立つのは低ISO画像場合だけです。従って、動作速度を重視するなら、質の違いが出ない高ISO画像に使うといいでしょう。

## 最適なデモザイクアルゴリズムを選ぶ

　少なくとも画像を100％（1:1）に拡大して、全てのアルゴリズムを試し、自分にあったものを選ぶべきです。細部や細かい規則的な模様のあるシャープな画像、例えば、規則的な模様のある波打ったセーターの画像や（メイズパターン発生の有無の確認）、遠くのレンガ壁や道路標識の画像を（エイリアシング発生の有無の確認）使います。そして、それらを低ISOと高ISO撮影の両方の画像で確認します。また、これら確認にはご自身のカメラで撮った画像を使って下さい；ニコン製カメラのraw画像に最適なアルゴリズムが、オリンパス製カメラのraw画像に対しても最適であるとは限りません。[thumb\|仕上がりの良い画像で各デモザイクの結果を検証（拡大率800％）。その結果VNG4はペンタックスK10D
のrawファイルには適さないことが分かる。本来ないはずの白い斑点（標識の赤い線の部分など）
が発生しており、レンガ壁（右）の詳細が失われている。](image:demosaicing_city1_example_bad.jpg.md)

## モノクロームカメラ

　モノクロームカメラは全てのピクセルに同じ色のフィルターを使ったカメラで、つまり、白黒イメージが撮影されるので、デモザイクを必要としません。また、この様なカメラの一部は赤外線フィルターも持っておらず、独創的なモノクロ撮影を可能にしています。

　RawTherapeeはモノクロームカメラもサポートしますが、ユーザーインターフェイスはその仕様で作られていないので、モノクロームファイルを読み込んでも、カラーに関する機能は有効のままです（もっとも、それらを調整しても殆ど意味は有りませんが）。モノクロームカメラは特殊なカメラなため、私達の開発努力をその仕様作りのために注ぐことは出来ません。ですから、この種のファイルを入力した際に、カラーの調整機能が無効になる、といった利便性が無いことを御承知おき下さい。

　モノクロームファイルを扱う時には、更に幾つか留意点があります。モノクロームカメラには、Leica
Monochromの様に色を単一チャンネルで記録するものと、Phase One IQ260
Achromaticの様にRGBチャンネルで記録するものが混在します。単一チャンネルだけを記録する機種であれば、RawTherapeeはそれを認識し、デモザイク処理を実行せず（デモザイクセクションにある機能は有効になったままですが、何もしません）、他の操作にも支障はありません。しかし、ベイヤー配列を使うカメラの様にRGBチャンネルで記録する機種に関しては、デモザイク処理が実行され、カラーマトリクスが適用されてしまいます。従って、この様な機種の画像ファイルを扱う場合は、デモザイク処理で“Mono”というオプションを使って下さい。そして、カラーマネジメントの[入力プロファイルを](color_management/jp)“入力プロファイルなし”に変更して下さい。

## インターフェイス

　デモザイクの方式とそれに関連する設定は2つに分けられています。“ベイヤー配列のセンサー”と“X-Transセンサー”です。撮影に使われたカメラのフィルター配列のrawファイルに応じて、編集を行う際にその機能が表示されます。一方の機能を使った編集は、もう一方の設定には影響しません、つまりベイヤー配列の画像にはそれに則した設定しか使われず、X-Transセンサーの設定は使われません。その逆も同じです。

### 方式

　ベイヤー配列を使ったrawファイルのデモザイク処理には以下のアルゴリズムが使えます:

- AMaZE
- AMaZE+VNG4
- RCD
- RCD+VNG4
- DCB
- DCB+VNG4
- LMMSE
- IGV
- AHD
- EAHD
- HPHD
- VNG4
- Fast
- Mono
- ピクセルシフト
- None(デモザイクなし)

　X-Transフィルターを使ったrawファイルのデモザイク処理には以下のアルゴリズムが使えます：

- 3-Pass+fast
- 3-Pass(Markesteijn)
- 1-Pass+fast
- 1-Pass (Markesteijn)
- Fast
- Mono
- None(デモザイクなし)

#### デュアルデモザイク

　AMaZE+VNG4のようなデュアルデモザイク処理を行うと、コントラストの強い部分（例えば詳細部分）に一方のアルゴリズム、コントラストの弱い部分（例えば、詳細がない空のような滑らかな部分）にもう一方のアルゴリズムを使うことが出来ます。デモザイクのアルゴリズムには、細部のカラーレンダリングにより適しているものと、滑らかな均一部分のレンダリングに適しているものがあるので、デュアルデモザイク処理を使えば両アルゴリズムの得意とする性質を使うことが可能なので、他の機能による調整の起点として有利になり、シャープニングやノイズ低減の使用が少なくて済むでしょう。この方式のマイナス面は、デモザイク処理を2回行うので処理時間が長くなることです。

　1つのデモザイクアルゴリズムをもう1つのアルゴリズムに対して使用する詳細レベルの調整のためのしきい値は、“コントラストのしきい値”スライダーを使ってコントロールします。スライダーには最適なレベルを自動で計算するオプションのチェックボックスもあります。

### 境界

　デモザイク処理は、所与のピクセルの周辺ピクセルをサンプリングして行っている部分があります。しかし、例えばraw画像の最上部分のピクセルをデモザイク処理する時には、それより上に位置するピクセルがないので、サンプリングとして十分なピクセルが周辺にある部分と同じ質のデモザイク処理が行えません。従って、殆どのrawコンバーターが元画像の周辺を縦横で数ピクセルずつ切り取ることで対処しています。RawTherapeeもデフォルトではそのような設定になっています。しかし、この“境界”部分の切り取り設定値を書き換えることが出来ます。“0”に設定すると切り取りは行われず、アルゴリズムの能力範囲でその部分のデモザイク処理が行われますが、アーティファクトが発生するかもしれません。

　一般的にここの数値はデフォルトのままがいいでしょう。どうしても0にする必要がある場合、例えば1920x1080ピクセルを維持する必要のある1080pのraw
DNGフレームを処理する際などに、境界の設定を変更します。

### サブイメージ

　Rawファイルの中には1つ以上の画像を含むものがあります。この様なファイルの編集を行うと、サブイメージオプションが開くので、特定のサブイメージを編集する、或いはそのサブイメージを幾つかの方法で統合することも出来ます。

　富士フィルム製のEXRカメラの中には撮影時に“SNモード”が選択できるものがあります（SN比優先のことです）。この様な画像の編集を行おうとすると、サブイメージコンボボックスが開き、各サブイメージの平均ピクセルをブレンドし、ノイズを減らす効果をもたらす“SNモード”を選択することが出来ます。

### 偽色抑制処理の回数

　デモザイク処理の際にアーティファクトもデモザイク処理してしまうのを避けるために、中間フィルターを通す回数を設定します。デモザイク処理で高質な微細部分が決定されるところで、偽色（斑模様）が
発生する可能性があるからです。色のスムーズ化調整に似ていますが、この機能は輝度チャン
ネルには影響しません。

　一般的に、ローパスフィルターが備わっていないカメラは、それが備わっているカメラに比べ、偽色の発生が起こり易いと言えます。備考：偽色への対処の重要性に応じて、デモザイクアルゴリズムを選ぶことが決定的要素となるので、最も大切なことです。従って場合によっては、偽色抑制の回数を増やすより（解像度が犠牲になる）、アルゴリズムを変更する方が、結果が良くなる場合があります。
